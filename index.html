<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>箭头谱专业编辑器 v6.1 - 移动端优化版</title>
    <!-- 添加html2canvas库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', 'Microsoft YaHei', monospace;
            background: #e0e0e0;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* 定义标准单位宽度 - 支持动态间距调整 */
        :root {
            --unit-width: 50px;
            --half-unit: 10px;
            --quarter-unit: 4.5px;
            --arrow-size: 24px;
            --score-font-size: 17px;
            --note-gap: 0px;
            --global-spacing: 0px;
            --modifier-width: 8px;
            --modifier-gap: -5px;
            --modifier-font-size: 20px;
            --tie-line-height: 20px;
            --tie-line-offset: 12px;
            --dot-offset: 5px;
        }
        
        /* SVG箭头样式 */
        .arrow-svg {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .arrow-svg.small {
            width: 16px;
            height: 16px;
        }
        
        .arrow-svg.large {
            width: var(--arrow-size, 24px);
            height: var(--arrow-size, 24px);
        }
        
        /* 改进修饰符样式 - 更贴近箭头 */
        .modifier-svg {
            width: var(--modifier-width);
            height: var(--modifier-font-size);
            display: inline-block;
            vertical-align: middle;
            position: relative;
        }
        
        .modifier-svg.octave {
            top: -2px;
        }
        
        .modifier-svg.chromatic {
            top: 6px;
        }

        /* 左侧控制面板 - 缩小整体尺寸 */
        .control-panel {
            width: 240px;
            background: white;
            border-right: 2px solid #ddd;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 8px;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            position: relative;
            z-index: 100;
            font-size: 11px;
        }
        
        /* 浮动菜单按钮 - 始终可见 */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 1001;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #4a90e2;
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            align-items: center;
            justify-content: center;
        }
        
        .mobile-menu-btn:active {
            transform: scale(0.95);
        }
        
        .mobile-menu-btn.panel-open {
            background: #e74c3c;
            left: 240px;
        }
        
        /* 移动端面板遮罩层 */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .mobile-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* 手机端适配 */
        @media screen and (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .control-panel {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                max-width: 85vw;
                z-index: 1000;
                transform: translateX(-100%);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .control-panel.mobile-visible {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            }
            
            .mobile-overlay {
                display: block;
            }
            
            .resize-handle {
                display: none !important;
            }
            
            .editor-area {
                width: 100%;
                margin-left: 0;
            }
            
            .toolbar {
                padding: 0 10px 0 60px;
                flex-wrap: wrap;
                height: auto;
                min-height: 50px;
            }
            
            .toolbar input {
                width: 100px;
            }
            
            .toolbar-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .font-size-control {
                flex: 1 1 100%;
                margin-top: 10px;
            }
            
            .score-container {
                padding: 10px;
            }
            
            .score-page {
                width: calc(100vw - 20px);
                min-height: auto;
                max-height: none;
                padding: 10mm;
            }
        }
        
        /* 手机横屏优化 */
        @media screen and (orientation: landscape) and (max-width: 896px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                top: 55px;
                left: 5px;
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .mobile-menu-btn.panel-open {
                left: 205px;
            }
            
            .control-panel {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 240px;
                max-width: 50vw;
                font-size: 10px;
                padding: 6px;
                z-index: 1000;
                transform: translateX(-100%);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .control-panel.mobile-visible {
                transform: translateX(0);
            }
            
            .mobile-overlay {
                display: block;
            }
            
            .panel-section {
                padding: 4px;
            }
            
            .arrow-btn {
                height: 40px;
            }
            
            .editor-area {
                width: 100%;
                margin-left: 0;
            }
        }
        
        /* 面板关闭按钮 - 移动端内部 */
        .panel-close-btn {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            z-index: 101;
            transition: transform 0.2s;
        }
        
        .panel-close-btn:active {
            transform: scale(0.9);
        }
        
        @media screen and (max-width: 896px) {
            .panel-close-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
        
        /* 面板缩放控制按钮 */
        .panel-zoom-controls {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding: 4px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 8px;
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn {
            padding: 4px 8px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .zoom-btn:hover {
            background: #357abd;
        }
        
        .zoom-display {
            font-size: 11px;
            padding: 0 8px;
            min-width: 45px;
            text-align: center;
        }
        
        /* 可拖动分隔条样式 */
        .resize-handle {
            width: 5px;
            background: #999;
            cursor: col-resize;
            position: relative;
            transition: background 0.3s;
        }

        .resize-handle:hover {
            background: #4a90e2;
            width: 8px;
        }

        .resize-handle:active {
            background: #357abd;
        }
        
        .panel-section {
            padding: 6px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
            padding: 2px 6px;
            background: #f5f5f5;
            border-radius: 3px;
        }

        /* 双声部控制 */
        .voice-control {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }
        
        .voice-btn {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .voice-btn:hover {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        
        .voice-btn.active {
            background: #4caf50;
            color: white;
            border-color: #45a049;
        }
        
        /* 时值选择区 */
        .duration-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        
        .duration-btn {
            padding: 5px 2px;
            border: 2px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 10px;
        }
        
        .duration-btn:hover {
            background: #f0f8ff;
            border-color: #4a90e2;
        }
        
        .duration-btn.active {
            background: #4a90e2;
            color: white;
            border-color: #357abd;
        }
        
        .duration-display {
            font-size: 14px;
            margin-bottom: 2px;
        }

        /* 特殊时值选项 */
        .special-btn {
            padding: 5px 2px;
            border: 2px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
            text-align: center;
        }
        
        .special-btn:hover {
            background: #fce4ec;
            border-color: #e91e63;
        }
        
        .special-btn.active {
            background: #e91e63;
            color: white;
            border-color: #c2185b;
        }
        
        /* 三连音状态显示 */
        .triplet-status {
            margin-top: 4px;
            padding: 4px;
            background: #e8f5e9;
            border-radius: 3px;
            text-align: center;
            font-size: 10px;
            display: none;
        }
        
        .triplet-status.active {
            display: block;
        }
        
        /* 附点复选框 */
        .dot-checkbox {
            display: flex;
            align-items: center;
            margin-top: 4px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .dot-checkbox input {
            margin-right: 6px;
        }
        
        /* 变音符号选择区 - 保持2x4网格 */
        .modifier-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }
        
        .modifier-btn {
            padding: 4px;
            border: 2px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
            text-align: center;
        }
        
        .modifier-btn:hover {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .modifier-btn.active {
            background: #ff9800;
            color: white;
            border-color: #f57c00;
        }
        
        .modifier-example {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 1px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 20px;
        }

        /* 箭头音符区 */
        .arrow-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        
        .arrow-btn {
            height: 45px;
            border: 2px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .arrow-btn:hover {
            background: #e8f5e9;
            border-color: #4caf50;
            transform: scale(1.05);
        }
        
        .arrow-symbol {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .arrow-note {
            font-size: 9px;
            color: #666;
        }
        
        /* 减时线控制 */
        .beam-control {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .beam-btn {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
        }
        
        .beam-btn:hover {
            background: #f0f0f0;
        }
        
        .beam-btn.active {
            background: #2196f3;
            color: white;
        }
        
        #beamComplete {
            background: #4caf50;
            color: white;
            border-color: #45a049;
        }
        
        #beamComplete:hover {
            background: #45a049;
        }

        /* 光标控制按钮 */
        .cursor-control {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .cursor-btn {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .cursor-btn:hover {
            background: #ffebee;
            border-color: #f44336;
        }
        
        /* 间距调整控制 */
        .spacing-control {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .spacing-btn {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .spacing-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        /* 全局间距控制 - 新增 */
        .global-spacing-control {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            align-items: center;
        }
        
        .global-spacing-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .global-spacing-btn:hover {
            background: #e8eaf6;
            border-color: #673ab7;
        }
        
        .global-spacing-value {
            padding: 4px 8px;
            background: #f5f5f5;
            border-radius: 3px;
            font-size: 10px;
            min-width: 50px;
            text-align: center;
        }
        
        /* 行距调整控制 - 新增 */
        .line-spacing-control {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .line-spacing-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .line-spacing-btn:hover {
            background: #f3e5f5;
            border-color: #9c27b0;
        }
        
        .line-spacing-info {
            margin-top: 4px;
            padding: 4px;
            background: #f3e5f5;
            border-radius: 3px;
            text-align: center;
            font-size: 9px;
            color: #666;
        }
        
        /* 其他控制按钮 */
        .other-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }
        
        .other-btn {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
        }
        
        .other-btn:hover {
            background: #f0f0f0;
        }

        /* 右侧编辑区 */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* 工具栏 */
        .toolbar {
            height: 50px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .toolbar input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        .toolbar-btn:hover {
            background: #f0f0f0;
        }
        
        /* 导出按钮样式 */
        .export-btn {
            background: #4CAF50;
            color: white;
            border: 1px solid #45a049;
        }
        
        .export-btn:hover {
            background: #45a049;
        }
        
        /* 字体大小控制 */
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: auto;
        }
        
        .font-size-control label {
            font-size: 12px;
        }
        
        .font-size-control input {
            width: 80px;
        }
        
        /* 乐谱容器 */
        .score-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* A4纸张 */
        .score-page {
            width: 210mm;
            min-height: 297mm;
            max-height: 297mm;
            background: white;
            margin: 0 auto 20px;
            padding: 20mm;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .score-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 13px;
            color: #333;
        }
        
        /* 曲目信息区域 */
        .score-info {
            text-align: left;
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .score-info input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            color: #666;
            outline: none;
            border-bottom: 1px dashed #ddd;
        }
        
        .score-info input:focus {
            border-bottom: 1px solid #4a90e2;
        }
        
        .score-content {
            flex: 1;
        }
        
        .score-line {
            min-height: 60px;
            margin-bottom: 20px;
            margin-top: 0;
            padding: 10px;
            border: 2px dashed #e0e0e0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            gap: calc(var(--note-gap) + var(--global-spacing));
        }
        
        .score-line:hover {
            background: #fafafa;
        }
        
        .score-line.active {
            border-color: #4a90e2;
            background: #f0f8ff;
        }
        
        .score-line.selected-for-spacing {
            border-color: #9c27b0;
            background: #fce4ec;
            box-shadow: 0 0 8px rgba(156, 39, 176, 0.3);
        }

        /* 改进双声部行样式 */
        .score-line.two-voice {
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
            cursor: default;
        }
        
        .voice-line {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: calc(var(--note-gap) + var(--global-spacing));
            min-height: 40px;
            padding: 5px;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .voice-line.upper {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
        }
        
        .voice-line.lower {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .voice-line.active {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.6);
        }
        
        /* 核心对齐系统 - 修复音符组位置 */
        .note-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: var(--score-font-size, 24px);
            cursor: pointer;
            transition: all 0.2s;
            width: calc(var(--unit-width) + var(--global-spacing));
            text-align: center;
            font-family: 'Courier New', monospace;
            background: rgba(240, 240, 240, 0);
            border-radius: 6px;
            padding: 2px 0;
            border: 1px solid rgba(200, 200, 200, 0);
            box-shadow: 0 1px 3px rgba(0,0,0,0);
            vertical-align: middle;
            overflow: visible;
            position: relative;
        }
        
        /* 居中样式 */
        .score-line.centered {
            justify-content: center;
        }
        
        /* 增强选中状态的高亮效果 */
        .note-group.selected {
            background: rgba(66, 165, 245, 0.4);
            border: 2px solid rgba(66, 165, 245, 0.8);
            box-shadow: 0 0 10px rgba(66, 165, 245, 0.6), 
                        0 2px 8px rgba(66, 165, 245, 0.4);
            transform: scale(1.05);
            z-index: 10;
        }
        
        /* 鼠标悬停效果 */
        .note-group:hover {
            background: rgba(225, 225, 225, 0.9);
            border-color: rgba(150, 150, 150, 0.7);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        /* 改进音符内容布局 - 修饰符更贴近箭头 */
        .note-content {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            width: 100%;
            gap: var(--modifier-gap);
            vertical-align: middle;
        }

        .note-annotation {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: normal;
            color: #666;
        }
        
        /* 盒子标注 */
        .note-box {
            position: absolute;
            top: -7px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: normal;
            color: #666666;
            padding: 1px 3px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        /* 修饰符布局 - 位置调整更紧凑 */
        .note-modifier-left {
            position: absolute;
            left: calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap));
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .note-modifier-right {
            position: absolute;
            right: calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap));
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        /* 双符号的特殊样式 - 模仿混合修饰符的定位方式 */
        .note-modifier-double-left {
            display: inline-block;
            position: relative;
            margin-right: calc(var(--modifier-gap) * 0.6);
            vertical-align: middle;
        }
        
        .note-modifier-double-right {
            display: inline-block;
            position: relative;
            margin-left: calc(var(--modifier-gap) * 0.8);
            vertical-align: middle;
        }
        
        /* 混合修饰符样式 - 修复定位问题 */
        .note-modifier-mixed {
            display: inline-flex;
            align-items: center;
            position: relative;
            gap: calc(var(--modifier-gap) * 0.1);
        }

        .note-modifier-mixed .left-modifier {
            display: inline-flex;
            align-items: center;
            margin-right: calc(var(--modifier-gap) * 0.6); /* 减小间距，更贴近箭头 */
        }

        .note-modifier-mixed .right-modifier {
            display: inline-flex;
            align-items: center;
            margin-left: calc(var(--modifier-gap) * 0.6); /* 减小间距，更贴近箭头 */
        }
        
        .note-arrow {
            font-size: 1em;
            padding: 0;
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
        }

        /* 延长符号 - 新的SVG实现，支持垂直居中 */
        .note-extend {
            font-size: 0.9em;
            color: #000;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: calc(var(--unit-width) + var(--global-spacing));
            text-align: center;
            border-radius: 4px;
            vertical-align: middle;
            margin-top: 0px;
            padding: 2px 0;
        }
        
        /* 双声部垂直居中 */
        .voice-line .note-extend {
            align-self: center;
        }
        
        .note-extend svg {
            width: 40%;
            height: 24px;
        }
        
        /* 附点样式 - 在容器内部并向左偏移 */
        .note-dot {
            font-size: 0.8em;
            position: absolute;
            right: 5px;
            top: 52%;
            transform: translateY(-50%);
        }
        
        /* 连音线 */
        .tie-symbol {
            font-size: var(--score-font-size, 24px);
            width: calc(var(--unit-width) + var(--global-spacing));
            color: #666;
            position: relative;
            z-index: 2;
            text-align: center;
            display: inline-block;
        }
        
        /* 连音线SVG样式 */
        .tie-line-svg {
            pointer-events: none;
            z-index: 5;
        }
        
        /* 三连音组 */
        .triplet-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: calc(var(--unit-width) * 3 + var(--note-gap) * 2 + var(--global-spacing) * 3);
            border-radius: 8px;
            border: 0px solid rgba(230, 240, 255, 0.5);
            box-shadow: 0 1px 4px rgba(230, 240, 255, 0.5);
            padding: 0px;
            vertical-align: middle;
        }
        
        .triplet-bracket {
            position: absolute;
            top: -5px;
            width: 150%;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
        }
        
        .triplet-notes {
            display: flex;
            width: 100%;
            gap: calc(var(--note-gap) + var(--global-spacing));
        }
        
        .triplet-notes .note-group {
            flex: 1;
        }
        
        /* 减时线容器 */
        .beam-container {
            position: absolute;
            bottom: -9px;
            left: 0;
            width: 100%;
            height: 10px;
            pointer-events: none;
        }
        
        .beam-line {
            position: absolute;
            height: 2px;
            background: #333;
            width: 70%;
            left: 15%;
            bottom: 11px;
        }
        
        .beam-line.second {
            bottom: 7px;
            width: 70%;
            left: 15%;
        }
        
        /* 连接的减时线组 */
        .beam-group {
            display: inline-flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            width: auto;
            vertical-align: middle;
        }
        
        .beam-group .note-groups {
            display: flex;
            gap: calc(var(--note-gap) + var(--global-spacing));
            position: relative;
        }
        
        .beam-group .note-groups .note-group {
            width: calc(var(--unit-width) + var(--global-spacing));
            padding: 1;
        }
        
        /* 智能减时线容器 */
        .beam-group .smart-beams {
            position: absolute;
            bottom: -9px;
            left: 0;
            right: 0;
            height: 10px;
            pointer-events: none;
        }
        
        .beam-group .connected-beam {
            position: absolute;
            height: 2px;
            background: #333;
            width: 90%;
            left: 5%;
        }
        
        .beam-group .connected-beam.first {
            bottom: 11px;
        }
        
        .beam-group .connected-beam.second {
            bottom: 7px;
        }
        
        /* 空格符 - 调整为支持动态间距 */
        .spacer {
            display: inline-block;
            width: calc(var(--unit-width) + var(--global-spacing));
            height: 1px;
        }
        
        /* 小节线、终止线、反复记号等占用标准宽度 */
        .barline, .repeat-sign {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: calc(var(--unit-width) + var(--global-spacing));
            height: 30px;
            position: relative;
            z-index: 1;
            margin-top: 6px;
            vertical-align: middle;
        }
        
        .barline {
            background: linear-gradient(to right, transparent calc(50% - 1px), #333 calc(50% - 1px), #333 calc(50% + 1px), transparent calc(50% + 1px));
        }
        
        /* 终止线样式 */
        .double-barline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: calc(var(--unit-width) + var(--global-spacing));
            height: 30px;
            position: relative;
            z-index: 1;
            margin-top: 6px;
            background: linear-gradient(to right, 
                transparent calc(50% - 4px), 
                #333 calc(50% - 4px), 
                #333 calc(50% - 2px), 
                transparent calc(50% - 2px),
                transparent calc(50% + 2px),
                #333 calc(50% + 2px),
                #333 calc(50% + 4px),
                transparent calc(50% + 4px));
            vertical-align: middle;
        }
        
        /* 反复记号 */
        .repeat-sign {
            font-size: var(--score-font-size, 24px);
            font-weight: bold;
            text-align: center;
        }
        
        /* 休止符 - 支持垂直居中 */
        .rest {
            font-size: var(--score-font-size, 24px);
            color: #666;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: calc(var(--unit-width) + var(--global-spacing));
            text-align: center;
            border-radius: 4px;
            padding: 2px 0;
            position: relative;
            margin-top: 0px;
            vertical-align: middle;
        }
        
        /* 双声部垂直居中 */
        .voice-line .rest {
            align-self: center;
        }
        
        /* 光标 - 只使用红色光标 */
        .cursor {
            width: 3px;
            height: 40px;
            background: #ff4444;
            animation: blink 1s infinite;
            display: inline-block;
            vertical-align: middle;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        /* 预览 */
        .current-selection {
            font-size: 18px;
            font-weight: bold;
            padding: 6px;
            background: #e3f2fd;
            border-radius: 3px;
            margin: 4px;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 连音组状态提示 */
        .beam-status {
            margin-top: 4px;
            padding: 4px;
            background: #fff3e0;
            border-radius: 3px;
            text-align: center;
            font-size: 10px;
            display: none;
            color: #ff9800;
        }
        
        .beam-status.active {
            display: block;
        }
        
        /* 复制提示 */
        .copy-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }
        
        .copy-indicator.show {
            display: block;
            animation: fadeInOut 2s ease;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }
        
        /* 导出进度提示 */
        .export-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10000;
            display: none;
            text-align: center;
        }
        
        .export-progress.show {
            display: block;
        }
        
        .export-progress .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 页面指示器 - 隐藏以便打印时不显示 */
        .page-indicator {
            position: absolute;
            bottom: 10mm;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #999;
            text-align: center;
            width: auto;
            opacity: 0.5;
            display: none; /* 默认隐藏页面指示器 */
        }
        
        /* 响应式布局和打印样式保持原样 */
        @media print {
            /* 隐藏不需要打印的元素 */
            .control-panel,
            .toolbar,
            .resize-handle,
            .page-indicator,
            .cursor,
            .mobile-menu-btn,
            .mobile-overlay,
            .panel-close-btn {
                display: none !important;
            }
            
            /* 基础页面设置 */
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            
            .container {
                display: block;
            }
            
            .editor-area {
                width: 100%;
            }
            
            .score-container {
                padding: 0;
                background: white;
                display: block;
            }
            
            /* A4页面设置 - 关键部分 */
            .score-page {
                page-break-after: always;
                page-break-inside: avoid;
                width: 210mm;
                height: 297mm;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 20mm;
                display: block;
                position: relative;
            }
            
            /* 最后一页不强制分页 */
            .score-page:last-child {
                page-break-after: auto;
            }
            
            /* 第二页起隐藏标题和信息 */
            .score-page:not(:first-child) .score-title {
                display: none !important;
            }
            
            .score-page:not(:first-child) .score-info {
                display: none !important;
            }
            
            /* 第二页起内容上移填充空间 */
            .score-page:not(:first-child) .score-content {
                margin-top: -40px;
            }
            
            /* 乐谱行的打印样式 - 重要修复 */
            .score-line {
                min-height: 60px !important;
                margin-bottom: 20px !important;
                margin-top: 0 !important;
                padding: 10px !important;
                border: 1px solid #ccc !important;  /* 实线边框，更清晰 */
                border-radius: 3px !important;
                display: flex !important;
                align-items: flex-start !important;
                flex-wrap: wrap !important;
                position: relative !important;
                width: 100% !important;
                box-sizing: border-box !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                page-break-inside: avoid !important;
            }
            
            /* 双声部行样式 */
            .score-line.two-voice {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 5px !important;
            }
            
            .voice-line {
                display: flex !important;
                align-items: flex-start !important;
                flex-wrap: wrap !important;
                gap: calc(var(--note-gap) + var(--global-spacing)) !important;
                min-height: 40px !important;
                padding: 5px !important;
                border-radius: 3px !important;
                position: relative !important;
                border: 1px solid #ddd !important;
                print-color-adjust: exact !important;
            }
            
            .voice-line.upper {
                background: rgba(74, 144, 226, 0.05) !important;
                border-color: rgba(74, 144, 226, 0.3) !important;
            }
            
            .voice-line.lower {
                background: rgba(76, 175, 80, 0.05) !important;
                border-color: rgba(76, 175, 80, 0.3) !important;
            }
            
            /* 居中样式在打印时的处理 */
            .score-line.centered {
                justify-content: center;
                text-align: center;
            }

            .score-line.centered > * {
                margin-left: auto;
                margin-right: auto;
            }
            
            /* 确保所有音符和符号正确打印 */
            .note-group,
            .rest,
            .note-extend,
            .beam-group,
            .triplet-group,
            .barline,
            .double-barline,
            .repeat-sign,
            .tie-line-svg,
            .spacer,
            .note-annotation,
            .note-box {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                display: inline-flex !important;
                vertical-align: middle !important;
                page-break-inside: avoid !important;
            }
            
            /* 减时线样式 */
            .beam-container {
                position: absolute !important;
                bottom: -9px !important;
                left: 0 !important;
                width: 100% !important;
                height: 10px !important;
                pointer-events: none;
                print-color-adjust: exact;
            }
            
            .beam-line {
                position: absolute !important;
                height: 2px !important;
                background: #333 !important;
                width: 70% !important;
                left: 15% !important;
                bottom: 11px !important;
                print-color-adjust: exact;
            }
            
            .beam-line.second {
                bottom: 7px !important;
            }
            
            /* 连音组的减时线 */
            .beam-group .connected-beam {
                position: absolute !important;
                height: 2px !important;
                background: #333 !important;
                width: 90% !important;
                left: 5% !important;
                print-color-adjust: exact;
            }
            
            .beam-group .connected-beam.first {
                bottom: 11px !important;
            }
            
            .beam-group .connected-beam.second {
                bottom: 7px !important;
            }
            
            /* 小节线背景渐变 */
            .barline {
                background: linear-gradient(to right, 
                    transparent calc(50% - 1px), 
                    #333 calc(50% - 1px), 
                    #333 calc(50% + 1px), 
                    transparent calc(50% + 1px)) !important;
                print-color-adjust: exact;
            }
            
            /* 双小节线背景渐变 */
            .double-barline {
                background: linear-gradient(to right, 
                    transparent calc(50% - 4px), 
                    #333 calc(50% - 4px), 
                    #333 calc(50% - 2px), 
                    transparent calc(50% - 2px),
                    transparent calc(50% + 2px),
                    #333 calc(50% + 2px),
                    #333 calc(50% + 4px),
                    transparent calc(50% + 4px)) !important;
                print-color-adjust: exact;
            }
            
            /* SVG元素打印支持 */
            svg, use, path {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            /* 防止打印时元素选中状态的背景色 */
            .note-group.selected {
                background: transparent !important;
                border: 1px solid transparent !important;
                box-shadow: none !important;
                transform: none !important;
            }
            
            /* 防止打印时行选中状态的背景色 */
            .score-line.active,
            .score-line.selected-for-spacing {
                background: transparent !important;
                border-color: #ccc !important;
                box-shadow: none !important;
            }
        }

        /* 页面尺寸设置 */
        @page {
            size: A4;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobilePanel()">☰</button>
    
    <!-- 移动端遮罩层 -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobilePanel()"></div>
    
    <!-- SVG定义区 - 使用新的箭头图标 -->
    <svg style="display: none;">
        <defs>
            <!-- 修饰符号 -->
            <!-- 降半音符号 -->
            <symbol id="flat-modifier" viewBox="0 0 10 20">
                <rect x="1" y="9" width="8" height="2" fill="currentColor"/>
            </symbol>
            
            <!-- 升半音符号 -->
            <symbol id="sharp-modifier" viewBox="0 0 10 20">
                <rect x="1" y="9" width="8" height="2" fill="currentColor"/>
            </symbol>
            
            <!-- 八度线符号 -->
            <symbol id="octave-modifier" viewBox="0 0 10 20">
                <rect x="1" y="9" width="8" height="1.5" fill="currentColor"/>
            </symbol>
            
            <!-- 延长符号 ~ -->
            <symbol id="extend-symbol" viewBox="0 0 50 20">
                <path d="M5,10 Q15,5 25,10 T45,10" stroke="currentColor" stroke-width="2" fill="none"/>
            </symbol>
            
            <!-- 新的箭头符号 - 使用您提供的SVG -->
            <!-- 右箭头 → (mi) -->
            <symbol id="arrow-right" viewBox="0 0 1024 1024">
                <path d="M489.984 760.832l-231.936-231.936c-9.216-9.216-9.728-24.576 0-34.304l231.936-231.936c9.216-9.216 24.576-9.728 34.304 0l13.824 13.824c9.728 10.24 9.728 25.6-0.512 34.816L365.568 477.696h383.488c13.312 0 24.064 10.752 24.064 24.064v19.968c0 13.312-10.752 24.064-24.064 24.064H365.568l172.544 166.4c9.728 9.728 9.728 25.088 0.512 34.304l-13.824 13.824c-10.24 10.24-25.6 10.24-34.816 0.512z" fill="currentColor" transform="rotate(180 512 512)"/>
            </symbol>
            
            <!-- 右上箭头 ↗ (re) -->
            <symbol id="arrow-right-up" viewBox="0 0 1024 1024">
                <path d="M703.51845747 672.38313168c0.36203867 13.39543086-10.49912149 24.25659102-24.25659102 24.25659102l-19.55008829 0c-13.39543086 0.36203867-24.25659102-11.22319883-23.89455235-24.61862969l4.34446407-239.66960084-271.52900398 271.52900397c-9.41300547 9.41300547-24.61862969 9.41300547-34.03163516 0l-14.48154688-14.48154688c-9.41300547-9.41300547-9.41300547-24.61862969 0-34.03163516l271.1669653-271.1669653L351.97890699 388.18277419c-13.75746953 0.72407734-24.61862969-10.13708282-24.61862969-23.89455235l0-19.55008829c0-13.03339219 10.86116016-23.89455235 24.25659102-24.25659102l328.0070368 0c13.03339219 0 23.89455235 10.86116016 24.25659102 24.25659102l-0.36203867 327.64499813z" fill="currentColor" transform="rotate(180 512 512)"/>
            </symbol>
            
            <!-- 上箭头 ↑ (do) -->
            <symbol id="arrow-up" viewBox="0 0 1024 1024">
                <path d="M489.984 760.832l-231.936-231.936c-9.216-9.216-9.728-24.576 0-34.304l231.936-231.936c9.216-9.216 24.576-9.728 34.304 0l13.824 13.824c9.728 10.24 9.728 25.6-0.512 34.816L365.568 477.696h383.488c13.312 0 24.064 10.752 24.064 24.064v19.968c0 13.312-10.752 24.064-24.064 24.064H365.568l172.544 166.4c9.728 9.728 9.728 25.088 0.512 34.304l-13.824 13.824c-10.24 10.24-25.6 10.24-34.816 0.512z" fill="currentColor" transform="rotate(90 512 512)"/>
            </symbol>
            
            <!-- 右下箭头 ↘ (fa) -->
            <symbol id="arrow-right-down" viewBox="0 0 1024 1024">
                <path d="M703.51845747 672.38313168c0.36203867 13.39543086-10.49912149 24.25659102-24.25659102 24.25659102l-19.55008829 0c-13.39543086 0.36203867-24.25659102-11.22319883-23.89455235-24.61862969l4.34446407-239.66960084-271.52900398 271.52900397c-9.41300547 9.41300547-24.61862969 9.41300547-34.03163516 0l-14.48154688-14.48154688c-9.41300547-9.41300547-9.41300547-24.61862969 0-34.03163516l271.1669653-271.1669653L351.97890699 388.18277419c-13.75746953 0.72407734-24.61862969-10.13708282-24.61862969-23.89455235l0-19.55008829c0-13.03339219 10.86116016-23.89455235 24.25659102-24.25659102l328.0070368 0c13.03339219 0 23.89455235 10.86116016 24.25659102 24.25659102l-0.36203867 327.64499813z" fill="currentColor" transform="rotate(90 512 512)"/>
            </symbol>

            <!-- 下箭头 ↓ (sol) -->
            <symbol id="arrow-down" viewBox="0 0 1024 1024">
                <path d="M489.984 760.832l-231.936-231.936c-9.216-9.216-9.728-24.576 0-34.304l231.936-231.936c9.216-9.216 24.576-9.728 34.304 0l13.824 13.824c9.728 10.24 9.728 25.6-0.512 34.816L365.568 477.696h383.488c13.312 0 24.064 10.752 24.064 24.064v19.968c0 13.312-10.752 24.064-24.064 24.064H365.568l172.544 166.4c9.728 9.728 9.728 25.088 0.512 34.304l-13.824 13.824c-10.24 10.24-25.6 10.24-34.816 0.512z" fill="currentColor" transform="rotate(-90 512 512)"/>
            </symbol>
            
            <!-- 左下箭头 ↙ (la) -->
            <symbol id="arrow-left-down" viewBox="0 0 1024 1024">
                <path d="M703.51845747 672.38313168c0.36203867 13.39543086-10.49912149 24.25659102-24.25659102 24.25659102l-19.55008829 0c-13.39543086 0.36203867-24.25659102-11.22319883-23.89455235-24.61862969l4.34446407-239.66960084-271.52900398 271.52900397c-9.41300547 9.41300547-24.61862969 9.41300547-34.03163516 0l-14.48154688-14.48154688c-9.41300547-9.41300547-9.41300547-24.61862969 0-34.03163516l271.1669653-271.1669653L351.97890699 388.18277419c-13.75746953 0.72407734-24.61862969-10.13708282-24.61862969-23.89455235l0-19.55008829c0-13.03339219 10.86116016-23.89455235 24.25659102-24.25659102l328.0070368 0c13.03339219 0 23.89455235 10.86116016 24.25659102 24.25659102l-0.36203867 327.64499813z" fill="currentColor"/>
            </symbol>
            
            <!-- 左箭头 ← (si) -->
            <symbol id="arrow-left" viewBox="0 0 1024 1024">
                <path d="M489.984 760.832l-231.936-231.936c-9.216-9.216-9.728-24.576 0-34.304l231.936-231.936c9.216-9.216 24.576-9.728 34.304 0l13.824 13.824c9.728 10.24 9.728 25.6-0.512 34.816L365.568 477.696h383.488c13.312 0 24.064 10.752 24.064 24.064v19.968c0 13.312-10.752 24.064-24.064 24.064H365.568l172.544 166.4c9.728 9.728 9.728 25.088 0.512 34.304l-13.824 13.824c-10.24 10.24-25.6 10.24-34.816 0.512z" fill="currentColor"/>
            </symbol>
            
            <!-- 左上箭头 ↖ (高do) -->
            <symbol id="arrow-left-up" viewBox="0 0 1024 1024">
                <path d="M703.51845747 672.38313168c0.36203867 13.39543086-10.49912149 24.25659102-24.25659102 24.25659102l-19.55008829 0c-13.39543086 0.36203867-24.25659102-11.22319883-23.89455235-24.61862969l4.34446407-239.66960084-271.52900398 271.52900397c-9.41300547 9.41300547-24.61862969 9.41300547-34.03163516 0l-14.48154688-14.48154688c-9.41300547-9.41300547-9.41300547-24.61862969 0-34.03163516l271.1669653-271.1669653L351.97890699 388.18277419c-13.75746953 0.72407734-24.61862969-10.13708282-24.61862969-23.89455235l0-19.55008829c0-13.03339219 10.86116016-23.89455235 24.25659102-24.25659102l328.0070368 0c13.03339219 0 23.89455235 10.86116016 24.25659102 24.25659102l-0.36203867 327.64499813z" fill="currentColor" transform="rotate(-90 512 512)"/>
            </symbol>
        </defs>
    </svg>
    
    <!-- 复制提示 -->
    <div class="copy-indicator" id="copyIndicator">已复制音符</div>
    
    <!-- 导出进度提示 -->
    <div class="export-progress" id="exportProgress">
        <div>正在生成图片...</div>
        <div class="spinner"></div>
        <div id="exportProgressText">准备中...</div>
    </div>

    <div class="container">
        <!-- 左侧控制面板 -->
        <div class="control-panel" id="controlPanel">
            <!-- 面板关闭按钮 - 移动端可见 -->
            <button class="panel-close-btn" onclick="closeMobilePanel()">×</button>
            
            <!-- 面板缩放控制 -->
            <div class="panel-zoom-controls">
                <button class="zoom-btn" onclick="adjustPanelZoom(-10)">-</button>
                <span class="zoom-display" id="panelZoomDisplay">100%</span>
                <button class="zoom-btn" onclick="adjustPanelZoom(10)">+</button>
            </div>
            
            <!-- 当前选择预览 -->
            <div class="panel-section">
                <div class="section-title">当前选择预览</div>
                <div class="current-selection" id="currentPreview">请选择音符</div>
            </div>
            
            <!-- 双声部控制 -->
            <div class="panel-section">
                <div class="section-title">🎼 声部设置</div>
                <div class="voice-control">
                    <button class="voice-btn active" id="singleVoice">单声部</button>
                    <button class="voice-btn" id="twoVoice">双声部</button>
                </div>
                <div class="voice-control" id="voiceSelector" style="display:none;">
                    <button class="voice-btn active" id="upperVoice">上声部</button>
                    <button class="voice-btn" id="lowerVoice">下声部</button>
                </div>
            </div>
            
            <!-- 时值选择 -->
            <div class="panel-section">
                <div class="section-title">1️⃣ 时值选择</div>
                <div class="duration-grid">
                    <button class="duration-btn active" data-duration="quarter">
                        <div class="duration-display">♩</div>
                        <div>标准 (W)</div>
                    </button>
                    <button class="duration-btn" data-duration="eighth">
                        <div class="duration-display">♪</div>
                        <div>八分 (S)</div>
                    </button>
                    <button class="duration-btn" data-duration="sixteenth">
                        <div class="duration-display">♬</div>
                        <div>十六分 (X)</div>
                    </button>
                    <button class="duration-btn special-btn" data-duration="extend">
                        <div class="duration-display">~</div>
                        <div>延长 (9)</div>
                    </button>
                    <button class="duration-btn special-btn" id="tripletBtn" data-duration="triplet">
                        <div class="duration-display">╭ 3 ╮</div>
                        <div>三连音</div>
                    </button>
                </div>
                
                <div class="triplet-status" id="tripletStatus">
                    三连音模式: <span id="tripletCount">0</span>/3
                </div>
                
                <div class="dot-checkbox">
                    <input type="checkbox" id="dotted" onchange="updateDotted()">
                    <label for="dotted">附点（.）延长一半时值</label>
                </div>
                
                <div class="beam-control">
                    <button class="beam-btn" id="beamConnect">智能连接 (F)</button>
                    <button class="beam-btn active" id="beamSeparate">断开减时线 (G)</button>
                </div>
                
                <div class="beam-status" id="beamStatus">
                    连音组: <span id="beamCount">0</span>个音符
                </div>
                
                <!-- 光标移动提示 -->
                <div style="margin-top: 4px; padding: 4px; background: #f5f5f5; border-radius: 3px; text-align: center; font-size: 10px;">
                    使用方向键 ↑↓←→ 移动光标
                </div>
                
                <!-- 间距调整控制 -->
                <div class="spacing-control">
                    <button class="spacing-btn" onclick="adjustSelectedSpacing(-1)">← 缩进</button>
                    <button class="spacing-btn" onclick="adjustSelectedSpacing(1)">扩展 →</button>
                </div>
                
                <!-- 全局间距调整 - 新增 -->
                <div class="global-spacing-control">
                    <button class="global-spacing-btn" onclick="adjustGlobalSpacing(-2)">紧缩</button>
                    <span class="global-spacing-value" id="globalSpacingValue">0px</span>
                    <button class="global-spacing-btn" onclick="adjustGlobalSpacing(2)">扩展</button>
                </div>
                
                <!-- 行距调整控制 - 新增 -->
                <div class="line-spacing-control">
                    <button class="line-spacing-btn" onclick="adjustLineSpacing(-5)">↑ 减小行距</button>
                    <button class="line-spacing-btn" onclick="adjustLineSpacing(5)">↓ 增加行距</button>
                </div>
                <div class="line-spacing-info">
                    先点击选中一行，然后调整行距
                </div>
            </div>
            
            <!-- 变音选择 - 保持2x4网格 -->
            <div class="panel-section">
                <div class="section-title">2️⃣ 变音选择（可选）</div>
                <div class="modifier-grid">
                    <button class="modifier-btn" data-modifier="octave-down">
                        <div class="modifier-example">
                            <svg class="modifier-svg octave"><use href="#octave-modifier"/></svg><svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>降八度 (Q)</div>
                    </button>
                    <button class="modifier-btn" data-modifier="octave-up">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg>
                        </div>
                        <div>升八度 (E)</div>
                    </button>
                    <button class="modifier-btn" data-modifier="flat">
                        <div class="modifier-example">
                            <svg class="modifier-svg chromatic"><use href="#flat-modifier"/></svg><svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>降半音 (A)</div>
                    </button>
                    <button class="modifier-btn" data-modifier="sharp">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg><svg class="modifier-svg chromatic"><use href="#sharp-modifier"/></svg>
                        </div>
                        <div>升半音 (D)</div>
                    </button>
                    <button class="modifier-btn" data-modifier="flat-octave-down">
                        <div class="modifier-example">
                            <span style="position:relative;">
                                <svg class="modifier-svg octave" style="position:absolute;left:-6px;top:-6px;"><use href="#octave-modifier"/></svg>
                                <svg class="modifier-svg chromatic" style="position:absolute;left:-6px;top:2px;"><use href="#flat-modifier"/></svg>
                                <svg class="arrow-svg small" style="margin-left:6px;"><use href="#arrow-up"/></svg>
                            </span>
                        </div>
                        <div>降八降半 Q+A</div>
                    </button>
                    <button class="modifier-btn" data-modifier="sharp-octave-up">
                        <div class="modifier-example">
                            <span style="position:relative;">
                                <svg class="arrow-svg small" style="margin-right:6px;"><use href="#arrow-up"/></svg>
                                <svg class="modifier-svg octave" style="position:absolute;right:-6px;top:-6px;"><use href="#octave-modifier"/></svg>
                                <svg class="modifier-svg chromatic" style="position:absolute;right:-6px;top:2px;"><use href="#sharp-modifier"/></svg>
                            </span>
                        </div>
                        <div>升八升半 E+D</div>
                    </button>
                    <button class="modifier-btn" data-modifier="sharp-octave-down">
                        <div class="modifier-example">
                            <span style="position:relative;">
                                <svg class="modifier-svg octave" style="position:absolute;left:-6px;top:-6px;"><use href="#octave-modifier"/></svg>
                                <svg class="arrow-svg small" style="margin:0 6px;"><use href="#arrow-up"/></svg>
                                <svg class="modifier-svg chromatic" style="position:absolute;right:-6px;top:2px;"><use href="#sharp-modifier"/></svg>
                            </span>
                        </div>
                        <div>降八升半 Q+D</div>
                    </button>
                    <button class="modifier-btn" data-modifier="flat-octave-up">
                        <div class="modifier-example">
                            <span style="position:relative;">
                                <svg class="modifier-svg chromatic" style="position:absolute;left:-6px;top:2px;"><use href="#flat-modifier"/></svg>
                                <svg class="arrow-svg small" style="margin:0 6px;"><use href="#arrow-up"/></svg>
                                <svg class="modifier-svg octave" style="position:absolute;right:-6px;top:-6px;"><use href="#octave-modifier"/></svg>
                            </span>
                        </div>
                        <div>降半升八 A+E</div>
                    </button>
                </div>
            </div>

            <!-- 音符选择 -->
            <div class="panel-section">
                <div class="section-title">3️⃣ 音符选择（点击输入）</div>
                <div class="arrow-grid">
                    <button class="arrow-btn" data-arrow="up" data-note="1" data-svg="arrow-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-up"/></svg>
                        </span>
                        <span class="arrow-note">1 do</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right-up" data-note="6" data-svg="arrow-right-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right-up"/></svg>
                        </span>
                        <span class="arrow-note">6 la</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right" data-note="3" data-svg="arrow-right">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right"/></svg>
                        </span>
                        <span class="arrow-note">3 mi</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right-down" data-note="4" data-svg="arrow-right-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right-down"/></svg>
                        </span>
                        <span class="arrow-note">4 fa</span>
                    </button>
                    <button class="arrow-btn" data-arrow="down" data-note="5" data-svg="arrow-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-down"/></svg>
                        </span>
                        <span class="arrow-note">5 sol</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left-down" data-note="2" data-svg="arrow-left-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left-down"/></svg>
                        </span>
                        <span class="arrow-note">2 re</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left" data-note="7" data-svg="arrow-left">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left"/></svg>
                        </span>
                        <span class="arrow-note">7 si</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left-up" data-note="1'" data-svg="arrow-left-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left-up"/></svg>
                        </span>
                        <span class="arrow-note">8 高do</span>
                    </button>
                    <button class="arrow-btn" data-arrow="0" data-note="0">
                        <span class="arrow-symbol">0</span>
                        <span class="arrow-note">0 休止</span>
                    </button>
                </div>
            </div>

            <!-- 其他功能 -->
            <div class="panel-section">
                <div class="section-title">其他功能</div>
                <div class="other-controls">
                    <button class="other-btn" onclick="copySelected()">复制 (Ctrl+C)</button>
                    <button class="other-btn" onclick="pasteAtCursor()">粘贴 (Ctrl+V)</button>
                    <button class="other-btn" onclick="insertTie()">⌒ 连音线模式</button>
                    <button class="other-btn" onclick="insertSpacer()">⎵ 空格</button>
                    <button class="other-btn" onclick="centerLine()">⊡ 居中对齐</button>
                    <button class="other-btn" onclick="insertAnnotation('R')">R 标注</button>
                    <button class="other-btn" onclick="insertAnnotation('L')">L 标注</button>
                    <button class="other-btn" onclick="insertBox('盒 1')">盒 1 标注</button>
                    <button class="other-btn" onclick="insertBox('盒 2')">盒 2 标注</button>
                    <button class="other-btn" onclick="insertBarline()">| 小节线 (R)</button>
                    <button class="other-btn" onclick="insertDoubleBar()">|| 终止线</button>
                    <button class="other-btn" onclick="insertRepeat(':|')">:| 前反复</button>
                    <button class="other-btn" onclick="insertRepeat('|:')">|: 后反复</button>
                    <button class="other-btn" onclick="deleteLast()">删除 (Backspace)</button>
                    <button class="other-btn" onclick="clearLine()">清空行</button>
                    <button class="other-btn" onclick="deleteLine()">删除行 (Shift+Backspace)</button>
                    <button class="other-btn" onclick="newLine()">新行 (Enter)</button>
                    <button class="other-btn" onclick="newPage()">新页</button>
                    <button class="other-btn" onclick="deletePage()">删除页</button>
                </div>
            </div>
        </div>

        <!-- 可拖动分隔条 -->
        <div class="resize-handle" id="resizeHandle"></div>
        
        <!-- 右侧编辑区 -->
        <div class="editor-area">
            <!-- 工具栏 -->
            <div class="toolbar">
                <input type="text" id="title" placeholder="输入曲名" oninput="updateTitle()">
                <select id="tempo">
                    <option value="60">♩=60</option>
                    <option value="80">♩=80</option>
                    <option value="100">♩=100</option>
                    <option value="120" selected>♩=120</option>
                    <option value="140">♩=140</option>
                </select>
                <button class="toolbar-btn" onclick="saveScore()">保存</button>
                <button class="toolbar-btn" onclick="loadScore()">加载</button>
                <button class="toolbar-btn" onclick="exportScore()">导出</button>
                <button class="toolbar-btn" onclick="importScore()">导入</button>
                <button class="toolbar-btn export-btn" onclick="exportAsImage()">📷 导出图片</button>
                <button class="toolbar-btn export-btn" onclick="exportAsPDF()" style="background: #ff9800;">📄 导出PDF</button>
                <button class="toolbar-btn" onclick="printScore()">打印</button>
                
                <div class="font-size-control">
                    <label>字体大小:</label>
                    <input type="range" id="fontSize" min="16" max="40" value="24" oninput="updateFontSize(this.value)">
                    <span id="fontSizeValue">24px</span>
                </div>
            </div>
            
            <!-- 乐谱编辑区 -->
            <div class="score-container" id="scoreContainer">
                <div class="score-page" id="page-1" data-page="1">
                    <h1 class="score-title" id="scoreTitle">未命名乐谱</h1>
                    <div class="score-info">
                        <input type="text" id="scoreInfo" placeholder="调号：C大调  拍号：4/4  速度：Andante" />
                    </div>
                    <div class="score-content">
                        <div id="scoreLines">
                            <div class="score-line active" data-line="1" data-page="1">
                                <div class="cursor"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局状态
        let currentDuration = 'quarter';
        let currentModifier = 'none';
        let isDotted = false;
        let beamMode = 'separate';
        let smartBeamMode = false;
        let smartBeamCounter = 0;
        let currentLine = 1;
        let currentPage = 1;
        let beamGroup = [];
        let fontSize = 24;
        let lastNote = null;
        let isTripletMode = false;
        let tripletGroup = [];
        let pendingAnnotation = null;
        let pendingBox = null;
        let selectedNote = null;
        let tieMode = false;
        let firstTieNote = null;
        let tieLinesData = [];
        let panelZoom = 100;
        let currentVoiceMode = 'single';
        let currentVoice = 'upper';
        let clipboard = null;
        let currentInsertPosition = null;
        let modifierKeys = {
            q: false,
            e: false,
            a: false,
            d: false
        };
        let selectedLineForSpacing = null;
        let globalSpacing = 0;
        let lastDuration = 'quarter';
        
        // 箭头SVG映射
        const arrowSvgMap = {
            'right': 'arrow-right',
            'right-up': 'arrow-right-up',
            'up': 'arrow-up',
            'right-down': 'arrow-right-down',
            'down': 'arrow-down',
            'left-down': 'arrow-left-down',
            'left': 'arrow-left',
            'left-up': 'arrow-left-up'
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initDurationButtons();
            initModifierButtons();
            initArrowButtons();
            initBeamControl();
            initVoiceControl();
            initKeyboardShortcuts();
            initLineClickHandlers();
            initNoteSelection();
            initResizeHandle();
            initTouchSupport();
            initBackgroundClick();
            initCopyPaste();
            updatePreview();
            updateUnitWidth(46);
        });

        // 移动端面板控制
        function toggleMobilePanel() {
            const panel = document.getElementById('controlPanel');
            const overlay = document.getElementById('mobileOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            if (panel.classList.contains('mobile-visible')) {
                closeMobilePanel();
            } else {
                panel.classList.add('mobile-visible');
                overlay.classList.add('active');
                menuBtn.classList.add('panel-open');
                menuBtn.innerHTML = '×';
            }
        }
        
        function closeMobilePanel() {
            const panel = document.getElementById('controlPanel');
            const overlay = document.getElementById('mobileOverlay');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            panel.classList.remove('mobile-visible');
            overlay.classList.remove('active');
            menuBtn.classList.remove('panel-open');
            menuBtn.innerHTML = '☰';
        }

        // 导出为图片的函数 - 改进版，处理SVG和特殊样式
        async function exportAsImage() {
            const progress = document.getElementById('exportProgress');
            const progressText = document.getElementById('exportProgressText');
            
            try {
                progress.classList.add('show');
                progressText.textContent = '准备中...';
                
                // 保存原始状态
                const originalStates = [];
                
                // 隐藏不需要的元素并保存状态
                document.querySelectorAll('.cursor').forEach(c => {
                    originalStates.push({element: c, display: c.style.display});
                    c.style.display = 'none';
                });
                document.querySelectorAll('.note-group.selected').forEach(n => {
                    originalStates.push({element: n, classes: [...n.classList]});
                    n.classList.remove('selected');
                });
                document.querySelectorAll('.score-line.active').forEach(l => {
                    originalStates.push({element: l, classes: [...l.classList]});
                    l.classList.remove('active');
                });
                document.querySelectorAll('.score-line.selected-for-spacing').forEach(l => {
                    originalStates.push({element: l, classes: [...l.classList]});
                    l.classList.remove('selected-for-spacing');
                });
                
                // 临时应用打印样式，确保边框和背景显示
                document.querySelectorAll('.score-line').forEach(line => {
                    line.style.border = '1px solid #ccc';
                    line.style.backgroundColor = 'transparent';
                });
                
                // 确保所有SVG都有正确的尺寸
                document.querySelectorAll('svg').forEach(svg => {
                    if (svg.classList.contains('arrow-svg')) {
                        svg.style.width = getComputedStyle(svg).width;
                        svg.style.height = getComputedStyle(svg).height;
                    }
                });
                
                const pages = document.querySelectorAll('.score-page');
                const title = document.getElementById('title').value || '未命名乐谱';
                
                for (let i = 0; i < pages.length; i++) {
                    progressText.textContent = `正在处理第 ${i + 1}/${pages.length} 页...`;
                    
                    const page = pages[i];
                    
                    // 临时克隆页面以避免影响原始页面
                    const clonedPage = page.cloneNode(true);
                    
                    // 处理克隆页面中的SVG - 转换为内联样式
                    clonedPage.querySelectorAll('svg').forEach(svg => {
                        const computedStyle = window.getComputedStyle(svg);
                        svg.style.width = computedStyle.width;
                        svg.style.height = computedStyle.height;
                        svg.style.display = computedStyle.display;
                    });
                    
                    // 处理CSS变量 - 将CSS变量转换为实际值
                    clonedPage.querySelectorAll('.note-group, .spacer, .barline, .double-barline, .rest, .note-extend').forEach(elem => {
                        const computedStyle = window.getComputedStyle(elem);
                        elem.style.width = computedStyle.width;
                        elem.style.fontSize = computedStyle.fontSize;
                    });
                    
                    // 处理减时线的背景渐变
                    clonedPage.querySelectorAll('.barline').forEach(bar => {
                        const bg = window.getComputedStyle(bar).background;
                        bar.style.background = bg;
                    });
                    
                    clonedPage.querySelectorAll('.double-barline').forEach(bar => {
                        const bg = window.getComputedStyle(bar).background;
                        bar.style.background = bg;
                    });
                    
                    // 临时添加到DOM以便html2canvas能正确读取
                    clonedPage.style.position = 'absolute';
                    clonedPage.style.left = '-9999px';
                    clonedPage.style.top = '0';
                    document.body.appendChild(clonedPage);
                    
                    // 使用改进的配置
                    const canvas = await html2canvas(clonedPage, {
                        scale: 3, // 提高分辨率
                        backgroundColor: '#ffffff',
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        foreignObjectRendering: true, // 尝试使用foreignObject渲染SVG
                        imageTimeout: 15000,
                        onclone: function(clonedDoc, element) {
                            // 在克隆的文档中进一步处理样式
                            element.querySelectorAll('.score-line').forEach(line => {
                                line.style.border = '1px solid #ccc';
                                line.style.borderRadius = '3px';
                            });
                            
                            // 确保字体正确
                            element.style.fontFamily = "'Courier New', 'Microsoft YaHei', monospace";
                        }
                    });
                    
                    // 移除克隆的页面
                    document.body.removeChild(clonedPage);
                    
                    // 转换为blob并下载
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = pages.length > 1 ? 
                            `${title}_第${i + 1}页.png` : 
                            `${title}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }, 'image/png', 0.95); // 设置图片质量
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // 恢复原始状态
                originalStates.forEach(state => {
                    if (state.display !== undefined) {
                        state.element.style.display = state.display;
                    }
                    if (state.classes) {
                        state.element.className = '';
                        state.classes.forEach(c => state.element.classList.add(c));
                    }
                });
                
                // 恢复乐谱行样式
                document.querySelectorAll('.score-line').forEach(line => {
                    line.style.border = '';
                    line.style.backgroundColor = '';
                });
                
                progressText.textContent = '导出完成！';
                setTimeout(() => {
                    progress.classList.remove('show');
                }, 2000);
                
            } catch (error) {
                console.error('导出失败:', error);
                progressText.textContent = '导出失败，请重试';
                
                // 确保恢复所有状态
                document.querySelectorAll('.score-line').forEach(line => {
                    line.style.border = '';
                    line.style.backgroundColor = '';
                });
                
                setTimeout(() => {
                    progress.classList.remove('show');
                }, 2000);
            }
        }

        // 调整全局间距
        function adjustGlobalSpacing(delta) {
            globalSpacing = Math.max(-20, Math.min(40, globalSpacing + delta));
            document.documentElement.style.setProperty('--global-spacing', globalSpacing + 'px');
            document.getElementById('globalSpacingValue').textContent = globalSpacing + 'px';
            updateTieLinePositions();
        }

        // 调整行距
        function adjustLineSpacing(delta) {
            if (!selectedLineForSpacing) {
                alert('请先点击选中要调整行距的行');
                return;
            }
            
            const currentMargin = parseInt(window.getComputedStyle(selectedLineForSpacing).marginBottom);
            const newMargin = Math.max(1, currentMargin + delta);
            selectedLineForSpacing.style.marginBottom = newMargin + 'px';
        }
        
        // 初始化行点击处理器 - 增加行距调整支持
        function initLineClickHandlers() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('voice-line')) {
                    const voiceLine = e.target;
                    const parentLine = voiceLine.closest('.score-line');
                    
                    document.querySelectorAll('.score-line').forEach(l => {
                        l.classList.remove('active');
                        l.classList.remove('selected-for-spacing');
                    });
                    parentLine.classList.add('active');
                    
                    parentLine.querySelectorAll('.voice-line').forEach(v => v.classList.remove('active'));
                    voiceLine.classList.add('active');
                    
                    currentVoice = voiceLine.classList.contains('upper') ? 'upper' : 'lower';
                    document.getElementById('upperVoice').classList.toggle('active', currentVoice === 'upper');
                    document.getElementById('lowerVoice').classList.toggle('active', currentVoice === 'lower');
                    
                    currentInsertPosition = voiceLine;
                    
                    document.querySelectorAll('.cursor').forEach(c => c.style.display = 'none');
                    const cursor = voiceLine.querySelector('.cursor');
                    if (cursor) {
                        cursor.style.display = 'block';
                    }
                }
                else if (e.target.classList.contains('score-line')) {
                    const targetLine = e.target;
                    
                    if (selectedLineForSpacing === targetLine) {
                        targetLine.classList.toggle('selected-for-spacing');
                        if (!targetLine.classList.contains('selected-for-spacing')) {
                            selectedLineForSpacing = null;
                        }
                    } else {
                        document.querySelectorAll('.score-line').forEach(l => {
                            l.classList.remove('active');
                            l.classList.remove('selected-for-spacing');
                        });
                        document.querySelectorAll('.cursor').forEach(c => {
                            c.style.display = 'none';
                        });
                        
                        targetLine.classList.add('active');
                        targetLine.classList.add('selected-for-spacing');
                        selectedLineForSpacing = targetLine;
                        currentInsertPosition = null;
                        
                        if (targetLine.classList.contains('two-voice')) {
                            const voiceContainer = targetLine.querySelector(`.voice-line.${currentVoice}`);
                            if (voiceContainer) {
                                voiceContainer.classList.add('active');
                                currentInsertPosition = voiceContainer;
                                const cursor = voiceContainer.querySelector('.cursor');
                                if (cursor) {
                                    cursor.style.display = 'block';
                                }
                            }
                        } else {
                            const cursor = targetLine.querySelector('.cursor');
                            if (cursor) {
                                cursor.style.display = 'block';
                            }
                        }
                    }
                }
            });
        }

        // 初始化复制粘贴
        function initCopyPaste() {
            document.addEventListener('copy', function(e) {
                if (selectedNote && !e.target.tagName.match(/input|textarea/i)) {
                    e.preventDefault();
                    copySelected();
                }
            });
            
            document.addEventListener('paste', function(e) {
                if (clipboard && !e.target.tagName.match(/input|textarea/i)) {
                    e.preventDefault();
                    pasteAtCursor();
                }
            });
        }
        
        // 复制选中的音符
        function copySelected() {
            if (!selectedNote) {
                alert('请先选择要复制的音符');
                return;
            }
            
            clipboard = {
                arrow: selectedNote.dataset.arrow,
                note: selectedNote.dataset.note,
                svg: selectedNote.dataset.svg,
                duration: selectedNote.dataset.duration,
                modifier: selectedNote.dataset.modifier,
                dotted: selectedNote.dataset.dotted === 'true',
                annotation: selectedNote.querySelector('.note-annotation')?.textContent,
                box: selectedNote.querySelector('.note-box')?.textContent
            };
            
            showCopyIndicator('已复制音符');
        }
        
        // 粘贴到光标位置
        function pasteAtCursor() {
            if (!clipboard) {
                alert('剪贴板为空，请先复制音符');
                return;
            }
            
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const savedDuration = currentDuration;
            const savedModifier = currentModifier;
            const savedDotted = isDotted;
            
            currentDuration = clipboard.duration;
            currentModifier = clipboard.modifier;
            isDotted = clipboard.dotted;
            
            const noteElement = createNoteElement(clipboard.arrow, clipboard.note, clipboard.svg);
            
            if (clipboard.annotation) {
                const annotation = document.createElement('span');
                annotation.className = 'note-annotation';
                annotation.textContent = clipboard.annotation;
                noteElement.querySelector('.note-content').appendChild(annotation);
            }
            
            if (clipboard.box) {
                const box = document.createElement('span');
                box.className = 'note-box';
                box.textContent = clipboard.box;
                noteElement.querySelector('.note-content').appendChild(box);
            }
            
            container.insertBefore(noteElement, cursor);
            
            currentDuration = savedDuration;
            currentModifier = savedModifier;
            isDotted = savedDotted;
            
            showCopyIndicator('已粘贴音符');
            updateTieLinePositions();
        }
        
        // 显示复制粘贴提示
        function showCopyIndicator(text) {
            const indicator = document.getElementById('copyIndicator');
            indicator.textContent = text;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // 初始化声部控制
        function initVoiceControl() {
            document.getElementById('singleVoice').addEventListener('click', function() {
                currentVoiceMode = 'single';
                document.getElementById('singleVoice').classList.add('active');
                document.getElementById('twoVoice').classList.remove('active');
                document.getElementById('voiceSelector').style.display = 'none';
                
                document.querySelectorAll('.score-line.two-voice').forEach(line => {
                    convertToSingleVoice(line);
                });
            });
            
            document.getElementById('twoVoice').addEventListener('click', function() {
                currentVoiceMode = 'two';
                document.getElementById('twoVoice').classList.add('active');
                document.getElementById('singleVoice').classList.remove('active');
                document.getElementById('voiceSelector').style.display = 'flex';
                
                const activeLine = document.querySelector('.score-line.active');
                if (activeLine && !activeLine.classList.contains('two-voice')) {
                    convertToTwoVoice(activeLine);
                }
            });
            
            document.getElementById('upperVoice').addEventListener('click', function() {
                currentVoice = 'upper';
                document.getElementById('upperVoice').classList.add('active');
                document.getElementById('lowerVoice').classList.remove('active');
                updateActiveVoiceLine();
            });
            
            document.getElementById('lowerVoice').addEventListener('click', function() {
                currentVoice = 'lower';
                document.getElementById('lowerVoice').classList.add('active');
                document.getElementById('upperVoice').classList.remove('active');
                updateActiveVoiceLine();
            });
        }
        
        // 更新活动声部行
        function updateActiveVoiceLine() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine || !activeLine.classList.contains('two-voice')) return;
            
            activeLine.querySelectorAll('.voice-line').forEach(voice => {
                voice.classList.remove('active');
            });
            
            const currentVoiceLine = activeLine.querySelector(`.voice-line.${currentVoice}`);
            if (currentVoiceLine) {
                currentVoiceLine.classList.add('active');
                
                const cursor = currentVoiceLine.querySelector('.cursor');
                if (!cursor) {
                    const newCursor = document.createElement('div');
                    newCursor.className = 'cursor';
                    currentVoiceLine.appendChild(newCursor);
                }
            }
        }

        // 转换为双声部
        function convertToTwoVoice(line) {
            if (line.classList.contains('two-voice')) return;
            
            const existingContent = [];
            line.childNodes.forEach(child => {
                if (!child.classList || (!child.classList.contains('cursor') && !child.classList.contains('tie-line-svg'))) {
                    existingContent.push(child.cloneNode(true));
                }
            });
            
            line.innerHTML = '';
            line.classList.add('two-voice');
            
            const upperVoiceLine = document.createElement('div');
            upperVoiceLine.className = 'voice-line upper';
            
            const lowerVoiceLine = document.createElement('div');
            lowerVoiceLine.className = 'voice-line lower';
            
            existingContent.forEach(item => {
                upperVoiceLine.appendChild(item);
            });
            
            const upperCursor = document.createElement('div');
            upperCursor.className = 'cursor';
            const lowerCursor = document.createElement('div');
            lowerCursor.className = 'cursor';
            lowerCursor.style.display = 'none';
            
            upperVoiceLine.appendChild(upperCursor);
            lowerVoiceLine.appendChild(lowerCursor);
            
            if (currentVoice === 'upper') {
                upperVoiceLine.classList.add('active');
            } else {
                lowerVoiceLine.classList.add('active');
                upperCursor.style.display = 'none';
                lowerCursor.style.display = 'block';
            }
            
            line.appendChild(upperVoiceLine);
            line.appendChild(lowerVoiceLine);
            
            initVoiceLineClickHandlers(line);
        }
        
        // 初始化声部行点击处理
        function initVoiceLineClickHandlers(line) {
            line.querySelectorAll('.voice-line').forEach(voiceLine => {
                voiceLine.addEventListener('click', function(e) {
                    if (e.target.closest('.note-group') || e.target.closest('.beam-group')) {
                        return;
                    }
                    
                    const isUpper = this.classList.contains('upper');
                    currentVoice = isUpper ? 'upper' : 'lower';
                    
                    document.getElementById('upperVoice').classList.toggle('active', isUpper);
                    document.getElementById('lowerVoice').classList.toggle('active', !isUpper);
                    
                    line.querySelectorAll('.voice-line').forEach(v => v.classList.remove('active'));
                    this.classList.add('active');
                    
                    line.querySelectorAll('.cursor').forEach(c => c.style.display = 'none');
                    const cursor = this.querySelector('.cursor');
                    if (cursor) {
                        cursor.style.display = 'block';
                    }
                    
                    currentInsertPosition = this;
                });
            });
        }
        
        // 转换为单声部
        function convertToSingleVoice(line) {
            if (!line.classList.contains('two-voice')) return;
            
            const upperContent = [];
            const lowerContent = [];
            
            const upperVoice = line.querySelector('.voice-line.upper');
            const lowerVoice = line.querySelector('.voice-line.lower');
            
            if (upperVoice) {
                upperVoice.childNodes.forEach(child => {
                    if (!child.classList || (!child.classList.contains('cursor') && !child.classList.contains('tie-line-svg'))) {
                        upperContent.push(child.cloneNode(true));
                    }
                });
            }
            
            if (lowerVoice) {
                lowerVoice.childNodes.forEach(child => {
                    if (!child.classList || (!child.classList.contains('cursor') && !child.classList.contains('tie-line-svg'))) {
                        lowerContent.push(child.cloneNode(true));
                    }
                });
            }
            
            line.innerHTML = '';
            line.classList.remove('two-voice');
            
            upperContent.forEach(item => line.appendChild(item));
            lowerContent.forEach(item => line.appendChild(item));
            
            const cursor = document.createElement('div');
            cursor.className = 'cursor';
            line.appendChild(cursor);
        }
        
        // 获取当前声部容器
        function getCurrentVoiceContainer() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return null;
            
            if (currentVoiceMode === 'single' || !activeLine.classList.contains('two-voice')) {
                return activeLine;
            } else {
                if (currentInsertPosition && activeLine.contains(currentInsertPosition)) {
                    return currentInsertPosition;
                }
                return activeLine.querySelector(`.voice-line.${currentVoice}`);
            }
        }

        // 更新单位宽度 - 修复版本，动态调整所有相关尺寸
        function updateUnitWidth(width) {
            document.documentElement.style.setProperty('--unit-width', width + 'px');
            document.documentElement.style.setProperty('--half-unit', (width / 2) + 'px');
            document.documentElement.style.setProperty('--quarter-unit', (width / 4) + 'px');
            
            const modifierWidth = Math.max(6, Math.round(fontSize * 0.33));
            const modifierGap = -5;
            const dotOffset = 5;
            
            document.documentElement.style.setProperty('--modifier-width', modifierWidth + 'px');
            document.documentElement.style.setProperty('--modifier-gap', modifierGap + 'px');
            document.documentElement.style.setProperty('--modifier-font-size', (fontSize * 0.83) + 'px');
            document.documentElement.style.setProperty('--dot-offset', dotOffset + 'px');
        }

        // 更新字体大小 - 修复版本，同步更新所有相关元素
        function updateFontSize(size) {
            fontSize = size;
            document.getElementById('fontSizeValue').textContent = size + 'px';
            
            document.documentElement.style.setProperty('--score-font-size', size + 'px');
            document.documentElement.style.setProperty('--arrow-size', size + 'px');
            
            const tieLineHeight = Math.max(16, Math.round(size * 0.83));
            const tieLineOffset = Math.max(8, Math.round(size * 0.5));
            document.documentElement.style.setProperty('--tie-line-height', tieLineHeight + 'px');
            document.documentElement.style.setProperty('--tie-line-offset', tieLineOffset + 'px');
            
            const unitWidth = Math.max(36, Math.round(size * 1.92));
            updateUnitWidth(unitWidth);
            
            setTimeout(() => {
                updateTieLinePositions();
            }, 10);
        }
        
        // 创建音符元素 - 修复定位问题的版本
        function createNoteElement(arrow, note, svg) {
            const noteGroup = document.createElement('div');
            noteGroup.className = 'note-group';
            
            const noteId = 'note-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            noteGroup.dataset.noteId = noteId;
            
            let noteHTML = '<div class="note-content">';
            
            // 处理各种修饰符组合 - 使用动态定位
            if (currentModifier === 'flat') {
                noteHTML += '<span class="note-modifier-left chromatic" style="left:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap) + 2px);position:absolute;top:calc(50% - 2px);transform:translateY(-50%);"><svg class="modifier-svg chromatic"><use href="#flat-modifier"/></svg></span>';
            } else if (currentModifier === 'octave-down') {
                noteHTML += '<span class="note-modifier-left octave" style="left:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap) + 2px);position:absolute;top:calc(50% - 1px);transform:translateY(-50%);"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
            } else if (currentModifier === 'flat-octave-down') {
                noteHTML += '<span class="note-modifier-double-left" style="position:relative;display:inline-block;width:var(--modifier-width);height:var(--arrow-size);">';
                noteHTML += '<svg class="modifier-svg octave" style="position:absolute;top:-2px;"><use href="#octave-modifier"/></svg>';
                noteHTML += '<svg class="modifier-svg chromatic" style="position:absolute;bottom:-6px;"><use href="#flat-modifier"/></svg>';
                noteHTML += '</span>';
            } else if (currentModifier === 'sharp-octave-down') {
                noteHTML = '<div class="note-content" style="display:inline-flex;align-items:center;">';
                noteHTML += '<span style="position:relative;top:-2px;margin-right:-7px;"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${svg}"/></svg></span>`;
                noteHTML += '<span style="position:relative;top:-2px;margin-left:-7px;"><svg class="modifier-svg chromatic"><use href="#sharp-modifier"/></svg></span>';
            } else if (currentModifier === 'flat-octave-up') {
                noteHTML = '<div class="note-content" style="display:inline-flex;align-items:center;">';
                noteHTML += '<span style="position:relative;top:-2px;margin-right:-7px;"><svg class="modifier-svg chromatic"><use href="#flat-modifier"/></svg></span>';
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${svg}"/></svg></span>`;
                noteHTML += '<span style="position:relative;top:-2px;margin-left:-7px;"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
            }
            
            // 箭头本体 - 只有非混合修饰符才需要插入箭头
            if (currentModifier !== 'sharp-octave-down' && currentModifier !== 'flat-octave-up') {
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${svg}"/></svg></span>`;
            }
            
            // 处理右侧修饰符
            if (currentModifier === 'sharp') {
                noteHTML += '<span class="note-modifier-right chromatic" style="right:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap));position:absolute;top:calc(50% - 1px);transform:translateY(-50%);"><svg class="modifier-svg chromatic"><use href="#sharp-modifier"/></svg></span>';
            } else if (currentModifier === 'octave-up') {
                noteHTML += '<span class="note-modifier-right octave" style="right:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap) + 2px);position:absolute;top:calc(50% - 1px);transform:translateY(-50%);"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
            } else if (currentModifier === 'sharp-octave-up') {
                noteHTML += '<span class="note-modifier-double-right" style="position:relative;display:inline-block;width:var(--modifier-width);height:var(--arrow-size);margin-left:-11px;">';
                noteHTML += '<svg class="modifier-svg octave" style="position:absolute;top:-2px;"><use href="#octave-modifier"/></svg>';
                noteHTML += '<svg class="modifier-svg chromatic" style="position:absolute;bottom:-6px;"><use href="#sharp-modifier"/></svg>';
                noteHTML += '</span>';
            }
            
            if (isDotted) {
                noteHTML += '<span class="note-dot">·</span>';
            }
            
            noteHTML += '</div>';
            
            // 对于单个音符，添加自己的减时线
            if ((beamMode === 'separate' || beamMode === 'connect') && 
                (currentDuration === 'eighth' || currentDuration === 'sixteenth')) {
                noteHTML += '<div class="beam-container">';
                noteHTML += '<div class="beam-line"></div>';
                if (currentDuration === 'sixteenth') {
                    noteHTML += '<div class="beam-line second"></div>';
                }
                noteHTML += '</div>';
            }
            
            noteGroup.innerHTML = noteHTML;
            noteGroup.dataset.note = note;
            noteGroup.dataset.duration = currentDuration;
            noteGroup.dataset.modifier = currentModifier;
            noteGroup.dataset.dotted = isDotted;
            noteGroup.dataset.arrow = arrow;
            noteGroup.dataset.svg = svg;
            
            return noteGroup;
        }

        // 初始化时值按钮
        function initDurationButtons() {
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.dataset.duration === 'triplet') {
                        toggleTriplet();
                    } else if (this.dataset.duration === 'quarter') {
                        document.querySelectorAll('.duration-btn').forEach(b => {
                            if (b.dataset.duration !== 'triplet') {
                                b.classList.remove('active');
                            }
                        });
                        this.classList.add('active');
                        currentDuration = 'quarter';
                        currentModifier = 'none';
                        updatePreview();
                    } else {
                        document.querySelectorAll('.duration-btn').forEach(b => {
                            if (b.dataset.duration !== 'triplet') {
                                b.classList.remove('active');
                            }
                        });
                        this.classList.add('active');
                        currentDuration = this.dataset.duration;
                        updatePreview();
                    }
                });
            });
        }
        
        // 初始化变音按钮
        function initModifierButtons() {
            document.querySelectorAll('.modifier-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('active')) {
                        this.classList.remove('active');
                        currentModifier = 'none';
                        updatePreview();
                    } else {
                        document.querySelectorAll('.modifier-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentModifier = this.dataset.modifier;
                        updatePreview();
                    }
                });
            });
        }

        // 初始化箭头按钮
        function initArrowButtons() {
            document.querySelectorAll('.arrow-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const arrow = this.dataset.arrow;
                    const note = this.dataset.note;
                    const svg = this.dataset.svg;
                    
                    ensureActiveLineAndCursor();
                    
                    if (arrow === '0') {
                        insertRest();
                    } else {
                        lastNote = {
                            arrow: arrow,
                            note: note,
                            svg: svg,
                            modifier: currentModifier
                        };
                        
                        if (isTripletMode) {
                            insertTripletNote(arrow, note, svg);
                        } else {
                            insertNote(arrow, note, svg);
                        }
                    }
                });
            });
        }
        
        // 确保有活动行和可见光标
        function ensureActiveLineAndCursor() {
            let activeLine = document.querySelector('.score-line.active');
            if (!activeLine) {
                activeLine = document.querySelector('.score-line');
                if (activeLine) {
                    activeLine.classList.add('active');
                    if (currentVoiceMode === 'two' && !activeLine.classList.contains('two-voice')) {
                        convertToTwoVoice(activeLine);
                    }
                }
            }
            
            let cursor;
            if (currentVoiceMode === 'two' && activeLine.classList.contains('two-voice')) {
                const voiceContainer = activeLine.querySelector(`.voice-line.${currentVoice}`);
                if (voiceContainer) {
                    voiceContainer.classList.add('active');
                    currentInsertPosition = voiceContainer;
                    cursor = voiceContainer.querySelector('.cursor');
                    if (cursor) cursor.style.display = 'block';
                }
            } else {
                cursor = activeLine?.querySelector('.cursor');
                if (cursor) cursor.style.display = 'block';
            }
        }
        
        // 插入音符 - 支持智能减时线
        function insertNote(arrow, note, svg) {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const noteElement = createNoteElement(arrow, note, svg);
            
            if (pendingAnnotation) {
                const annotation = document.createElement('span');
                annotation.className = 'note-annotation';
                annotation.textContent = pendingAnnotation;
                noteElement.querySelector('.note-content').appendChild(annotation);
                pendingAnnotation = null;
            }
            
            if (pendingBox) {
                const box = document.createElement('span');
                box.className = 'note-box';
                box.textContent = pendingBox;
                noteElement.querySelector('.note-content').appendChild(box);
                pendingBox = null;
            }
            
            // 智能减时线逻辑
            if (smartBeamMode && (currentDuration === 'eighth' || currentDuration === 'sixteenth')) {
                if (beamGroup.length > 0) {
                    const lastInGroup = beamGroup[beamGroup.length - 1];
                    if (lastInGroup.duration !== currentDuration) {
                        completeBeamGroup();
                        smartBeamCounter = 0;
                    }
                }
                
                const beamId = 'beam-' + Date.now() + '-' + Math.random();
                noteElement.dataset.beamId = beamId;
                
                beamGroup.push({
                    id: beamId,
                    arrow: arrow,
                    note: note,
                    svg: svg,
                    modifier: currentModifier,
                    duration: currentDuration,
                    dotted: isDotted,
                    annotation: pendingAnnotation,
                    box: pendingBox,
                    noteId: noteElement.dataset.noteId
                });
                
                container.insertBefore(noteElement, cursor);
                smartBeamCounter++;
                
                // 每4个音符自动完成一组
                if (smartBeamCounter >= 4) {
                    completeBeamGroup();
                    smartBeamCounter = 0;
                }
                
                updateBeamStatus();
            } else if (beamMode === 'connect' && (currentDuration === 'eighth' || currentDuration === 'sixteenth')) {
                const beamId = 'beam-' + Date.now() + '-' + Math.random();
                noteElement.dataset.beamId = beamId;
                
                beamGroup.push({
                    id: beamId,
                    arrow: arrow,
                    note: note,
                    svg: svg,
                    modifier: currentModifier,
                    duration: currentDuration,
                    dotted: isDotted,
                    annotation: pendingAnnotation,
                    box: pendingBox,
                    noteId: noteElement.dataset.noteId
                });
                
                container.insertBefore(noteElement, cursor);
                updateBeamStatus();
            } else {
                if (smartBeamMode && beamGroup.length > 0) {
                    completeBeamGroup();
                    smartBeamCounter = 0;
                }
                
                if (currentDuration === 'extend') {
                    const extendElement = document.createElement('div');
                    extendElement.className = 'note-extend';
                    extendElement.innerHTML = '<svg><use href="#extend-symbol"/></svg>';
                    container.insertBefore(extendElement, cursor);
                } else {
                    container.insertBefore(noteElement, cursor);
                }
            }
            
            if (currentDuration !== 'extend') {
                lastDuration = currentDuration;
            }
            
            checkPageOverflow();
            updateTieLinePositions();
        }

        // 更新预览 - 支持新的组合修饰符
        function updatePreview() {
            const preview = document.getElementById('currentPreview');
            let html = '';
            
            const arrow = '<svg class="arrow-svg"><use href="#arrow-right"/></svg>';
            
            // 处理各种修饰符组合
            if (currentModifier === 'sharp') {
                html = `${arrow}<span style="position:relative;bottom:-5px;margin-left:-1px;"><svg class="modifier-svg chromatic"><use href="#sharp-modifier"/></svg></span>`;
            } else if (currentModifier === 'flat') {
                html = `<span style="position:relative;bottom:-6px;margin-right:-1px;"><svg class="modifier-svg chromatic"><use href="#flat-modifier"/></svg></span>${arrow}`;
            } else if (currentModifier === 'octave-up') {
                html = `${arrow}<svg class="modifier-svg octave" style="margin-left:-3px;position:relative;top:0px;"><use href="#octave-modifier"/></svg>`;
            } else if (currentModifier === 'octave-down') {
                html = `<svg class="modifier-svg octave" style="margin-right:-1px;position:relative;top:-1px;"><use href="#octave-modifier"/></svg>${arrow}`;
            } else if (currentModifier === 'flat-octave-down') {
                html = `<span style="position:relative;display:inline-block;">
                    <svg class="modifier-svg octave" style="position:absolute;left:-10px;top:-8px;"><use href="#octave-modifier"/></svg>
                    <svg class="modifier-svg chromatic" style="position:absolute;left:-10px;top:2px;"><use href="#flat-modifier"/></svg>
                    ${arrow}
                </span>`;
            } else if (currentModifier === 'sharp-octave-up') {
                html = `<span style="position:relative;display:inline-block;">
                    ${arrow}
                    <svg class="modifier-svg octave" style="position:absolute;right:-10px;top:-8px;"><use href="#octave-modifier"/></svg>
                    <svg class="modifier-svg chromatic" style="position:absolute;right:-10px;top:2px;"><use href="#sharp-modifier"/></svg>
                </span>`;
            } else if (currentModifier === 'sharp-octave-down') {
                html = `<span style="position:relative;display:inline-block;">
                    <svg class="modifier-svg octave" style="position:absolute;left:-10px;top:-8px;"><use href="#octave-modifier"/></svg>
                    ${arrow}
                    <svg class="modifier-svg chromatic" style="position:absolute;right:-10px;top:2px;"><use href="#sharp-modifier"/></svg>
                </span>`;
            } else if (currentModifier === 'flat-octave-up') {
                html = `<span style="position:relative;display:inline-block;">
                    <svg class="modifier-svg chromatic" style="position:absolute;left:-10px;top:2px;"><use href="#flat-modifier"/></svg>
                    ${arrow}
                    <svg class="modifier-svg octave" style="position:absolute;right:-10px;top:-8px;"><use href="#octave-modifier"/></svg>
                </span>`;
            } else {
                html = arrow;
            }
            
            if (currentDuration === 'extend') {
                html += ' ~';
            }
            
            if (isDotted) {
                html += '·';
            }
            
            if (currentDuration === 'eighth' || currentDuration === 'sixteenth') {
                html += '<div style="margin-top:2px;">';
                if (currentDuration === 'eighth') {
                    html += '──';
                } else {
                    html += '╬╬';
                }
                html += '</div>';
            }
            
            preview.innerHTML = html;
        }
        
        // 移动光标 - 增强版支持上下左右键
        function moveCursor(direction) {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            if (direction === 'left' || direction === 'ArrowLeft') {
                const prev = cursor.previousElementSibling;
                if (prev && !prev.classList.contains('tie-line-svg')) {
                    container.insertBefore(cursor, prev);
                }
            } else if (direction === 'right' || direction === 'ArrowRight') {
                const next = cursor.nextElementSibling;
                if (next && !next.classList.contains('tie-line-svg')) {
                    container.insertBefore(cursor, next.nextElementSibling);
                }
            } else if (direction === 'up' || direction === 'ArrowUp') {
                moveCursorVertical('up');
            } else if (direction === 'down' || direction === 'ArrowDown') {
                moveCursorVertical('down');
            }
        }
        
        // 垂直移动光标
        function moveCursorVertical(direction) {
            const currentLine = document.querySelector('.score-line.active');
            if (!currentLine) return;
            
            if (currentLine.classList.contains('two-voice')) {
                if (direction === 'up' && currentVoice === 'lower') {
                    currentVoice = 'upper';
                    document.getElementById('upperVoice').click();
                } else if (direction === 'down' && currentVoice === 'upper') {
                    currentVoice = 'lower';
                    document.getElementById('lowerVoice').click();
                }
            } else {
                const allLines = Array.from(document.querySelectorAll('.score-line'));
                const currentIndex = allLines.indexOf(currentLine);
                
                let targetLine;
                if (direction === 'up' && currentIndex > 0) {
                    targetLine = allLines[currentIndex - 1];
                } else if (direction === 'down' && currentIndex < allLines.length - 1) {
                    targetLine = allLines[currentIndex + 1];
                }
                
                if (targetLine) {
                    currentLine.classList.remove('active');
                    document.querySelectorAll('.cursor').forEach(c => c.style.display = 'none');
                    
                    targetLine.classList.add('active');
                    if (targetLine.classList.contains('two-voice')) {
                        const voiceLine = targetLine.querySelector(`.voice-line.${currentVoice}`);
                        if (voiceLine) {
                            voiceLine.classList.add('active');
                            const cursor = voiceLine.querySelector('.cursor');
                            if (cursor) cursor.style.display = 'block';
                        }
                    } else {
                        const cursor = targetLine.querySelector('.cursor');
                        if (cursor) cursor.style.display = 'block';
                    }
                }
            }
        }

        // 初始化键盘快捷键 - 增强版
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT') return;
                
                const key = e.key.toLowerCase();
                const ctrl = e.ctrlKey || e.metaKey;
                const shift = e.shiftKey;
                
                if (key === 'q' || key === 'e' || key === 'a' || key === 'd') {
                    modifierKeys[key] = true;
                    checkModifierCombination();
                }
                
                const noteMap = {
                    '1': { arrow: 'up', note: '1', svg: 'arrow-up' },
                    '2': { arrow: 'left-down', note: '2', svg: 'arrow-left-down' },
                    '3': { arrow: 'right', note: '3', svg: 'arrow-right' },
                    '4': { arrow: 'right-down', note: '4', svg: 'arrow-right-down' },
                    '5': { arrow: 'down', note: '5', svg: 'arrow-down' },
                    '6': { arrow: 'right-up', note: '6', svg: 'arrow-right-up' },
                    '7': { arrow: 'left', note: '7', svg: 'arrow-left' },
                    '8': { arrow: 'left-up', note: "1'", svg: 'arrow-left-up' }
                };
                
                ensureActiveLineAndCursor();
                
                if (ctrl) {
                    if (key === 'c') {
                        e.preventDefault();
                        copySelected();
                        return;
                    } else if (key === 'v') {
                        e.preventDefault();
                        pasteAtCursor();
                        return;
                    }
                }
                
                if (key === 'arrowleft' || key === 'arrowright' || 
                    key === 'arrowup' || key === 'arrowdown') {
                    e.preventDefault();
                    moveCursor(e.key);
                    return;
                }
                
                if (key === 'w') {
                    setDuration('quarter');
                    currentModifier = 'none';
                }
                else if (key === 's') {
                    setDuration('eighth');
                } else if (key === 'x') {
                    setDuration('sixteenth');
                }
                else if (key === '.') {
                    e.preventDefault();
                    document.getElementById('dotted').checked = !document.getElementById('dotted').checked;
                    updateDotted();
                }
                else if (key === 'f') {
                    setBeamMode('smart');
                } else if (key === 'g') {
                    setBeamMode('separate');
                }
                else if (key === 'r') {
                    e.preventDefault();
                    insertBarline();
                } else if (key === '9') {
                    insertExtend();
                }
                else if (noteMap[key]) {
                    lastNote = {
                        arrow: noteMap[key].arrow,
                        note: noteMap[key].note,
                        svg: noteMap[key].svg,
                        modifier: currentModifier
                    };
                    if (isTripletMode) {
                        insertTripletNote(noteMap[key].arrow, noteMap[key].note, noteMap[key].svg);
                    } else {
                        insertNote(noteMap[key].arrow, noteMap[key].note, noteMap[key].svg);
                    }
                } else if (key === '0') {
                    insertRest();
                } else if (key === ' ') {
                    e.preventDefault();
                    insertSpacer();
                } else if (key === '|' || key === 'b') {
                    e.preventDefault();
                    insertBarline();
                } else if (key === 'backspace') {
                    if (shift) {
                        e.preventDefault();
                        deleteLine();
                    } else {
                        deleteLast();
                    }
                } else if (key === 'enter') {
                    e.preventDefault();
                    newLine();
                } else if (key === '=' || key === '+') {
                    insertTie();
                } else if (key === 'c' && !ctrl) {
                    e.preventDefault();
                    centerLine();
                }
            });
            
            document.addEventListener('keyup', function(e) {
                const key = e.key.toLowerCase();
                
                if (key === 'q' || key === 'e' || key === 'a' || key === 'd') {
                    modifierKeys[key] = false;
                    if (!modifierKeys.q && !modifierKeys.e && !modifierKeys.a && !modifierKeys.d) {
                        checkModifierCombination();
                    }
                }
            });
        }
        
        // 检查修饰符组合
        function checkModifierCombination() {
            let newModifier = 'none';
            
            if (modifierKeys.q && modifierKeys.a) {
                newModifier = 'flat-octave-down';
            } else if (modifierKeys.e && modifierKeys.d) {
                newModifier = 'sharp-octave-up';
            } else if (modifierKeys.q && modifierKeys.d) {
                newModifier = 'sharp-octave-down';
            } else if (modifierKeys.a && modifierKeys.e) {
                newModifier = 'flat-octave-up';
            } else if (modifierKeys.q) {
                newModifier = 'octave-down';
            } else if (modifierKeys.e) {
                newModifier = 'octave-up';
            } else if (modifierKeys.a) {
                newModifier = 'flat';
            } else if (modifierKeys.d) {
                newModifier = 'sharp';
            }
            
            if (newModifier === currentModifier && newModifier !== 'none') {
                currentModifier = 'none';
                document.querySelectorAll('.modifier-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            } else {
                currentModifier = newModifier;
                document.querySelectorAll('.modifier-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.modifier === newModifier);
                });
            }
            
            updatePreview();
        }
        
        // 设置修饰符
        function setModifier(modifier) {
            if (currentModifier === modifier) {
                currentModifier = 'none';
                document.querySelectorAll('.modifier-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            } else {
                currentModifier = modifier;
                document.querySelectorAll('.modifier-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.modifier === modifier);
                });
            }
            updatePreview();
        }
        
        // 设置时值
        function setDuration(duration) {
            currentDuration = duration;
            if (duration === 'quarter') {
                currentModifier = 'none';
            }
            document.querySelectorAll('.duration-btn').forEach(btn => {
                if (btn.dataset.duration !== 'triplet') {
                    btn.classList.toggle('active', btn.dataset.duration === duration);
                }
            });
            updatePreview();
        }

        // 设置减时线模式 - 支持智能模式
        function setBeamMode(mode) {
            beamMode = mode;
            
            if (mode === 'smart') {
                smartBeamMode = true;
                smartBeamCounter = 0;
                document.getElementById('beamConnect').textContent = '智能连接 (F)';
                document.getElementById('beamConnect').classList.add('active');
                document.getElementById('beamSeparate').classList.remove('active');
                document.getElementById('beamStatus').classList.add('active');
                updateBeamStatus();
            } else if (mode === 'connect') {
                smartBeamMode = false;
                smartBeamCounter = 0;
                document.getElementById('beamConnect').textContent = '连接减时线 (F)';
                document.getElementById('beamConnect').classList.add('active');
                document.getElementById('beamSeparate').classList.remove('active');
                document.getElementById('beamStatus').classList.add('active');
                beamGroup = [];
                updateBeamStatus();
            } else {
                smartBeamMode = false;
                smartBeamCounter = 0;
                document.getElementById('beamSeparate').classList.add('active');
                document.getElementById('beamConnect').classList.remove('active');
                document.getElementById('beamStatus').classList.remove('active');
                if (beamGroup.length > 0) {
                    completeBeamGroup();
                }
                beamGroup = [];
            }
        }
        
        // 初始化减时线控制 - 支持智能模式
        function initBeamControl() {
            document.getElementById('beamConnect').addEventListener('click', function() {
                if (!smartBeamMode) {
                    setBeamMode('smart');
                } else {
                    setBeamMode('connect');
                }
            });
            
            document.getElementById('beamSeparate').addEventListener('click', function() {
                setBeamMode('separate');
            });
        }
        
        // 手动完成连音组
        function completeBeamGroup() {
            if (beamGroup.length < 2) {
                beamGroup = [];
                updateBeamStatus();
                return;
            }
            
            const container = getCurrentVoiceContainer();
            const cursor = container.querySelector('.cursor');
            
            const groupContainer = document.createElement('div');
            groupContainer.className = 'beam-group';
            
            const notesContainer = document.createElement('div');
            notesContainer.className = 'note-groups';
            
            beamGroup.forEach(noteData => {
                const originalNote = document.querySelector(`[data-beam-id="${noteData.id}"]`);
                if (originalNote) {
                    originalNote.remove();
                }
                
                const newNote = createNoteElementForBeam(noteData);
                notesContainer.appendChild(newNote);
            });
            
            groupContainer.appendChild(notesContainer);
            
            const smartBeams = createSmartBeams(beamGroup);
            groupContainer.appendChild(smartBeams);
            
            container.insertBefore(groupContainer, cursor);
            beamGroup = [];
            updateBeamStatus();
            
            checkPageOverflow();
            updateTieLinePositions();
        }

        // 创建用于连音组的音符元素
        function createNoteElementForBeam(noteData) {
            const noteGroup = document.createElement('div');
            noteGroup.className = 'note-group';
            if (noteData.noteId) {
                noteGroup.dataset.noteId = noteData.noteId;
            }
            
            let noteHTML = '<div class="note-content">';
            
            // 处理修饰符 - 完整复制 createNoteElement 的逻辑
            if (noteData.modifier === 'flat') {
                noteHTML += '<span class="note-modifier-left chromatic" style="left:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap) + 2px);position:absolute;top:calc(50% - 2px);transform:translateY(-50%);"><svg class="modifier-svg chromatic"><use href="#flat-modifier"/></svg></span>';
            } else if (noteData.modifier === 'octave-down') {
                noteHTML += '<span class="note-modifier-left octave" style="left:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap) + 2px);position:absolute;top:calc(50% - 1px);transform:translateY(-50%);"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
            } else if (noteData.modifier === 'flat-octave-down') {
                noteHTML += '<span class="note-modifier-double-left" style="position:relative;display:inline-block;width:var(--modifier-width);height:var(--arrow-size);">';
                noteHTML += '<svg class="modifier-svg octave" style="position:absolute;top:-2px;"><use href="#octave-modifier"/></svg>';
                noteHTML += '<svg class="modifier-svg chromatic" style="position:absolute;bottom:-6px;"><use href="#flat-modifier"/></svg>';
                noteHTML += '</span>';
            } else if (noteData.modifier === 'sharp-octave-down') {
                noteHTML = '<div class="note-content" style="display:inline-flex;align-items:center;">';
                noteHTML += '<span style="position:relative;top:-2px;margin-right:-7px;"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${noteData.svg}"/></svg></span>`;
                noteHTML += '<span style="position:relative;top:-2px;margin-left:-7px;"><svg class="modifier-svg chromatic"><use href="#sharp-modifier"/></svg></span>';
            } else if (noteData.modifier === 'flat-octave-up') {
                noteHTML = '<div class="note-content" style="display:inline-flex;align-items:center;">';
                noteHTML += '<span style="position:relative;top:-2px;margin-right:-7px;"><svg class="modifier-svg chromatic"><use href="#flat-modifier"/></svg></span>';
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${noteData.svg}"/></svg></span>`;
                noteHTML += '<span style="position:relative;top:-2px;margin-left:-7px;"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
            }
            
            // 箭头本体 - 只有非混合修饰符才需要插入箭头
            if (noteData.modifier !== 'sharp-octave-down' && noteData.modifier !== 'flat-octave-up') {
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${noteData.svg}"/></svg></span>`;
            }
            
            // 处理右侧修饰符
            if (noteData.modifier === 'sharp') {
                noteHTML += '<span class="note-modifier-right chromatic" style="right:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap));position:absolute;top:calc(50% - 1px);transform:translateY(-50%);"><svg class="modifier-svg chromatic"><use href="#sharp-modifier"/></svg></span>';
            } else if (noteData.modifier === 'octave-up') {
                noteHTML += '<span class="note-modifier-right octave" style="right:calc(50% - var(--arrow-size) / 2 - var(--modifier-width) - var(--modifier-gap) + 2px);position:absolute;top:calc(50% - 1px);transform:translateY(-50%);"><svg class="modifier-svg octave"><use href="#octave-modifier"/></svg></span>';
            } else if (noteData.modifier === 'sharp-octave-up') {
                noteHTML += '<span class="note-modifier-double-right" style="position:relative;display:inline-block;width:var(--modifier-width);height:var(--arrow-size);margin-left:-11px;">';
                noteHTML += '<svg class="modifier-svg octave" style="position:absolute;top:-2px;"><use href="#octave-modifier"/></svg>';
                noteHTML += '<svg class="modifier-svg chromatic" style="position:absolute;bottom:-6px;"><use href="#sharp-modifier"/></svg>';
                noteHTML += '</span>';
            }
            
            if (noteData.dotted) {
                noteHTML += '<span class="note-dot">·</span>';
            }
            
            if (noteData.annotation) {
                noteHTML += `<span class="note-annotation">${noteData.annotation}</span>`;
            }
            
            if (noteData.box) {
                noteHTML += `<span class="note-box">${noteData.box}</span>`;
            }
            
            noteHTML += '</div>';
            noteGroup.innerHTML = noteHTML;
            
            // 保存原始数据属性
            noteGroup.dataset.note = noteData.note;
            noteGroup.dataset.duration = noteData.duration;
            noteGroup.dataset.modifier = noteData.modifier;
            noteGroup.dataset.dotted = noteData.dotted;
            noteGroup.dataset.arrow = noteData.arrow;
            noteGroup.dataset.svg = noteData.svg;
            
            return noteGroup;
        }
        
        // 创建智能减时线
        function createSmartBeams(noteGroup) {
            const beamContainer = document.createElement('div');
            beamContainer.className = 'smart-beams';
            
            const hasEighthOrSixteenth = noteGroup.some(n => 
                n.duration === 'eighth' || n.duration === 'sixteenth'
            );
            
            if (hasEighthOrSixteenth) {
                const beam1 = document.createElement('div');
                beam1.className = 'connected-beam first';
                beamContainer.appendChild(beam1);
            }
            
            const allSixteenth = noteGroup.every(note => note.duration === 'sixteenth');
            
            if (allSixteenth && noteGroup.length > 0) {
                const beam2 = document.createElement('div');
                beam2.className = 'connected-beam second';
                beamContainer.appendChild(beam2);
            } else {
                const sixteenthIndices = [];
                noteGroup.forEach((note, index) => {
                    if (note.duration === 'sixteenth') {
                        sixteenthIndices.push(index);
                    }
                });
                
                if (sixteenthIndices.length > 0) {
                    sixteenthIndices.forEach(index => {
                        const beam2 = document.createElement('div');
                        beam2.className = 'connected-beam second';
                        const noteWidth = 100 / noteGroup.length;
                        beam2.style.left = (index * noteWidth) + '%';
                        beam2.style.width = noteWidth + '%';
                        beamContainer.appendChild(beam2);
                    });
                }
            }
            
            return beamContainer;
        }
        
        // 更新附点状态
        function updateDotted() {
            isDotted = document.getElementById('dotted').checked;
            updatePreview();
        }
        
        // 切换三连音模式
        function toggleTriplet() {
            isTripletMode = !isTripletMode;
            const btn = document.getElementById('tripletBtn');
            const status = document.getElementById('tripletStatus');
            
            if (isTripletMode) {
                btn.classList.add('active');
                status.classList.add('active');
                tripletGroup = [];
                updateTripletStatus();
            } else {
                btn.classList.remove('active');
                status.classList.remove('active');
                tripletGroup = [];
            }
        }
        
        // 更新三连音状态
        function updateTripletStatus() {
            document.getElementById('tripletCount').textContent = tripletGroup.length;
        }
        
        // 更新连音组状态
        function updateBeamStatus() {
            document.getElementById('beamCount').textContent = beamGroup.length;
        }
        
        // 插入三连音音符
        function insertTripletNote(arrow, note, svg) {
            const noteElement = createNoteElement(arrow, note, svg);
            tripletGroup.push(noteElement);
            updateTripletStatus();
            
            if (tripletGroup.length === 3) {
                const container = getCurrentVoiceContainer();
                const cursor = container.querySelector('.cursor');
                
                const tripletContainer = document.createElement('div');
                tripletContainer.className = 'triplet-group';
                
                const bracket = document.createElement('div');
                bracket.className = 'triplet-bracket';
                bracket.innerHTML = '╭ 3 ╮';
                
                const notesContainer = document.createElement('div');
                notesContainer.className = 'triplet-notes';
                
                tripletGroup.forEach(n => {
                    notesContainer.appendChild(n);
                });
                
                tripletContainer.appendChild(bracket);
                tripletContainer.appendChild(notesContainer);
                
                container.insertBefore(tripletContainer, cursor);
                
                tripletGroup = [];
                isTripletMode = false;
                document.getElementById('tripletBtn').classList.remove('active');
                document.getElementById('tripletStatus').classList.remove('active');
                
                checkPageOverflow();
                updateTieLinePositions();
            }
        }

        // 插入延长符号
        function insertExtend() {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const extendElement = document.createElement('div');
            extendElement.className = 'note-extend';
            extendElement.innerHTML = '<svg><use href="#extend-symbol"/></svg>';
            container.insertBefore(extendElement, cursor);
        }
        
        // 插入标注
        function insertAnnotation(type) {
            pendingAnnotation = type;
        }
        
        // 插入盒子标注
        function insertBox(type) {
            pendingBox = type;
        }
        
        // 插入空格
        function insertSpacer() {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const spacer = document.createElement('div');
            spacer.className = 'spacer';
            container.insertBefore(spacer, cursor);
        }
        
        // 插入休止符 - 支持垂直居中
        function insertRest() {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const rest = document.createElement('div');
            rest.className = 'rest';
            rest.style.position = 'relative';
            
            let restContent = '<div>0</div>';
            
            if (currentDuration === 'eighth' || currentDuration === 'sixteenth') {
                restContent += '<div class="beam-container">';
                restContent += '<div class="beam-line"></div>';
                if (currentDuration === 'sixteenth') {
                    restContent += '<div class="beam-line second"></div>';
                }
                restContent += '</div>';
            }
            
            if (isDotted) {
                restContent = restContent.replace('</div>', '·</div>');
            }
            
            rest.innerHTML = restContent;
            rest.dataset.duration = currentDuration;
            
            container.insertBefore(rest, cursor);
            checkPageOverflow();
            updateTieLinePositions();
        }
        
        // 插入小节线
        function insertBarline() {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const barline = document.createElement('div');
            barline.className = 'barline';
            container.insertBefore(barline, cursor);
        }
        
        // 插入终止线
        function insertDoubleBar() {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const doubleBar = document.createElement('div');
            doubleBar.className = 'double-barline';
            container.insertBefore(doubleBar, cursor);
        }
        
        // 插入反复记号
        function insertRepeat(type) {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const repeat = document.createElement('div');
            repeat.className = 'repeat-sign';
            repeat.innerHTML = type;
            container.insertBefore(repeat, cursor);
        }
        
        // 删除最后一个元素
        function deleteLast() {
            const container = getCurrentVoiceContainer();
            if (!container) return;
            
            const cursor = container.querySelector('.cursor');
            if (!cursor) return;
            
            const prev = cursor.previousElementSibling;
            if (prev && !prev.classList.contains('tie-line-svg')) {
                prev.remove();
                updateTieLinePositions();
            }
        }
        
        // 清空行
        function clearLine() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            if (activeLine.classList.contains('two-voice')) {
                activeLine.innerHTML = '';
                convertToTwoVoice(activeLine);
            } else {
                activeLine.innerHTML = '<div class="cursor"></div>';
            }
            
            beamGroup = [];
            tripletGroup = [];
            smartBeamCounter = 0;
            updateBeamStatus();
        }
        
        // 删除行
        function deleteLine() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            if (!confirm('确定要删除这一行吗？')) return;
            
            activeLine.remove();
            renumberLines();
        }
        
        // 创建新行
        function newLine() {
            if (beamGroup.length > 0) {
                completeBeamGroup();
            }
            
            const pageElement = document.getElementById(`page-${currentPage}`);
            const scoreLines = pageElement.querySelector('#scoreLines');
            
            currentLine++;
            const newLineDiv = document.createElement('div');
            newLineDiv.className = 'score-line active';
            newLineDiv.dataset.line = currentLine;
            newLineDiv.dataset.page = currentPage;
            
            document.querySelectorAll('.score-line').forEach(line => {
                line.classList.remove('active');
            });
            document.querySelectorAll('.cursor').forEach(c => {
                c.style.display = 'none';
            });
            
            if (currentVoiceMode === 'two') {
                convertToTwoVoice(newLineDiv);
            } else {
                newLineDiv.innerHTML = '<div class="cursor"></div>';
            }
            
            scoreLines.appendChild(newLineDiv);
            smartBeamCounter = 0;
            checkPageOverflow();
        }
        
        // 居中对齐 - 改进版
        function centerLine() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) {
                alert('请先选择要居中对齐的行');
                return;
            }
            
            if (activeLine.classList.contains('centered')) {
                activeLine.classList.remove('centered');
                activeLine.style.textAlign = '';
                activeLine.style.justifyContent = '';
            } else {
                activeLine.classList.add('centered');
                activeLine.style.textAlign = 'center';
                activeLine.style.justifyContent = 'center';
                
                if (activeLine.classList.contains('two-voice')) {
                    activeLine.querySelectorAll('.voice-line').forEach(voice => {
                        voice.style.justifyContent = 'center';
                    });
                }
            }
        }

        // 插入双音连线符号
        function insertTie() {
            if (!tieMode) {
                tieMode = true;
                firstTieNote = null;
                alert('请点击第一个音符，然后点击第二个音符来添加连音线');
                document.querySelectorAll('.note-group').forEach(note => {
                    note.classList.add('tie-selectable');
                });
            } else {
                exitTieMode();
            }
        }
        
        // 退出连音线模式
        function exitTieMode() {
            tieMode = false;
            firstTieNote = null;
            document.querySelectorAll('.note-group').forEach(note => {
                note.classList.remove('tie-selectable');
                note.classList.remove('tie-first-selected');
            });
        }
        
        // 处理连音线选择
        function handleTieSelection(noteElement) {
            if (!tieMode) return false;
            
            if (!firstTieNote) {
                firstTieNote = noteElement;
                noteElement.classList.add('tie-first-selected');
                return true;
            } else if (noteElement !== firstTieNote) {
                createTieLine(firstTieNote, noteElement);
                exitTieMode();
                return true;
            }
            return false;
        }
        
        // 创建连音线 - 改进版，根据字体大小调整
        function createTieLine(note1, note2) {
            const line = note1.closest('.score-line, .voice-line');
            if (!line) return;
            
            const rect1 = note1.getBoundingClientRect();
            const rect2 = note2.getBoundingClientRect();
            const lineRect = line.getBoundingClientRect();
            
            const x1 = rect1.left + rect1.width/2 - lineRect.left;
            const x2 = rect2.left + rect2.width/2 - lineRect.left;
            
            const tieOffset = parseFloat(getComputedStyle(document.documentElement)
                .getPropertyValue('--tie-line-offset')) || 12;
            const tieHeight = parseFloat(getComputedStyle(document.documentElement)
                .getPropertyValue('--tie-line-height')) || 20;
            
            const y = rect1.top - lineRect.top - tieOffset;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.left = Math.min(x1, x2) + 'px';
            svg.style.top = y + 'px';
            svg.style.width = Math.abs(x2 - x1) + 'px';
            svg.style.height = tieHeight + 'px';
            svg.classList.add('tie-line-svg');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M 0 ${tieHeight * 0.75} Q ${Math.abs(x2 - x1)/2} ${tieHeight * 0.25}, ${Math.abs(x2 - x1)} ${tieHeight * 0.75}`;
            path.setAttribute('d', d);
            path.setAttribute('stroke', '#333');
            path.setAttribute('stroke-width', '1.5');
            path.setAttribute('fill', 'none');
            
            svg.appendChild(path);
            line.appendChild(svg);
            
            tieLinesData.push({ note1, note2, svg, line });
        }
        
        // 更新连音线位置
        function updateTieLinePositions() {
            tieLinesData = tieLinesData.filter(tieData => {
                if (!document.contains(tieData.note1) || !document.contains(tieData.note2)) {
                    tieData.svg.remove();
                    return false;
                }
                
                const rect1 = tieData.note1.getBoundingClientRect();
                const rect2 = tieData.note2.getBoundingClientRect();
                const lineRect = tieData.line.getBoundingClientRect();
                
                const x1 = rect1.left + rect1.width/2 - lineRect.left;
                const x2 = rect2.left + rect2.width/2 - lineRect.left;
                
                const tieOffset = parseFloat(getComputedStyle(document.documentElement)
                    .getPropertyValue('--tie-line-offset')) || 12;
                const tieHeight = parseFloat(getComputedStyle(document.documentElement)
                    .getPropertyValue('--tie-line-height')) || 20;
                
                const y = rect1.top - lineRect.top - tieOffset;
                
                tieData.svg.style.left = Math.min(x1, x2) + 'px';
                tieData.svg.style.top = y + 'px';
                tieData.svg.style.width = Math.abs(x2 - x1) + 'px';
                tieData.svg.style.height = tieHeight + 'px';
                
                const path = tieData.svg.querySelector('path');
                if (path) {
                    const d = `M 0 ${tieHeight * 0.75} Q ${Math.abs(x2 - x1)/2} ${tieHeight * 0.25}, ${Math.abs(x2 - x1)} ${tieHeight * 0.75}`;
                    path.setAttribute('d', d);
                }
                
                return true;
            });
        }
        
        // 初始化音符选择
        function initNoteSelection() {
            document.addEventListener('click', function(e) {
                const noteGroup = e.target.closest('.note-group');
                
                if (noteGroup) {
                    if (tieMode) {
                        if (handleTieSelection(noteGroup)) {
                            return;
                        }
                    }
                    
                    document.querySelectorAll('.note-group.selected').forEach(n => {
                        n.classList.remove('selected');
                    });
                    
                    noteGroup.classList.add('selected');
                    selectedNote = noteGroup;
                    
                    const voiceLine = noteGroup.closest('.voice-line');
                    if (voiceLine) {
                        currentInsertPosition = voiceLine;
                    }
                } else if (!e.target.closest('.spacing-btn') && 
                          !e.target.closest('.other-btn') && 
                          !e.target.closest('.line-spacing-btn') &&
                          !e.target.closest('.global-spacing-btn')) {
                    document.querySelectorAll('.note-group.selected').forEach(n => {
                        n.classList.remove('selected');
                    });
                    selectedNote = null;
                    
                    if (tieMode && !e.target.closest('.tie-selectable')) {
                        exitTieMode();
                    }
                }
            });
        }
        
        // 调整选中音符的间距
        function adjustSelectedSpacing(direction) {
            if (!selectedNote) {
                alert('请先点击选择一个音符');
                return;
            }
            
            const currentMargin = parseInt(selectedNote.style.marginLeft || 0);
            selectedNote.style.marginLeft = Math.max(-10, Math.min(10, currentMargin + direction * 2)) + 'px';
        }

        // 检查页面溢出
        function checkPageOverflow() {
            const currentPageElement = document.getElementById(`page-${currentPage}`);
            const scoreContent = currentPageElement.querySelector('.score-content');
            
            const maxHeight = 257 * 3.78;
            
            if (scoreContent.scrollHeight > maxHeight) {
                createNewPage();
            }
        }
        
        // 创建新页 - 修复版本：第二页起不显示标题和信息
        function createNewPage() {
            currentPage++;
            const container = document.getElementById('scoreContainer');
            
            const newPageHtml = `
                <div class="score-page" id="page-${currentPage}" data-page="${currentPage}">
                    <h1 class="score-title" style="display:none;"></h1>
                    <div class="score-info" style="display:none;"></div>
                    <div class="score-content" style="padding-top: 0;">
                        <div id="scoreLines"></div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newPageHtml);
        }
        
        // 手动添加新页
        function newPage() {
            createNewPage();
            newLine();
        }
        
        // 删除页
        function deletePage() {
            const allPages = document.querySelectorAll('.score-page');
            
            if (allPages.length <= 1) {
                alert('不能删除最后一页');
                return;
            }
            
            if (!confirm('确定要删除当前页吗？')) return;
            
            const currentPageElement = document.getElementById(`page-${currentPage}`);
            currentPageElement.remove();
            currentPage--;
            renumberPages();
        }

        // 重新编号页面
        function renumberPages() {
            const allPages = document.querySelectorAll('.score-page');
            allPages.forEach((page, index) => {
                const newPageNum = index + 1;
                page.id = `page-${newPageNum}`;
                page.dataset.page = newPageNum;
                
                const indicator = page.querySelector('.page-indicator');
                if (indicator) {
                    indicator.remove();
                }
            });
        }
        
        // 重新编号行
        function renumberLines() {
            let globalLineNumber = 1;
            document.querySelectorAll('.score-line').forEach(line => {
                line.dataset.line = globalLineNumber;
                globalLineNumber++;
            });
            currentLine = globalLineNumber - 1;
        }
        
        // 更新标题
        function updateTitle() {
            const title = document.getElementById('title').value;
            document.querySelectorAll('.score-title').forEach(titleElement => {
                titleElement.textContent = title || '未命名乐谱';
            });
        }
        
        // 初始化背景点击事件
        function initBackgroundClick() {
            document.getElementById('scoreContainer').addEventListener('click', function(e) {
                if (e.target === this || e.target.classList.contains('score-page') || 
                    e.target.classList.contains('score-content')) {
                    clearActiveLineAndCursor();
                }
            });
            
            document.querySelector('.editor-area').addEventListener('click', function(e) {
                if (e.target === this) {
                    clearActiveLineAndCursor();
                }
            });
        }
        
        // 清除活动行高亮和光标
        function clearActiveLineAndCursor() {
            document.querySelectorAll('.score-line').forEach(line => {
                line.classList.remove('active');
                line.classList.remove('selected-for-spacing');
            });
            
            document.querySelectorAll('.voice-line').forEach(voice => {
                voice.classList.remove('active');
            });
            
            document.querySelectorAll('.cursor').forEach(cursor => {
                cursor.style.display = 'none';
            });
            
            document.querySelectorAll('.note-group.selected').forEach(n => {
                n.classList.remove('selected');
            });
            
            selectedNote = null;
            currentInsertPosition = null;
            selectedLineForSpacing = null;
            
            if (tieMode) {
                exitTieMode();
            }
        }
        
        // 调整面板缩放
        function adjustPanelZoom(delta) {
            panelZoom = Math.max(50, Math.min(200, panelZoom + delta));
            const controlPanel = document.getElementById('controlPanel');
            controlPanel.style.transform = `scale(${panelZoom / 100})`;
            controlPanel.style.transformOrigin = 'top left';
            document.getElementById('panelZoomDisplay').textContent = panelZoom + '%';
            
            const baseWidth = 240;
            controlPanel.style.width = (baseWidth * 100 / panelZoom) + 'px';
        }

        // 初始化拖动分隔条
        function initResizeHandle() {
            const resizeHandle = document.getElementById('resizeHandle');
            const controlPanel = document.querySelector('.control-panel');
            
            if (!resizeHandle) return;
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            resizeHandle.addEventListener('mousedown', initResize);
            resizeHandle.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                initResize({clientX: touch.clientX});
            });
            
            function initResize(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = controlPanel.offsetWidth;
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchmove', touchResize);
                document.addEventListener('touchend', stopResize);
                
                document.body.style.userSelect = 'none';
            }
            
            function resize(e) {
                if (!isResizing) return;
                
                const newWidth = startWidth + (e.clientX - startX);
                if (newWidth > 150 && newWidth < window.innerWidth * 0.7) {
                    controlPanel.style.width = newWidth + 'px';
                }
            }
            
            function touchResize(e) {
                if (!isResizing) return;
                const touch = e.touches[0];
                resize({clientX: touch.clientX});
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                document.removeEventListener('touchmove', touchResize);
                document.removeEventListener('touchend', stopResize);
                document.body.style.userSelect = '';
            }
        }
        
        // 添加触摸支持
        function initTouchSupport() {
            document.querySelectorAll('.arrow-btn, .duration-btn, .modifier-btn, .other-btn').forEach(btn => {
                btn.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                btn.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
        }
        
        // 保存乐谱
        function saveScore() {
            const data = {
                title: document.getElementById('title').value,
                scoreInfo: document.getElementById('scoreInfo').value,
                tempo: document.getElementById('tempo').value,
                fontSize: fontSize,
                globalSpacing: globalSpacing,
                pages: []
            };
            
            document.querySelectorAll('.score-page').forEach(page => {
                const pageData = {
                    lines: []
                };
                
                page.querySelectorAll('.score-line').forEach(line => {
                    const lineData = {
                        html: line.innerHTML,
                        isCentered: line.classList.contains('centered'),
                        isTwoVoice: line.classList.contains('two-voice'),
                        marginBottom: line.style.marginBottom || '20px'
                    };
                    pageData.lines.push(lineData);
                });
                
                data.pages.push(pageData);
            });
            
            localStorage.setItem('arrowScore', JSON.stringify(data));
            showCopyIndicator('保存成功！');
        }
        
        // 加载乐谱
        function loadScore() {
            const saved = localStorage.getItem('arrowScore');
            if (!saved) {
                alert('没有保存的乐谱');
                return;
            }
            
            const data = JSON.parse(saved);
            document.getElementById('title').value = data.title;
            document.getElementById('tempo').value = data.tempo;
            updateFontSize(data.fontSize);
            
            if (data.globalSpacing !== undefined) {
                globalSpacing = data.globalSpacing;
                document.documentElement.style.setProperty('--global-spacing', globalSpacing + 'px');
                document.getElementById('globalSpacingValue').textContent = globalSpacing + 'px';
            }
            
            updateTitle();
            
            // 重建页面结构
            const container = document.getElementById('scoreContainer');
            container.innerHTML = '';
            
            data.pages.forEach((pageData, pageIndex) => {
                const pageNum = pageIndex + 1;
                const scoreInfo = pageIndex === 0 ? data.scoreInfo : '';
                
                const pageHtml = `
                    <div class="score-page" id="page-${pageNum}" data-page="${pageNum}">
                        <h1 class="score-title">${data.title || '未命名乐谱'}</h1>
                        <div class="score-info">
                            <input type="text" id="${pageIndex === 0 ? 'scoreInfo' : ''}" 
                                   placeholder="调号：C大调  拍号：4/4  速度：Andante" 
                                   value="${scoreInfo}" />
                        </div>
                        <div class="score-content">
                            <div id="scoreLines"></div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', pageHtml);
                
                const pageElement = document.getElementById(`page-${pageNum}`);
                const scoreLines = pageElement.querySelector('#scoreLines');
                
                pageData.lines.forEach(lineData => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'score-line';
                    if (lineData.isCentered) lineDiv.classList.add('centered');
                    if (lineData.isTwoVoice) lineDiv.classList.add('two-voice');
                    if (lineData.marginBottom) lineDiv.style.marginBottom = lineData.marginBottom;
                    lineDiv.innerHTML = lineData.html;
                    scoreLines.appendChild(lineDiv);
                });
            });
            
            showCopyIndicator('加载成功！');
        }

        // 恢复连音线的函数
        function restoreTieLines(tieData) {
            tieLinesData = [];
            document.querySelectorAll('.tie-line-svg').forEach(svg => svg.remove());
            
            tieData.forEach(tie => {
                const note1 = document.querySelector(`[data-note-id="${tie.note1Id}"]`);
                const note2 = document.querySelector(`[data-note-id="${tie.note2Id}"]`);
                
                if (note1 && note2) {
                    createTieLine(note1, note2);
                }
            });
        }
        
        // 导出乐谱
        function exportScore() {
            saveScore();
            const data = localStorage.getItem('arrowScore');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (document.getElementById('title').value || '未命名乐谱') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 导入乐谱
        function importScore() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            localStorage.setItem('arrowScore', JSON.stringify(data));
                            loadScore();
                        } catch (error) {
                            alert('文件格式错误，无法导入');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // 打印乐谱
        function printScore() {
            window.print();
        }
        
        // 导出为PDF（提示功能）
        function exportAsPDF() {
            const confirmed = confirm('PDF导出需要使用打印功能。\n点击确定后，选择"另存为PDF"即可。\n\n确定继续吗？');
            if (confirmed) {
                window.print();
            }
        }
        
        // 备用导出方法 - 使用Canvas直接绘制
        async function exportAsImageAlternative() {
            const progress = document.getElementById('exportProgress');
            const progressText = document.getElementById('exportProgressText');
            
            try {
                progress.classList.add('show');
                progressText.textContent = '使用备用方法导出中...';
                
                const pages = document.querySelectorAll('.score-page');
                const title = document.getElementById('title').value || '未命名乐谱';
                
                for (let i = 0; i < pages.length; i++) {
                    progressText.textContent = `正在处理第 ${i + 1}/${pages.length} 页...`;
                    
                    const page = pages[i];
                    
                    // 创建高分辨率Canvas
                    const scale = 3;
                    const width = page.offsetWidth * scale;
                    const height = page.offsetHeight * scale;
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    
                    // 设置白色背景
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);
                    
                    // 尝试使用SVG foreignObject方法
                    const data = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
                            <foreignObject width="100%" height="100%">
                                <div xmlns="http://www.w3.org/1999/xhtml" style="transform: scale(${scale}); transform-origin: top left;">
                                    ${page.innerHTML}
                                </div>
                            </foreignObject>
                        </svg>
                    `;
                    
                    const img = new Image();
                    const svg = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
                    const url = URL.createObjectURL(svg);
                    
                    await new Promise((resolve, reject) => {
                        img.onload = function() {
                            ctx.drawImage(img, 0, 0);
                            URL.revokeObjectURL(url);
                            
                            canvas.toBlob(function(blob) {
                                const dlUrl = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = dlUrl;
                                a.download = pages.length > 1 ? 
                                    `${title}_第${i + 1}页.png` : 
                                    `${title}.png`;
                                a.click();
                                URL.revokeObjectURL(dlUrl);
                            }, 'image/png', 0.95);
                            
                            resolve();
                        };
                        
                        img.onerror = reject;
                        img.src = url;
                    }).catch(() => {
                        // 如果SVG方法失败，回退到html2canvas
                        console.log('SVG方法失败，使用html2canvas');
                        return exportAsImage();
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                progressText.textContent = '导出完成！';
                setTimeout(() => {
                    progress.classList.remove('show');
                }, 2000);
                
            } catch (error) {
                console.error('备用方法失败，尝试主方法:', error);
                // 回退到主方法
                exportAsImage();
            }
        }
        
        // 窗口大小改变时更新连音线位置
        window.addEventListener('resize', () => {
            updateTieLinePositions();
        });
        
        // 防止组合键卡住
        window.addEventListener('blur', function() {
            modifierKeys = {
                q: false,
                e: false,
                a: false,
                d: false
            };
            smartBeamMode = false;
            smartBeamCounter = 0;
        });
    </script>
</body>
</html>
