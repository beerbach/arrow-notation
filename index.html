<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ç®­å¤´è°±ä¸“ä¸šç¼–è¾‘å™¨ v4.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #e0e0e0;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* SVGç®­å¤´æ ·å¼ */
        .arrow-svg {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .arrow-svg.small {
            width: 16px;
            height: 16px;
        }
        
        .arrow-svg.large {
            width: var(--arrow-size, 24px);
            height: var(--arrow-size, 24px);
        }
        
        /* å·¦ä¾§æ§åˆ¶é¢æ¿ - æ›´ç´§å‡‘ */
        .control-panel {
            width: 280px;
            background: white;
            border-right: 2px solid #ddd;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 10px;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 100;
        }
        
        /* é¢æ¿ç¼©æ”¾æ§åˆ¶æŒ‰é’® */
        .panel-zoom-controls {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding: 5px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 10px;
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn {
            padding: 5px 10px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .zoom-btn:hover {
            background: #357abd;
        }
        
        .zoom-display {
            font-size: 12px;
            padding: 0 10px;
            min-width: 50px;
            text-align: center;
        }
        
        /* å¯æ‹–åŠ¨åˆ†éš”æ¡æ ·å¼ */
        .resize-handle {
            width: 5px;
            background: #999;
            cursor: col-resize;
            position: relative;
            transition: background 0.3s;
        }

        .resize-handle:hover {
            background: #4a90e2;
            width: 8px;
        }

        .resize-handle:active {
            background: #357abd;
        }
        
        .panel-section {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            padding: 3px 8px;
            background: #f5f5f5;
            border-radius: 3px;
        }
        
        /* æ—¶å€¼é€‰æ‹©åŒº - æ›´ç´§å‡‘ */
        .duration-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .duration-btn {
            padding: 6px 3px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 11px;
        }
        
        .duration-btn:hover {
            background: #f0f8ff;
            border-color: #4a90e2;
        }
        
        .duration-btn.active {
            background: #4a90e2;
            color: white;
            border-color: #357abd;
        }
        
        .duration-display {
            font-size: 16px;
            margin-bottom: 2px;
        }
        
        /* ç‰¹æ®Šæ—¶å€¼é€‰é¡¹ */
        .special-btn {
            padding: 6px 3px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            text-align: center;
        }
        
        .special-btn:hover {
            background: #fce4ec;
            border-color: #e91e63;
        }
        
        .special-btn.active {
            background: #e91e63;
            color: white;
            border-color: #c2185b;
        }
        
        /* ä¸‰è¿éŸ³çŠ¶æ€æ˜¾ç¤º */
        .triplet-status {
            margin-top: 5px;
            padding: 5px;
            background: #e8f5e9;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
            display: none;
        }
        
        .triplet-status.active {
            display: block;
        }
        
        /* é™„ç‚¹å¤é€‰æ¡† */
        .dot-checkbox {
            display: flex;
            align-items: center;
            margin-top: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .dot-checkbox input {
            margin-right: 8px;
        }
        
        /* å˜éŸ³ç¬¦å·é€‰æ‹©åŒº - æ›´ç´§å‡‘ */
        .modifier-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .modifier-btn {
            padding: 5px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            text-align: center;
        }
        
        .modifier-btn:hover {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .modifier-btn.active {
            background: #ff9800;
            color: white;
            border-color: #f57c00;
        }
        
        .modifier-example {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 1px;
        }
        
        /* ç®­å¤´éŸ³ç¬¦åŒº - æ›´ç´§å‡‘ */
        .arrow-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .arrow-btn {
            height: 50px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .arrow-btn:hover {
            background: #e8f5e9;
            border-color: #4caf50;
            transform: scale(1.05);
        }
        
        .arrow-symbol {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }
        
        .arrow-note {
            font-size: 10px;
            color: #666;
        }
        
        /* å‡æ—¶çº¿æ§åˆ¶ */
        .beam-control {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .beam-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        
        .beam-btn:hover {
            background: #f0f0f0;
        }
        
        .beam-btn.active {
            background: #2196f3;
            color: white;
        }
        
        #beamComplete {
            background: #4caf50;
            color: white;
            border-color: #45a049;
        }
        
        #beamComplete:hover {
            background: #45a049;
        }
        
        /* å…‰æ ‡æ§åˆ¶æŒ‰é’® */
        .cursor-control {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .cursor-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .cursor-btn:hover {
            background: #ffebee;
            border-color: #f44336;
        }
        
        /* é—´è·è°ƒæ•´æ§åˆ¶ - æ–°å¢ */
        .spacing-control {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .spacing-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .spacing-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        /* å…¶ä»–æ§åˆ¶æŒ‰é’® */
        .other-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        
        .other-btn {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        
        .other-btn:hover {
            background: #f0f0f0;
        }
        
        /* è¡Œè·è°ƒæ•´æ§åˆ¶ */
        .line-spacing-control {
            margin-top: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .line-spacing-control select,
        .line-spacing-control button {
            padding: 4px 8px;
            font-size: 11px;
            margin: 2px;
        }
        
        /* å³ä¾§ç¼–è¾‘åŒº */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* å·¥å…·æ  */
        .toolbar {
            height: 50px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .toolbar input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        .toolbar-btn:hover {
            background: #f0f0f0;
        }
        
        /* å­—ä½“å¤§å°æ§åˆ¶ */
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: auto;
        }
        
        .font-size-control label {
            font-size: 12px;
        }
        
        .font-size-control input {
            width: 80px;
        }
        
        /* ä¹è°±å®¹å™¨ - A4çº¸å¼ è®¾ç½® */
        .score-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* A4çº¸å¼  - 210mm x 297mm */
        .score-page {
            width: 210mm;
            min-height: 297mm;
            max-height: 297mm;
            background: white;
            margin: 0 auto 20px;
            padding: 20mm;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .score-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 13px;
            color: #333;
        }
        
        /* æ›²ç›®ä¿¡æ¯åŒºåŸŸ - æ–°å¢ */
        .score-info {
            text-align: left;
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .score-info input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            color: #666;
            outline: none;
            border-bottom: 1px dashed #ddd;
        }
        
        .score-info input:focus {
            border-bottom: 1px solid #4a90e2;
        }
        
        .score-content {
            flex: 1;
        }
        
        .score-line {
            min-height: 60px;
            margin-bottom: 20px;
            margin-top: 0;
            padding: 10px;
            border: 2px dashed #e0e0e0;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 13px;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .score-line:hover {
            background: #fafafa;
        }
        
        .score-line.active {
            border-color: #4a90e2;
            background: #f0f8ff;
        }
        
        /* éŸ³ç¬¦æ˜¾ç¤º - æ›´ç´§å‡‘çš„é—´è· */
        .note-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            font-size: var(--score-font-size, 24px);
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 -2px;
        }
        
        /* å±…ä¸­æ ·å¼ */
        .score-line.centered {
            justify-content: center;
            gap: 8px;
        }
        
        .score-line.centered .note-group,
        .score-line.centered .triplet-group,
        .score-line.centered .beam-group,
        .score-line.centered .rest,
        .score-line.centered .barline,
        .score-line.centered .repeat-sign {
            margin: 0 2px;
        }
        
        .note-group.selected {
            background: rgba(66, 165, 245, 0.2);
            border-radius: 4px;
            padding: 2px;
        }
        
        .note-content {
            display: flex;
            align-items: center;
            font-weight: bold;
            position: relative;
            gap: 0;
        }
        
        .note-annotation {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: normal;
            color: #666;
        }
        
        /* ç›’å­æ ‡æ³¨ */
        .note-box {
            position: absolute;
            top: -9px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: bold;
            color: #000000;
            border: 1px solid #cccccc;
            padding: 1px 3px;
            border-radius: 3px;
            background: #f8f8f8;
            white-space: nowrap;
        }
        
        /* ä¿®é¥°ç¬¦é—´è·è°ƒæ•´ - æ›´ç´§å‡‘ */
        .note-modifier-left {
            font-size: 0.8em;
            margin-right: -3px;
            color: #666;
        }
        
        .note-modifier-right {
            font-size: 0.8em;
            margin-left: -3px;
            color: #666;
        }
        
        .note-arrow {
            font-size: 1em;
        }
        
        .note-extend {
            font-size: 0.9em;
            color: #666;
            margin-left: 0;
        }
        
        .note-dot {
            font-size: 0.8em;
            margin-left: 1px;
        }
        
        /* è¿éŸ³çº¿ */
        .tie-symbol {
            font-size: var(--score-font-size, 24px);
            margin: 0 2px;
            color: #666;
            position: relative;
            z-index: 2;
        }
        
        /* ä¸‰è¿éŸ³ç»„ */
        .triplet-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 0 2px;
        }
        
        .triplet-bracket {
            position: absolute;
            top: -10px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .triplet-notes {
            display: flex;
            gap: 5px;
        }
        
        /* å‡æ—¶çº¿ */
        .beam-container {
            position: relative;
            height: 10px;
            margin-top: 2px;
            width: 100%;
        }
        
        .beam-line {
            position: absolute;
            height: 2px;
            background: #333;
            width: 100%;
        }
        
        .beam-line.second {
            top: 4px;
        }
        
        /* è¿æ¥çš„å‡æ—¶çº¿ç»„ */
        .beam-group {
            display: inline-flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            margin: 0 2px;
        }
        
        .beam-group .note-groups {
            display: flex;
            gap: 5px;
        }
        
        /* æ™ºèƒ½å‡æ—¶çº¿å®¹å™¨ */
        .beam-group .smart-beams {
            position: relative;
            width: 100%;
            height: 10px;
            margin-top: 2px;
        }
        
        .beam-group .connected-beam {
            position: absolute;
            height: 2px;
            background: #333;
        }
        
        .beam-group .connected-beam.first {
            top: 0;
            width: 100%;
        }
        
        .beam-group .connected-beam.second {
            top: 4px;
        }
        
        /* ç©ºæ ¼ç¬¦ - ç¼©å°ä¸ºåŸæ¥çš„1/3 */
        .spacer {
            display: inline-block;
            width: 3px;
            height: 1px;
        }
        
        /* å°èŠ‚çº¿ */
        .barline {
            width: 2px;
            height: 40px;
            background: #333;
            margin: 0 5px;
            position: relative;
            z-index: 1;
        }
        
        /* åå¤è®°å· */
        .repeat-sign {
            font-size: var(--score-font-size, 24px);
            font-weight: bold;
            margin: 0 3px;
        }
        
        /* ä¼‘æ­¢ç¬¦ */
        .rest {
            font-size: var(--score-font-size, 24px);
            color: #666;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 2px;
        }
        
        /* å…‰æ ‡ */
        .cursor {
            width: 3px;
            height: 40px;
            background: #ff4444;
            animation: blink 1s infinite;
        }
        
        .cursor.hidden {
            display: none;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        /* é¢„è§ˆ */
        .current-selection {
            font-size: 20px;
            font-weight: bold;
            padding: 8px;
            background: #e3f2fd;
            border-radius: 4px;
            margin: 5px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è¿éŸ³ç»„çŠ¶æ€æç¤º */
        .beam-status {
            margin-top: 5px;
            padding: 5px;
            background: #fff3e0;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
            display: none;
            color: #ff9800;
        }
        
        .beam-status.active {
            display: block;
        }
        
        /* è¿éŸ³çº¿æ ·å¼ */
        .tie-selectable {
            transition: all 0.2s;
        }
        
        .tie-selectable:hover {
            background: rgba(74, 144, 226, 0.1);
            border-radius: 4px;
        }
        
        .tie-first-selected {
            background: rgba(74, 144, 226, 0.3) !important;
            border-radius: 4px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                background: rgba(74, 144, 226, 0.3);
            }
            50% {
                background: rgba(74, 144, 226, 0.5);
            }
        }
        
        .tie-line-svg {
            z-index: 10;
            pointer-events: none;
        }
        
        /* é¡µé¢æŒ‡ç¤ºå™¨ */
        .page-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media screen and (max-width: 768px) {
            .container {
                overflow-x: auto;
                min-width: 100%;
            }
            
            .control-panel {
                min-width: 250px;
                max-width: 70vw;
                overflow-x: auto;
            }
            
            .editor-area {
                min-width: 300px;
                overflow-x: auto;
            }
            
            .score-page {
                width: 100%;
                min-width: 600px;
                padding: 10mm;
                transform-origin: top left;
            }
            
            .toolbar {
                overflow-x: auto;
                white-space: nowrap;
                min-width: 500px;
            }
            
            .font-size-control {
                margin-left: 10px;
            }
            
            /* ç§»åŠ¨ç«¯å­—ä½“è°ƒæ•´ */
            .arrow-btn {
                height: 45px;
                font-size: 11px;
            }
            
            .arrow-symbol {
                font-size: 18px;
            }
            
            .duration-btn, .modifier-btn {
                font-size: 10px;
                padding: 5px 2px;
            }
        }

        /* æ”¯æŒæ¨ªå‘æ»šåŠ¨ */
        .control-panel::-webkit-scrollbar,
        .editor-area::-webkit-scrollbar,
        .score-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .control-panel::-webkit-scrollbar-track,
        .editor-area::-webkit-scrollbar-track,
        .score-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .control-panel::-webkit-scrollbar-thumb,
        .editor-area::-webkit-scrollbar-thumb,
        .score-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb:hover,
        .editor-area::-webkit-scrollbar-thumb:hover,
        .score-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                background: white;
            }
            
            .container {
                display: block;
            }
            
            .control-panel,
            .toolbar,
            .resize-handle {
                display: none !important;
            }
            
            .editor-area {
                width: 100%;
            }
            
            .score-container {
                padding: 0;
                background: white;
            }
            
            .score-page {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 15mm;
                box-shadow: none;
                page-break-after: always;
            }
            
            .score-line {
                border-style: solid;
                border-width: 1px;
                border-color: #ddd;
            }
            
            .score-info input {
                border: none;
            }
            
            .page-indicator {
                display: none;
            }
        }
        
        @page {
            size: A4;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- SVGå®šä¹‰åŒº - 8ä¸ªæ–¹å‘çš„ç®­å¤´ -->
    <svg style="display: none;">
        <defs>
            <!-- å³ç®­å¤´ â†’ -->
            <symbol id="arrow-right" viewBox="0 0 100 100">
                <path d="M10,50 L70,50 M50,30 L70,50 L50,70" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            
            <!-- å³ä¸Šç®­å¤´ â†— -->
            <symbol id="arrow-right-up" viewBox="0 0 100 100">
                <path d="M20,80 L70,30 M50,30 L70,30 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            
            <!-- ä¸Šç®­å¤´ â†‘ -->
            <symbol id="arrow-up" viewBox="0 0 100 100">
                <path d="M50,90 L50,30 M30,50 L50,30 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            
            <!-- å³ä¸‹ç®­å¤´ â†˜ -->
            <symbol id="arrow-right-down" viewBox="0 0 100 100">
                <path d="M20,20 L70,70 M50,70 L70,70 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            
            <!-- ä¸‹ç®­å¤´ â†“ -->
            <symbol id="arrow-down" viewBox="0 0 100 100">
                <path d="M50,10 L50,70 M30,50 L50,70 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            
            <!-- å·¦ä¸‹ç®­å¤´ â†™ -->
            <symbol id="arrow-left-down" viewBox="0 0 100 100">
                <path d="M80,20 L30,70 M30,50 L30,70 L50,70" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            
            <!-- å·¦ç®­å¤´ â† -->
            <symbol id="arrow-left" viewBox="0 0 100 100">
                <path d="M90,50 L30,50 M50,30 L30,50 L50,70" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            
            <!-- å·¦ä¸Šç®­å¤´ â†– -->
            <symbol id="arrow-left-up" viewBox="0 0 100 100">
                <path d="M80,80 L30,30 M30,50 L30,30 L50,30" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
        </defs>
    </svg>
    
    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="control-panel" id="controlPanel">
            <!-- é¢æ¿ç¼©æ”¾æ§åˆ¶ -->
            <div class="panel-zoom-controls">
                <button class="zoom-btn" onclick="adjustPanelZoom(-10)">-</button>
                <span class="zoom-display" id="panelZoomDisplay">100%</span>
                <button class="zoom-btn" onclick="adjustPanelZoom(10)">+</button>
            </div>
            
            <!-- å½“å‰é€‰æ‹©é¢„è§ˆ -->
            <div class="panel-section">
                <div class="section-title">å½“å‰é€‰æ‹©é¢„è§ˆ</div>
                <div class="current-selection" id="currentPreview">è¯·é€‰æ‹©éŸ³ç¬¦</div>
            </div>
            
            <!-- æ—¶å€¼é€‰æ‹© -->
            <div class="panel-section">
                <div class="section-title">1ï¸âƒ£ æ—¶å€¼é€‰æ‹©</div>
                <div class="duration-grid">
                    <button class="duration-btn active" data-duration="quarter">
                        <div class="duration-display">â™©</div>
                        <div>å››åˆ†</div>
                    </button>
                    <button class="duration-btn" data-duration="eighth">
                        <div class="duration-display">â™ª</div>
                        <div>å…«åˆ†</div>
                    </button>
                    <button class="duration-btn" data-duration="sixteenth">
                        <div class="duration-display">â™¬</div>
                        <div>åå…­åˆ†</div>
                    </button>
                    <button class="duration-btn" data-duration="half">
                        <div class="duration-display">ğ…—ğ…¥</div>
                        <div>äºŒåˆ†</div>
                    </button>
                    <button class="duration-btn" data-duration="whole">
                        <div class="duration-display">ğ…</div>
                        <div>å…¨éŸ³ç¬¦</div>
                    </button>
                    <button class="duration-btn special-btn" id="tripletBtn" data-duration="triplet">
                        <div class="duration-display">âŒ’3âŒ’</div>
                        <div>ä¸‰è¿éŸ³</div>
                    </button>
                </div>
                
                <div class="triplet-status" id="tripletStatus">
                    ä¸‰è¿éŸ³æ¨¡å¼: <span id="tripletCount">0</span>/3
                </div>
                
                <div class="dot-checkbox">
                    <input type="checkbox" id="dotted" onchange="updateDotted()">
                    <label for="dotted">é™„ç‚¹ï¼ˆå»¶é•¿ä¸€åŠæ—¶å€¼ï¼‰</label>
                </div>
                
                <div class="beam-control">
                    <button class="beam-btn" id="beamConnect">è¿æ¥å‡æ—¶çº¿</button>
                    <button class="beam-btn active" id="beamSeparate">æ–­å¼€å‡æ—¶çº¿</button>
                </div>
                <button class="beam-btn" id="beamComplete" style="display:none; width: 100%; margin-top: 5px;">å®Œæˆè¿éŸ³ç»„</button>
                
                <div class="beam-status" id="beamStatus">
                    è¿éŸ³ç»„: <span id="beamCount">0</span>ä¸ªéŸ³ç¬¦
                </div>
                
                <div class="cursor-control">
                    <button class="cursor-btn" onclick="moveCursor('left')">â†</button>
                    <button class="cursor-btn" onclick="moveCursor('right')">â†’</button>
                </div>
                
                <!-- æ–°å¢ï¼šé—´è·è°ƒæ•´æ§åˆ¶ -->
                <div class="spacing-control">
                    <button class="spacing-btn" onclick="adjustSelectedSpacing(-1)">â† ç¼©è¿›</button>
                    <button class="spacing-btn" onclick="adjustSelectedSpacing(1)">æ‰©å±• â†’</button>
                </div>
            </div>
            
            <!-- å˜éŸ³é€‰æ‹© -->
            <div class="panel-section">
                <div class="section-title">2ï¸âƒ£ å˜éŸ³é€‰æ‹©ï¼ˆå¯é€‰ï¼‰</div>
                <div class="modifier-grid">
                    <button class="modifier-btn active" data-modifier="none">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>æ ‡å‡†</div>
                    </button>
                    <button class="modifier-btn" data-modifier="octave-down">
                        <div class="modifier-example">
                            -<svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>é™å…«åº¦</div>
                    </button>
                    <button class="modifier-btn" data-modifier="octave-up">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>-
                        </div>
                        <div>å‡å…«åº¦</div>
                    </button>
                    <button class="modifier-btn" data-modifier="flat">
                        <div class="modifier-example">
                            _<svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>é™åŠéŸ³â™­</div>
                    </button>
                    <button class="modifier-btn" data-modifier="sharp">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>_
                        </div>
                        <div>å‡åŠéŸ³#</div>
                    </button>
                    <button class="modifier-btn" data-modifier="down-down">
                        <div class="modifier-example">
                            =<svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>é™å…«é™åŠ</div>
                    </button>
                    <button class="modifier-btn" data-modifier="up-up">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>=
                        </div>
                        <div>å‡å…«å‡åŠ</div>
                    </button>
                    <button class="modifier-btn" data-modifier="down-up">
                        <div class="modifier-example">
                            -<svg class="arrow-svg small"><use href="#arrow-up"/></svg>_
                        </div>
                        <div>é™å…«å‡åŠ</div>
                    </button>
                    <button class="modifier-btn" data-modifier="up-down">
                        <div class="modifier-example">
                            _<svg class="arrow-svg small"><use href="#arrow-up"/></svg>-
                        </div>
                        <div>å‡å…«é™åŠ</div>
                    </button>
                </div>
            </div>
            
            <!-- éŸ³ç¬¦é€‰æ‹© -->
            <div class="panel-section">
                <div class="section-title">3ï¸âƒ£ éŸ³ç¬¦é€‰æ‹©ï¼ˆç‚¹å‡»è¾“å…¥ï¼‰</div>
                <div class="arrow-grid">
                    <button class="arrow-btn" data-arrow="up" data-note="1" data-svg="arrow-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-up"/></svg>
                        </span>
                        <span class="arrow-note">1 do</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right-up" data-note="2" data-svg="arrow-right-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right-up"/></svg>
                        </span>
                        <span class="arrow-note">2 re</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right" data-note="3" data-svg="arrow-right">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right"/></svg>
                        </span>
                        <span class="arrow-note">3 mi</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right-down" data-note="4" data-svg="arrow-right-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right-down"/></svg>
                        </span>
                        <span class="arrow-note">4 fa</span>
                    </button>
                    <button class="arrow-btn" data-arrow="down" data-note="5" data-svg="arrow-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-down"/></svg>
                        </span>
                        <span class="arrow-note">5 sol</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left-down" data-note="6" data-svg="arrow-left-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left-down"/></svg>
                        </span>
                        <span class="arrow-note">6 la</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left" data-note="7" data-svg="arrow-left">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left"/></svg>
                        </span>
                        <span class="arrow-note">7 si</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left-up" data-note="1'" data-svg="arrow-left-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left-up"/></svg>
                        </span>
                        <span class="arrow-note">é«˜1do</span>
                    </button>
                    <button class="arrow-btn" data-arrow="â—‹" data-note="0">
                        <span class="arrow-symbol">â—‹</span>
                        <span class="arrow-note">0 ä¼‘æ­¢</span>
                    </button>
                </div>
            </div>
            
            <!-- å…¶ä»–åŠŸèƒ½ -->
            <div class="panel-section">
                <div class="section-title">å…¶ä»–åŠŸèƒ½</div>
                <div class="other-controls">
                    <button class="other-btn" onclick="insertTie()">âŒ’ è¿éŸ³çº¿æ¨¡å¼</button>
                    <button class="other-btn" onclick="insertSpacer()">âµ ç©ºæ ¼</button>
                    <button class="other-btn" onclick="centerLine()">âŠ¡ å±…ä¸­å¯¹é½</button>
                    <button class="other-btn" onclick="insertAnnotation('R')">R æ ‡æ³¨</button>
                    <button class="other-btn" onclick="insertAnnotation('L')">L æ ‡æ³¨</button>
                    <button class="other-btn" onclick="insertBox('ç›’1')">ç›’1 æ ‡æ³¨</button>
                    <button class="other-btn" onclick="insertBox('ç›’2')">ç›’2 æ ‡æ³¨</button>
                    <button class="other-btn" onclick="insertBarline()">| å°èŠ‚çº¿</button>
                    <button class="other-btn" onclick="insertDoubleBar()">|| ç»ˆæ­¢çº¿</button>
                    <button class="other-btn" onclick="insertRepeat(':|')">:| å‰åå¤</button>
                    <button class="other-btn" onclick="insertRepeat('|:')">|: ååå¤</button>
                    <button class="other-btn" onclick="deleteLast()">åˆ é™¤</button>
                    <button class="other-btn" onclick="clearLine()">æ¸…ç©ºè¡Œ</button>
                    <button class="other-btn" onclick="deleteLine()">åˆ é™¤è¡Œ</button>
                    <button class="other-btn" onclick="newLine()">æ–°è¡Œ</button>
                    <button class="other-btn" onclick="newPage()">æ–°é¡µ</button>
                    <button class="other-btn" onclick="deletePage()">åˆ é™¤é¡µ</button>
                    <button class="other-btn" onclick="toggleMobileView()" id="mobileToggle">ğŸ“± éšè—é¢æ¿</button>
                </div>
                
                <!-- è¡Œè·è°ƒæ•´ -->
                <div class="line-spacing-control">
                    <div class="section-title">è¡Œè·è°ƒæ•´</div>
                    <select id="lineSelect">
                        <option value="1-1">ç¬¬1é¡µ-ç¬¬1è¡Œ</option>
                    </select>
                    <button onclick="adjustLineSpacing('top', -5)">â†‘å‡å°‘ä¸Šè·</button>
                    <button onclick="adjustLineSpacing('top', 5)">â†“å¢åŠ ä¸Šè·</button>
                    <button onclick="adjustLineSpacing('bottom', -5)">â†‘å‡å°‘ä¸‹è·</button>
                    <button onclick="adjustLineSpacing('bottom', 5)">â†“å¢åŠ ä¸‹è·</button>
                </div>
            </div>
        </div>
        
        <!-- å¯æ‹–åŠ¨åˆ†éš”æ¡ -->
        <div class="resize-handle" id="resizeHandle"></div>
        
        <!-- å³ä¾§ç¼–è¾‘åŒº -->
        <div class="editor-area">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <input type="text" id="title" placeholder="è¾“å…¥æ›²å" oninput="updateTitle()">
                <select id="tempo">
                    <option value="60">â™©=60</option>
                    <option value="80">â™©=80</option>
                    <option value="100">â™©=100</option>
                    <option value="120" selected>â™©=120</option>
                    <option value="140">â™©=140</option>
                </select>
                <button class="toolbar-btn" onclick="saveScore()">ä¿å­˜</button>
                <button class="toolbar-btn" onclick="loadScore()">åŠ è½½</button>
                <button class="toolbar-btn" onclick="exportScore()">å¯¼å‡º</button>
                <button class="toolbar-btn" onclick="printScore()">æ‰“å°</button>
                
                <div class="font-size-control">
                    <label>å­—ä½“å¤§å°:</label>
                    <input type="range" id="fontSize" min="16" max="40" value="24" oninput="updateFontSize(this.value)">
                    <span id="fontSizeValue">24px</span>
                </div>
            </div>
            
            <!-- ä¹è°±ç¼–è¾‘åŒº -->
            <div class="score-container" id="scoreContainer">
                <div class="score-page" id="page-1" data-page="1">
                    <h1 class="score-title" id="scoreTitle">æœªå‘½åä¹è°±</h1>
                    <div class="score-info">
                        <input type="text" id="scoreInfo" placeholder="è°ƒå·ï¼šCå¤§è°ƒ  æ‹å·ï¼š4/4  é€Ÿåº¦ï¼šAndante" />
                    </div>
                    <div class="score-content">
                        <div id="scoreLines">
                            <div class="score-line active" data-line="1" data-page="1">
                                <div class="cursor"></div>
                            </div>
                        </div>
                    </div>
                    <div class="page-indicator">ç¬¬ 1 é¡µ</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€çŠ¶æ€
        let currentDuration = 'quarter';
        let currentModifier = 'none';
        let isDotted = false;
        let beamMode = 'separate';
        let currentLine = 1;
        let currentPage = 1;
        let beamGroup = [];
        let fontSize = 24;
        let lastNote = null;
        let isTripletMode = false;
        let tripletGroup = [];
        let pendingAnnotation = null;
        let pendingBox = null;
        let selectedNote = null;
        let tieMode = false;
        let firstTieNote = null;
        let tieLinesData = [];
        let panelZoom = 100; // é¢æ¿ç¼©æ”¾æ¯”ä¾‹
        
        // ç®­å¤´SVGæ˜ å°„
        const arrowSvgMap = {
            'right': 'arrow-right',
            'right-up': 'arrow-right-up',
            'up': 'arrow-up',
            'right-down': 'arrow-right-down',
            'down': 'arrow-down',
            'left-down': 'arrow-left-down',
            'left': 'arrow-left',
            'left-up': 'arrow-left-up'
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initDurationButtons();
            initModifierButtons();
            initArrowButtons();
            initBeamControl();
            initKeyboardShortcuts();
            initLineClickHandlers();
            initNoteSelection();
            initResizeHandle();
            initTouchSupport();
            initBackgroundClick();
            updatePreview();
            document.documentElement.style.setProperty('--arrow-size', '24px');
        });
        
        // åˆå§‹åŒ–èƒŒæ™¯ç‚¹å‡»äº‹ä»¶
        function initBackgroundClick() {
            // ç‚¹å‡»ä¹è°±å®¹å™¨çš„ç©ºç™½åŒºåŸŸ
            document.getElementById('scoreContainer').addEventListener('click', function(e) {
                if (e.target === this || e.target.classList.contains('score-page') || 
                    e.target.classList.contains('score-content')) {
                    clearActiveLineAndCursor();
                }
            });
            
            // ç‚¹å‡»ç¼–è¾‘åŒºåŸŸçš„ç©ºç™½å¤„
            document.querySelector('.editor-area').addEventListener('click', function(e) {
                if (e.target === this) {
                    clearActiveLineAndCursor();
                }
            });
        }
        
        // æ¸…é™¤æ´»åŠ¨è¡Œé«˜äº®å’Œå…‰æ ‡
        function clearActiveLineAndCursor() {
            // ç§»é™¤æ‰€æœ‰è¡Œçš„é«˜äº®
            document.querySelectorAll('.score-line').forEach(line => {
                line.classList.remove('active');
            });
            
            // éšè—æ‰€æœ‰å…‰æ ‡
            document.querySelectorAll('.cursor').forEach(cursor => {
                cursor.classList.add('hidden');
            });
            
            // æ¸…é™¤é€‰ä¸­çš„éŸ³ç¬¦
            document.querySelectorAll('.note-group.selected').forEach(n => {
                n.classList.remove('selected');
            });
            selectedNote = null;
            
            // é€€å‡ºè¿éŸ³çº¿æ¨¡å¼ï¼ˆå¦‚æœå¤„äºè¯¥æ¨¡å¼ï¼‰
            if (tieMode) {
                exitTieMode();
            }
        }
        
        // è°ƒæ•´é¢æ¿ç¼©æ”¾
        function adjustPanelZoom(delta) {
            panelZoom = Math.max(50, Math.min(200, panelZoom + delta));
            const controlPanel = document.getElementById('controlPanel');
            controlPanel.style.transform = `scale(${panelZoom / 100})`;
            controlPanel.style.transformOrigin = 'top left';
            document.getElementById('panelZoomDisplay').textContent = panelZoom + '%';
            
            // è°ƒæ•´é¢æ¿å®½åº¦ä»¥é€‚åº”ç¼©æ”¾
            const baseWidth = 280;
            controlPanel.style.width = (baseWidth * 100 / panelZoom) + 'px';
        }
        
        // æ›´æ–°è¿éŸ³çº¿ä½ç½®
        function updateTieLinePositions() {
            tieLinesData.forEach(tieData => {
                const { note1, note2, svg, line } = tieData;
                
                // æ£€æŸ¥éŸ³ç¬¦æ˜¯å¦è¿˜å­˜åœ¨
                if (!document.contains(note1) || !document.contains(note2)) {
                    svg.remove();
                    return;
                }
                
                const rect1 = note1.getBoundingClientRect();
                const rect2 = note2.getBoundingClientRect();
                const lineRect = line.getBoundingClientRect();
                
                const x1 = rect1.left + rect1.width/2 - lineRect.left;
                const x2 = rect2.left + rect2.width/2 - lineRect.left;
                const y = rect1.top - lineRect.top - 15;
                
                svg.style.left = Math.min(x1, x2) + 'px';
                svg.style.top = y + 'px';
                svg.style.width = Math.abs(x2 - x1) + 'px';
                
                const path = svg.querySelector('path');
                const startX = x1 < x2 ? 0 : Math.abs(x2 - x1);
                const endX = x1 < x2 ? Math.abs(x2 - x1) : 0;
                const midX = Math.abs(endX - startX) / 2;
                const d = `M ${startX} 15 Q ${midX} 5, ${endX} 15`;
                path.setAttribute('d', d);
            });
            
            // æ¸…ç†æ— æ•ˆçš„è¿éŸ³çº¿
            tieLinesData = tieLinesData.filter(tieData => {
                if (!document.contains(tieData.note1) || !document.contains(tieData.note2)) {
                    tieData.svg.remove();
                    return false;
                }
                return true;
            });
        }
        
        // ä¿®æ”¹å­—ä½“å¤§å°æ›´æ–°å‡½æ•°
        function updateFontSize(size) {
            fontSize = size;
            document.getElementById('fontSizeValue').textContent = size + 'px';
            document.documentElement.style.setProperty('--score-font-size', size + 'px');
            document.documentElement.style.setProperty('--arrow-size', size + 'px');
            
            // æ›´æ–°è¿éŸ³çº¿ä½ç½®
            setTimeout(() => {
                updateTieLinePositions();
            }, 10);
        }

        // åˆå§‹åŒ–å¯æ‹–åŠ¨åˆ†éš”æ¡
        function initResizeHandle() {
            const resizeHandle = document.getElementById('resizeHandle');
            const controlPanel = document.querySelector('.control-panel');
            const container = document.querySelector('.container');
            
            if (!resizeHandle) return;
            
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            // é¼ æ ‡äº‹ä»¶
            resizeHandle.addEventListener('mousedown', initResize);
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
            resizeHandle.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                initResize({clientX: touch.clientX});
            });
            
            function initResize(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = controlPanel.offsetWidth;
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchmove', touchResize);
                document.addEventListener('touchend', stopResize);
                
                // é˜²æ­¢é€‰ä¸­æ–‡æœ¬
                document.body.style.userSelect = 'none';
            }
            
            function resize(e) {
                if (!isResizing) return;
                
                const newWidth = startWidth + (e.clientX - startX);
                if (newWidth > 150 && newWidth < window.innerWidth * 0.7) {
                    controlPanel.style.width = newWidth + 'px';
                }
            }
            
            function touchResize(e) {
                if (!isResizing) return;
                const touch = e.touches[0];
                resize({clientX: touch.clientX});
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                document.removeEventListener('touchmove', touchResize);
                document.removeEventListener('touchend', stopResize);
                document.body.style.userSelect = '';
            }
        }

        // æ·»åŠ è§¦æ‘¸æ”¯æŒ
        function initTouchSupport() {
            // ä¸ºç®­å¤´æŒ‰é’®æ·»åŠ è§¦æ‘¸åé¦ˆ
            document.querySelectorAll('.arrow-btn, .duration-btn, .modifier-btn, .other-btn').forEach(btn => {
                btn.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                btn.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
            
            // æ”¹å–„ç§»åŠ¨ç«¯æ»šåŠ¨æ€§èƒ½
            const scrollElements = ['.control-panel', '.editor-area', '.score-container'];
            scrollElements.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    element.style.webkitOverflowScrolling = 'touch';
                    element.style.overflowScrolling = 'touch';
                }
            });
            
            // åŒæŒ‡ç¼©æ”¾ä¹è°±
            let initialDistance = 0;
            let currentScale = 1;
            
            const scoreContainer = document.getElementById('scoreContainer');
            
            scoreContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                }
            });
            
            scoreContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = currentDistance / initialDistance;
                    
                    currentScale = Math.min(Math.max(0.5, currentScale * scale), 2);
                    
                    document.querySelectorAll('.score-page').forEach(page => {
                        page.style.transform = `scale(${currentScale})`;
                    });
                    
                    initialDistance = currentDistance;
                }
            });
            
            function getDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        }

        // ç§»åŠ¨è§†å›¾åˆ‡æ¢
        function toggleMobileView() {
            const container = document.querySelector('.container');
            const controlPanel = document.querySelector('.control-panel');
            const resizeHandle = document.getElementById('resizeHandle');
            
            if (controlPanel.style.display === 'none') {
                controlPanel.style.display = 'block';
                resizeHandle.style.display = 'block';
                document.getElementById('mobileToggle').textContent = 'ğŸ“± éšè—é¢æ¿';
            } else {
                controlPanel.style.display = 'none';
                resizeHandle.style.display = 'none';
                document.getElementById('mobileToggle').textContent = 'ğŸ“± æ˜¾ç¤ºé¢æ¿';
            }
        }
        
        // æ£€æŸ¥å½“å‰é¡µæ˜¯å¦éœ€è¦æ–°é¡µ
        function checkPageOverflow() {
            const currentPageElement = document.getElementById(`page-${currentPage}`);
            const scoreContent = currentPageElement.querySelector('.score-content');
            
            // è·å–é¡µé¢é«˜åº¦ï¼ˆA4çº¸å‡å»è¾¹è·ï¼‰
            const maxHeight = 257 * 3.78; // 257mmè½¬æ¢ä¸ºåƒç´ ï¼ˆçº¦970pxï¼‰
            
            if (scoreContent.scrollHeight > maxHeight) {
                // éœ€è¦æ–°é¡µ
                const lastLine = scoreContent.lastElementChild;
                if (lastLine && lastLine.classList.contains('score-line')) {
                    // å°†æœ€åä¸€è¡Œç§»åˆ°æ–°é¡µ
                    createNewPage();
                    const newPage = document.getElementById(`page-${currentPage}`);
                    const newScoreLines = newPage.querySelector('#scoreLines');
                    newScoreLines.appendChild(lastLine);
                }
            }
        }
        
        // åˆ›å»ºæ–°é¡µ
        function createNewPage() {
            currentPage++;
            const container = document.getElementById('scoreContainer');
            
            const newPageHtml = `
                <div class="score-page" id="page-${currentPage}" data-page="${currentPage}">
                    <div class="score-content">
                        <div id="scoreLines">
                        </div>
                    </div>
                    <div class="page-indicator">ç¬¬ ${currentPage} é¡µ</div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newPageHtml);
            updateLineSelector();
        }
        
        // æ‰‹åŠ¨æ·»åŠ æ–°é¡µ
        function newPage() {
            if (beamGroup.length > 0) {
                alert('è¯·å…ˆå®Œæˆå½“å‰è¿éŸ³ç»„æˆ–åˆ‡æ¢åˆ°æ–­å¼€å‡æ—¶çº¿æ¨¡å¼');
                return;
            }
            
            createNewPage();
            newLine(true); // åœ¨æ–°é¡µåˆ›å»ºæ–°è¡Œ
        }
        
        // è·å–å½“å‰æ´»åŠ¨é¡µ
        function getCurrentPage() {
            const activeLine = document.querySelector('.score-line.active');
            if (activeLine) {
                const pageNum = activeLine.dataset.page || 1;
                return document.getElementById(`page-${pageNum}`);
            }
            return document.getElementById(`page-${currentPage}`);
        }
        
        // å±…ä¸­å¯¹é½åŠŸèƒ½
        function centerLine() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) {
                alert('è¯·å…ˆé€‰æ‹©è¦å±…ä¸­çš„è¡Œ');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹ï¼ˆæ’é™¤å…‰æ ‡ï¼‰
            const hasContent = Array.from(activeLine.children).some(child => 
                !child.classList.contains('cursor') && !child.classList.contains('tie-line-svg')
            );
            
            if (!hasContent) {
                alert('å½“å‰è¡Œæ²¡æœ‰å†…å®¹');
                return;
            }
            
            // åˆ‡æ¢å±…ä¸­çŠ¶æ€
            if (activeLine.classList.contains('centered')) {
                // å–æ¶ˆå±…ä¸­
                activeLine.classList.remove('centered');
                
                // æ¢å¤åŸå§‹é—´è·
                const noteGroups = activeLine.querySelectorAll('.note-group, .triplet-group, .beam-group, .rest, .barline, .repeat-sign');
                noteGroups.forEach(group => {
                    group.style.marginLeft = '';
                    group.style.marginRight = '';
                });
            } else {
                // åº”ç”¨å±…ä¸­
                activeLine.classList.add('centered');
                
                // æ™ºèƒ½è°ƒæ•´é—´è·
                const totalElements = activeLine.querySelectorAll('.note-group, .triplet-group, .beam-group, .rest, .barline, .repeat-sign, .spacer').length;
                
                // æ ¹æ®å…ƒç´ æ•°é‡æ™ºèƒ½è°ƒæ•´é—´è·
                if (totalElements > 20) {
                    // å¾ˆå¤šéŸ³ç¬¦æ—¶ï¼Œä½¿ç”¨æ›´ç´§å‡‘çš„é—´è·
                    activeLine.style.gap = '3px';
                } else if (totalElements > 10) {
                    // ä¸­ç­‰æ•°é‡éŸ³ç¬¦
                    activeLine.style.gap = '5px';
                } else {
                    // å°‘é‡éŸ³ç¬¦ï¼Œå¯ä»¥æœ‰æ›´å¤šé—´è·
                    activeLine.style.gap = '8px';
                }
                
                // è‡ªåŠ¨è°ƒæ•´å°èŠ‚çº¿ä¸¤ä¾§çš„é—´è·
                const barlines = activeLine.querySelectorAll('.barline');
                barlines.forEach(barline => {
                    barline.style.marginLeft = '10px';
                    barline.style.marginRight = '10px';
                });
                
                // è‡ªåŠ¨è°ƒæ•´åå¤è®°å·çš„é—´è·
                const repeatSigns = activeLine.querySelectorAll('.repeat-sign');
                repeatSigns.forEach(sign => {
                    sign.style.marginLeft = '8px';
                    sign.style.marginRight = '8px';
                });
            }
        }
        
        // åˆå§‹åŒ–è¡Œç‚¹å‡»å¤„ç†
        function initLineClickHandlers() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('score-line')) {
                    // å…ˆæ¸…é™¤æ‰€æœ‰è¡Œçš„é«˜äº®å’Œå…‰æ ‡
                    document.querySelectorAll('.score-line').forEach(l => {
                        l.classList.remove('active');
                    });
                    document.querySelectorAll('.cursor').forEach(c => {
                        c.classList.add('hidden');
                    });
                    
                    // æ¿€æ´»å½“å‰è¡Œ
                    e.target.classList.add('active');
                    const cursor = e.target.querySelector('.cursor');
                    if (cursor) {
                        cursor.classList.remove('hidden');
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–éŸ³ç¬¦é€‰æ‹©
        function initNoteSelection() {
            document.addEventListener('click', function(e) {
                const noteGroup = e.target.closest('.note-group');
                
                if (noteGroup) {
                    if (tieMode) {
                        if (handleTieSelection(noteGroup)) {
                            return;
                        }
                    }
                    
                    document.querySelectorAll('.note-group.selected').forEach(n => {
                        n.classList.remove('selected');
                    });
                    
                    noteGroup.classList.add('selected');
                    selectedNote = noteGroup;
                } else if (!e.target.closest('.spacing-btn') && !e.target.closest('.other-btn')) {
                    document.querySelectorAll('.note-group.selected').forEach(n => {
                        n.classList.remove('selected');
                    });
                    selectedNote = null;
                    
                    if (tieMode && !e.target.closest('.tie-selectable')) {
                        exitTieMode();
                    }
                }
            });
        }
        
        // è°ƒæ•´é€‰ä¸­éŸ³ç¬¦çš„é—´è·
        function adjustSelectedSpacing(direction) {
            if (!selectedNote) {
                alert('è¯·å…ˆç‚¹å‡»é€‰æ‹©ä¸€ä¸ªéŸ³ç¬¦');
                return;
            }
            
            const noteContent = selectedNote.querySelector('.note-content');
            if (!noteContent) return;
            
            const modifierLeft = noteContent.querySelector('.note-modifier-left');
            const modifierRight = noteContent.querySelector('.note-modifier-right');
            
            if (modifierLeft) {
                let currentMargin = parseInt(modifierLeft.style.marginRight || '1');
                modifierLeft.style.marginRight = Math.max(0, currentMargin + direction) + 'px';
            }
            
            if (modifierRight) {
                let currentMargin = parseInt(modifierRight.style.marginLeft || '1');
                modifierRight.style.marginLeft = Math.max(0, currentMargin + direction) + 'px';
            }
        }
        
        // åˆå§‹åŒ–æ—¶å€¼æŒ‰é’®
        function initDurationButtons() {
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.dataset.duration === 'triplet') {
                        toggleTriplet();
                    } else {
                        document.querySelectorAll('.duration-btn').forEach(b => {
                            if (b.dataset.duration !== 'triplet') {
                                b.classList.remove('active');
                            }
                        });
                        this.classList.add('active');
                        currentDuration = this.dataset.duration;
                        updatePreview();
                    }
                });
            });
        }
        
        // åˆå§‹åŒ–å˜éŸ³æŒ‰é’®
        function initModifierButtons() {
            document.querySelectorAll('.modifier-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.modifier-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentModifier = this.dataset.modifier;
                    updatePreview();
                });
            });
        }
        
        // åˆå§‹åŒ–ç®­å¤´æŒ‰é’®
        function initArrowButtons() {
            document.querySelectorAll('.arrow-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const arrow = this.dataset.arrow;
                    const note = this.dataset.note;
                    const svg = this.dataset.svg;
                    
                    // ç¡®ä¿æœ‰æ´»åŠ¨è¡Œå’Œå¯è§å…‰æ ‡
                    ensureActiveLineAndCursor();
                    
                    if (arrow === 'â—‹') {
                        insertRest();
                    } else {
                        lastNote = {
                            arrow: arrow,
                            note: note,
                            svg: svg,
                            modifier: currentModifier
                        };
                        
                        if (isTripletMode) {
                            insertTripletNote(arrow, note, svg);
                        } else {
                            insertNote(arrow, note, svg);
                        }
                    }
                });
            });
        }
        
        // ç¡®ä¿æœ‰æ´»åŠ¨è¡Œå’Œå¯è§å…‰æ ‡
        function ensureActiveLineAndCursor() {
            let activeLine = document.querySelector('.score-line.active');
            if (!activeLine) {
                // å¦‚æœæ²¡æœ‰æ´»åŠ¨è¡Œï¼Œæ¿€æ´»ç¬¬ä¸€è¡Œ
                activeLine = document.querySelector('.score-line');
                if (activeLine) {
                    activeLine.classList.add('active');
                }
            }
            
            // ç¡®ä¿å…‰æ ‡å¯è§
            const cursor = activeLine?.querySelector('.cursor');
            if (cursor) {
                cursor.classList.remove('hidden');
            }
        }
        
        // ç§»åŠ¨å…‰æ ‡
        function moveCursor(direction) {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            if (direction === 'left') {
                const prev = cursor.previousElementSibling;
                if (prev && !prev.classList.contains('tie-line-svg')) {
                    activeLine.insertBefore(cursor, prev);
                }
            } else if (direction === 'right') {
                const next = cursor.nextElementSibling;
                if (next && !next.classList.contains('tie-line-svg')) {
                    activeLine.insertBefore(cursor, next.nextElementSibling);
                }
            }
        }
        
        // æ’å…¥æ ‡æ³¨
        function insertAnnotation(type) {
            pendingAnnotation = type;
        }
        
        // æ’å…¥ç›’å­æ ‡æ³¨
        function insertBox(type) {
            pendingBox = type;
        }
        
        // æ’å…¥åŒéŸ³è¿çº¿ç¬¦å·
        function insertTie() {
            if (!tieMode) {
                tieMode = true;
                firstTieNote = null;
                alert('è¯·ç‚¹å‡»ç¬¬ä¸€ä¸ªéŸ³ç¬¦ï¼Œç„¶åç‚¹å‡»ç¬¬äºŒä¸ªéŸ³ç¬¦æ¥æ·»åŠ è¿éŸ³çº¿');
                document.querySelectorAll('.note-group').forEach(note => {
                    note.style.cursor = 'crosshair';
                    note.classList.add('tie-selectable');
                });
            } else {
                exitTieMode();
            }
        }
        
        // é€€å‡ºè¿éŸ³çº¿æ¨¡å¼
        function exitTieMode() {
            tieMode = false;
            firstTieNote = null;
            document.querySelectorAll('.note-group').forEach(note => {
                note.style.cursor = 'pointer';
                note.classList.remove('tie-selectable');
                note.classList.remove('tie-first-selected');
            });
        }
        
        // å¤„ç†è¿éŸ³çº¿é€‰æ‹©
        function handleTieSelection(noteElement) {
            if (!tieMode) return false;
            
            if (!firstTieNote) {
                firstTieNote = noteElement;
                noteElement.classList.add('tie-first-selected');
                return true;
            } else if (noteElement !== firstTieNote) {
                createTieLine(firstTieNote, noteElement);
                exitTieMode();
                return true;
            }
            return false;
        }
        
        // åˆ›å»ºè¿éŸ³çº¿
        function createTieLine(note1, note2) {
            const line = note1.closest('.score-line');
            if (!line) return;
            
            // ç»™éŸ³ç¬¦æ·»åŠ å”¯ä¸€IDä»¥ä¾¿è¿½è¸ª
            if (!note1.dataset.noteId) {
                note1.dataset.noteId = 'note-' + Date.now() + '-' + Math.random();
            }
            if (!note2.dataset.noteId) {
                note2.dataset.noteId = 'note-' + Date.now() + '-' + Math.random();
            }
            
            const rect1 = note1.getBoundingClientRect();
            const rect2 = note2.getBoundingClientRect();
            const lineRect = line.getBoundingClientRect();
            
            const x1 = rect1.left + rect1.width/2 - lineRect.left;
            const x2 = rect2.left + rect2.width/2 - lineRect.left;
            const y = rect1.top - lineRect.top - 15;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.left = Math.min(x1, x2) + 'px';
            svg.style.top = y + 'px';
            svg.style.width = Math.abs(x2 - x1) + 'px';
            svg.style.height = '20px';
            svg.style.pointerEvents = 'none';
            svg.style.overflow = 'visible';
            svg.classList.add('tie-line-svg');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const startX = x1 < x2 ? 0 : Math.abs(x2 - x1);
            const endX = x1 < x2 ? Math.abs(x2 - x1) : 0;
            const midX = Math.abs(endX - startX) / 2;
            const d = `M ${startX} 15 Q ${midX} 5, ${endX} 15`;
            path.setAttribute('d', d);
            path.setAttribute('stroke', '#333');
            path.setAttribute('stroke-width', '1.5');
            path.setAttribute('fill', 'none');
            
            svg.appendChild(path);
            line.appendChild(svg);
            
            tieLinesData.push({
                note1: note1,
                note2: note2,
                svg: svg,
                line: line,
                note1Id: note1.dataset.noteId,
                note2Id: note2.dataset.noteId
            });
        }
        
        // åˆ‡æ¢ä¸‰è¿éŸ³æ¨¡å¼
        function toggleTriplet() {
            isTripletMode = !isTripletMode;
            const btn = document.getElementById('tripletBtn');
            const status = document.getElementById('tripletStatus');
            
            if (isTripletMode) {
                btn.classList.add('active');
                status.classList.add('active');
                tripletGroup = [];
                updateTripletStatus();
            } else {
                btn.classList.remove('active');
                status.classList.remove('active');
                tripletGroup = [];
            }
        }
        
        // æ›´æ–°ä¸‰è¿éŸ³çŠ¶æ€
        function updateTripletStatus() {
            document.getElementById('tripletCount').textContent = tripletGroup.length;
        }
        
        // æ›´æ–°è¿éŸ³ç»„çŠ¶æ€
        function updateBeamStatus() {
            document.getElementById('beamCount').textContent = beamGroup.length;
        }
        
        // æ’å…¥ä¸‰è¿éŸ³éŸ³ç¬¦
        function insertTripletNote(arrow, note, svg) {
            const noteElement = createNoteElement(arrow, note, svg);
            tripletGroup.push(noteElement);
            updateTripletStatus();
            
            if (tripletGroup.length === 3) {
                const activeLine = document.querySelector('.score-line.active');
                const cursor = activeLine.querySelector('.cursor');
                
                const tripletContainer = document.createElement('div');
                tripletContainer.className = 'triplet-group';
                
                const bracket = document.createElement('div');
                bracket.className = 'triplet-bracket';
                bracket.innerHTML = 'âŒ’3âŒ’';
                
                const notesContainer = document.createElement('div');
                notesContainer.className = 'triplet-notes';
                
                tripletGroup.forEach(n => {
                    notesContainer.appendChild(n);
                });
                
                tripletContainer.appendChild(bracket);
                tripletContainer.appendChild(notesContainer);
                
                activeLine.insertBefore(tripletContainer, cursor);
                
                tripletGroup = [];
                isTripletMode = false;
                document.getElementById('tripletBtn').classList.remove('active');
                document.getElementById('tripletStatus').classList.remove('active');
                
                checkPageOverflow(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°é¡µ
                updateTieLinePositions(); // æ›´æ–°è¿éŸ³çº¿
            }
        }
        
        // è¡Œè·è°ƒæ•´åŠŸèƒ½
        function adjustLineSpacing(type, value) {
            const lineValue = document.getElementById('lineSelect').value;
            const [pageNum, lineNum] = lineValue.split('-');
            const line = document.querySelector(`.score-line[data-page="${pageNum}"][data-line="${lineNum}"]`);
            
            if (line) {
                if (type === 'top') {
                    let currentTop = parseInt(line.style.marginTop || 0);
                    line.style.marginTop = Math.max(0, currentTop + value) + 'px';
                } else if (type === 'bottom') {
                    let currentBottom = parseInt(line.style.marginBottom || 20);
                    line.style.marginBottom = Math.max(0, currentBottom + value) + 'px';
                }
            }
        }
        
        // æ›´æ–°è¡Œé€‰æ‹©å™¨
        function updateLineSelector() {
            const select = document.getElementById('lineSelect');
            select.innerHTML = '';
            
            document.querySelectorAll('.score-line').forEach(line => {
                const pageNum = line.dataset.page || 1;
                const lineNum = line.dataset.line;
                const option = document.createElement('option');
                option.value = `${pageNum}-${lineNum}`;
                option.textContent = `ç¬¬${pageNum}é¡µ-ç¬¬${lineNum}è¡Œ`;
                select.appendChild(option);
            });
        }
        
        // åˆå§‹åŒ–å‡æ—¶çº¿æ§åˆ¶
        function initBeamControl() {
            document.getElementById('beamConnect').addEventListener('click', function() {
                beamMode = 'connect';
                document.getElementById('beamSeparate').classList.remove('active');
                this.classList.add('active');
                document.getElementById('beamComplete').style.display = 'block';
                document.getElementById('beamStatus').classList.add('active');
                beamGroup = [];
                updateBeamStatus();
            });
            
            document.getElementById('beamSeparate').addEventListener('click', function() {
                beamMode = 'separate';
                document.getElementById('beamConnect').classList.remove('active');
                this.classList.add('active');
                document.getElementById('beamComplete').style.display = 'none';
                document.getElementById('beamStatus').classList.remove('active');
                beamGroup = [];
            });
            
            document.getElementById('beamComplete').addEventListener('click', function() {
                completeBeamGroup();
            });
        }
        
        // æ‰‹åŠ¨å®Œæˆè¿éŸ³ç»„
        function completeBeamGroup() {
            if (beamGroup.length < 2) {
                alert('è‡³å°‘éœ€è¦2ä¸ªéŸ³ç¬¦æ‰èƒ½å½¢æˆè¿éŸ³ç»„');
                return;
            }
            
            const activeLine = document.querySelector('.score-line.active');
            const cursor = activeLine.querySelector('.cursor');
            
            const groupContainer = document.createElement('div');
            groupContainer.className = 'beam-group';
            
            const notesContainer = document.createElement('div');
            notesContainer.className = 'note-groups';
            
            beamGroup.forEach(noteData => {
                const originalNote = document.querySelector(`[data-beam-id="${noteData.id}"]`);
                if (originalNote) {
                    originalNote.remove();
                }
                
                const newNote = createNoteElementForBeam(noteData);
                notesContainer.appendChild(newNote);
            });
            
            groupContainer.appendChild(notesContainer);
            
            const smartBeams = createSmartBeams(beamGroup);
            groupContainer.appendChild(smartBeams);
            
            activeLine.insertBefore(groupContainer, cursor);
            beamGroup = [];
            updateBeamStatus();
            
            checkPageOverflow(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°é¡µ
            updateTieLinePositions(); // æ›´æ–°è¿éŸ³çº¿
        }
        
        // åˆ›å»ºæ™ºèƒ½å‡æ—¶çº¿
        function createSmartBeams(noteGroup) {
            const beamContainer = document.createElement('div');
            beamContainer.className = 'smart-beams';
            
            const hasEighthOrSixteenth = noteGroup.some(n => 
                n.duration === 'eighth' || n.duration === 'sixteenth'
            );
            const sixteenthIndices = [];
            noteGroup.forEach((note, index) => {
                if (note.duration === 'sixteenth') {
                    sixteenthIndices.push(index);
                }
            });
            
            if (hasEighthOrSixteenth) {
                const beam1 = document.createElement('div');
                beam1.className = 'connected-beam first';
                beamContainer.appendChild(beam1);
            }
            
            if (sixteenthIndices.length > 0) {
                const groups = [];
                let currentGroup = [];
                
                for (let i = 0; i < sixteenthIndices.length; i++) {
                    const index = sixteenthIndices[i];
                    
                    if (currentGroup.length === 0) {
                        currentGroup.push(index);
                    } else {
                        const lastIndex = currentGroup[currentGroup.length - 1];
                        if (index === lastIndex + 1) {
                            currentGroup.push(index);
                        } else {
                            if (currentGroup.length > 0) {
                                groups.push(currentGroup);
                            }
                            currentGroup = [index];
                        }
                    }
                }
                
                if (currentGroup.length > 0) {
                    groups.push(currentGroup);
                }
                
                groups.forEach(group => {
                    if (group.length === 1) {
                        const beam2 = document.createElement('div');
                        beam2.className = 'connected-beam second partial';
                        const noteWidth = 100 / noteGroup.length;
                        beam2.style.left = (group[0] * noteWidth) + '%';
                        beam2.style.width = noteWidth + '%';
                        beamContainer.appendChild(beam2);
                    } else {
                        const beam2 = document.createElement('div');
                        beam2.className = 'connected-beam second partial';
                        const noteWidth = 100 / noteGroup.length;
                        const startPos = group[0] * noteWidth;
                        const endPos = (group[group.length - 1] + 1) * noteWidth;
                        beam2.style.left = startPos + '%';
                        beam2.style.width = (endPos - startPos) + '%';
                        beamContainer.appendChild(beam2);
                    }
                });
            }
            
            return beamContainer;
        }
        
        // åˆ›å»ºç”¨äºè¿éŸ³ç»„çš„éŸ³ç¬¦å…ƒç´ 
        function createNoteElementForBeam(noteData) {
            const noteGroup = document.createElement('div');
            noteGroup.className = 'note-group';
            if (noteData.noteId) {
                noteGroup.dataset.noteId = noteData.noteId;
            }
            
            let noteHTML = '<div class="note-content">';
            
            // å¤„ç†å·¦ä¾§ä¿®é¥°ç¬¦
            if (noteData.modifier === 'flat') {
                noteHTML += '<span class="note-modifier-left">_</span>';
            } else if (noteData.modifier === 'octave-down') {
                const isRightArrow = noteData.arrow === 'right';
                const marginStyle = isRightArrow ? ' style="margin-right: 0px;"' : '';
                noteHTML += `<span class="note-modifier-left"${marginStyle}>-</span>`;
            } else if (noteData.modifier === 'down-down') {
                noteHTML += '<span class="note-modifier-left">=</span>';
            } else if (noteData.modifier === 'up-down') {
                noteHTML += '<span class="note-modifier-left">_</span>';
            } else if (noteData.modifier === 'down-up') {
                const isRightArrow = noteData.arrow === 'right';
                const marginStyle = isRightArrow ? ' style="margin-right: 0px;"' : '';
                noteHTML += `<span class="note-modifier-left"${marginStyle}>-</span>`;
            }
            
            noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${noteData.svg}"/></svg></span>`;
            
            // å¤„ç†å³ä¾§ä¿®é¥°ç¬¦
            if (noteData.modifier === 'sharp') {
                noteHTML += '<span class="note-modifier-right">_</span>';
            } else if (noteData.modifier === 'octave-up') {
                const isLeftArrow = noteData.arrow === 'left';
                const marginStyle = isLeftArrow ? ' style="margin-left: 0px;"' : '';
                noteHTML += `<span class="note-modifier-right"${marginStyle}>-</span>`;
            } else if (noteData.modifier === 'up-up') {
                noteHTML += '<span class="note-modifier-right">=</span>';
            } else if (noteData.modifier === 'up-down') {
                const isLeftArrow = noteData.arrow === 'left';
                const marginStyle = isLeftArrow ? ' style="margin-left: 0px;"' : '';
                noteHTML += `<span class="note-modifier-right"${marginStyle}>-</span>`;
            } else if (noteData.modifier === 'down-up') {
                noteHTML += '<span class="note-modifier-right">_</span>';
            }
            
            if (noteData.dotted) {
                noteHTML += '<span class="note-dot">Â·</span>';
            }
            
            if (noteData.annotation) {
                noteHTML += `<span class="note-annotation">${noteData.annotation}</span>`;
            }
            
            if (noteData.box) {
                noteHTML += `<span class="note-box">${noteData.box}</span>`;
            }
            
            noteHTML += '</div>';
            
            noteGroup.innerHTML = noteHTML;
            return noteGroup;
        }
        
        // æ›´æ–°é™„ç‚¹çŠ¶æ€
        function updateDotted() {
            isDotted = document.getElementById('dotted').checked;
            updatePreview();
        }
        
        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const preview = document.getElementById('currentPreview');
            let html = '';
            
            const arrow = '<svg class="arrow-svg"><use href="#arrow-right"/></svg>';
            
            if (currentModifier === 'sharp') {
                html = `${arrow}_`;
            } else if (currentModifier === 'flat') {
                html = `_${arrow}`;
            } else if (currentModifier === 'octave-up') {
                html = `${arrow}-`;
            } else if (currentModifier === 'octave-down') {
                html = `-${arrow}`;
            } else if (currentModifier === 'up-up') {
                html = `${arrow}=`;
            } else if (currentModifier === 'down-down') {
                html = `=${arrow}`;
            } else if (currentModifier === 'up-down') {
                html = `_${arrow}-`;
            } else if (currentModifier === 'down-up') {
                html = `-${arrow}_`;
            } else {
                html = arrow;
            }
            
            if (currentDuration === 'half') {
                html += '~';
            } else if (currentDuration === 'whole') {
                html += '~~~';
            }
            
            if (isDotted) {
                html += 'Â·';
            }
            
            if (currentDuration === 'eighth' || currentDuration === 'sixteenth') {
                html += '<div style="margin-top:2px;">';
                if (currentDuration === 'eighth') {
                    html += 'â”€';
                } else {
                    html += 'â•â•';
                }
                html += '</div>';
            }
            
            preview.innerHTML = html;
        }
        
        // æ’å…¥éŸ³ç¬¦
        function insertNote(arrow, note, svg) {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            const noteElement = createNoteElement(arrow, note, svg);
            
            if (pendingAnnotation) {
                const annotation = document.createElement('span');
                annotation.className = 'note-annotation';
                annotation.textContent = pendingAnnotation;
                noteElement.querySelector('.note-content').appendChild(annotation);
                pendingAnnotation = null;
            }
            
            if (pendingBox) {
                const box = document.createElement('span');
                box.className = 'note-box';
                box.textContent = pendingBox;
                noteElement.querySelector('.note-content').appendChild(box);
                pendingBox = null;
            }
            
            if (beamMode === 'connect' && (currentDuration === 'eighth' || currentDuration === 'sixteenth')) {
                const beamId = 'beam-' + Date.now() + '-' + Math.random();
                noteElement.dataset.beamId = beamId;
                
                beamGroup.push({
                    id: beamId,
                    arrow: arrow,
                    note: note,
                    svg: svg,
                    modifier: currentModifier,
                    duration: currentDuration,
                    dotted: isDotted,
                    annotation: pendingAnnotation,
                    box: pendingBox,
                    noteId: noteElement.dataset.noteId
                });
                
                activeLine.insertBefore(noteElement, cursor);
                updateBeamStatus();
            } else {
                activeLine.insertBefore(noteElement, cursor);
            }
            
            checkPageOverflow(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°é¡µ
            updateTieLinePositions(); // æ›´æ–°è¿éŸ³çº¿
        }
        
        // åˆ›å»ºéŸ³ç¬¦å…ƒç´   
        function createNoteElement(arrow, note, svg) {
            const noteGroup = document.createElement('div');
            noteGroup.className = 'note-group';
            
            // ç”Ÿæˆå”¯ä¸€ID
            const noteId = 'note-' + Date.now() + '-' + Math.random();
            noteGroup.dataset.noteId = noteId;
            
            let noteHTML = '<div class="note-content">';
            
            // å¤„ç†å·¦ä¾§ä¿®é¥°ç¬¦
            if (currentModifier === 'flat') {
                noteHTML += '<span class="note-modifier-left">_</span>';
            } else if (currentModifier === 'octave-down') {
                const isRightArrow = arrow === 'right';
                const marginStyle = isRightArrow ? ' style="margin-right: 0px;"' : '';
                noteHTML += `<span class="note-modifier-left"${marginStyle}>-</span>`;
            } else if (currentModifier === 'down-down') {
                noteHTML += '<span class="note-modifier-left">=</span>';
            } else if (currentModifier === 'up-down') {
                noteHTML += '<span class="note-modifier-left">_</span>';
            } else if (currentModifier === 'down-up') {
                const isRightArrow = arrow === 'right';
                const marginStyle = isRightArrow ? ' style="margin-right: 0px;"' : '';
                noteHTML += `<span class="note-modifier-left"${marginStyle}>-</span>`;
            }
            
            noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${svg}"/></svg></span>`;
            
            // å¤„ç†å³ä¾§ä¿®é¥°ç¬¦
            if (currentModifier === 'sharp') {
                noteHTML += '<span class="note-modifier-right">_</span>';
            } else if (currentModifier === 'octave-up') {
                const isLeftArrow = arrow === 'left';
                const marginStyle = isLeftArrow ? ' style="margin-left: 0px;"' : '';
                noteHTML += `<span class="note-modifier-right"${marginStyle}>-</span>`;
            } else if (currentModifier === 'up-up') {
                noteHTML += '<span class="note-modifier-right">=</span>';
            } else if (currentModifier === 'up-down') {
                const isLeftArrow = arrow === 'left';
                const marginStyle = isLeftArrow ? ' style="margin-left: 0px;"' : '';
                noteHTML += `<span class="note-modifier-right"${marginStyle}>-</span>`;
            } else if (currentModifier === 'down-up') {
                noteHTML += '<span class="note-modifier-right">_</span>';
            }
            
            if (currentDuration === 'half') {
                noteHTML += '<span class="note-extend">~</span>';
            } else if (currentDuration === 'whole') {
                noteHTML += '<span class="note-extend">~~~</span>';
            }
            
            if (isDotted) {
                noteHTML += '<span class="note-dot">Â·</span>';
            }
            
            noteHTML += '</div>';
            
            if ((beamMode === 'separate' || beamMode === 'connect') && 
                (currentDuration === 'eighth' || currentDuration === 'sixteenth')) {
                noteHTML += '<div class="beam-container">';
                noteHTML += '<div class="beam-line"></div>';
                if (currentDuration === 'sixteenth') {
                    noteHTML += '<div class="beam-line second"></div>';
                }
                noteHTML += '</div>';
            }
            
            noteGroup.innerHTML = noteHTML;
            noteGroup.dataset.note = note;
            noteGroup.dataset.duration = currentDuration;
            noteGroup.dataset.modifier = currentModifier;
            noteGroup.dataset.dotted = isDotted;
            noteGroup.dataset.arrow = arrow;
            noteGroup.dataset.svg = svg;
            
            return noteGroup;
        }
        
        // æ’å…¥ç©ºæ ¼
        function insertSpacer() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            if (beamGroup.length > 0) {
                alert('è¯·å…ˆå®Œæˆå½“å‰è¿éŸ³ç»„æˆ–åˆ‡æ¢åˆ°æ–­å¼€å‡æ—¶çº¿æ¨¡å¼');
                return;
            }
            
            const spacer = document.createElement('div');
            spacer.className = 'spacer';
            activeLine.insertBefore(spacer, cursor);
        }
        
        // æ’å…¥ä¼‘æ­¢ç¬¦
        function insertRest() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            if (beamGroup.length > 0) {
                alert('è¯·å…ˆå®Œæˆå½“å‰è¿éŸ³ç»„æˆ–åˆ‡æ¢åˆ°æ–­å¼€å‡æ—¶çº¿æ¨¡å¼');
                return;
            }
            
            const rest = document.createElement('div');
            rest.className = 'rest';
            
            let restContent = '<div>â—‹</div>';
            
            if (currentDuration === 'eighth' || currentDuration === 'sixteenth') {
                restContent += '<div class="beam-container">';
                if (currentDuration === 'eighth') {
                    restContent += '<div class="beam-line"></div>';
                } else {
                    restContent += '<div class="beam-line"></div>';
                    restContent += '<div class="beam-line second"></div>';
                }
                restContent += '</div>';
            } else if (currentDuration === 'half') {
                restContent = '<div>â—‹~</div>';
            } else if (currentDuration === 'whole') {
                restContent = '<div>â—‹~~~</div>';
            }
            
            if (isDotted) {
                restContent = restContent.replace('</div>', 'Â·</div>');
            }
            
            rest.innerHTML = restContent;
            rest.dataset.duration = currentDuration;
            
            activeLine.insertBefore(rest, cursor);
            checkPageOverflow(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°é¡µ
            updateTieLinePositions(); // æ›´æ–°è¿éŸ³çº¿
        }
        
        function insertBarline() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            if (beamGroup.length > 0) {
                alert('è¯·å…ˆå®Œæˆå½“å‰è¿éŸ³ç»„æˆ–åˆ‡æ¢åˆ°æ–­å¼€å‡æ—¶çº¿æ¨¡å¼');
                return;
            }
            
            const barline = document.createElement('div');
            barline.className = 'barline';
            activeLine.insertBefore(barline, cursor);
        }
        
        function insertDoubleBar() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            if (beamGroup.length > 0) {
                alert('è¯·å…ˆå®Œæˆå½“å‰è¿éŸ³ç»„æˆ–åˆ‡æ¢åˆ°æ–­å¼€å‡æ—¶çº¿æ¨¡å¼');
                return;
            }
            
            const doubleBar = document.createElement('div');
            doubleBar.className = 'barline';
            doubleBar.style.width = '6px';
            doubleBar.style.borderLeft = '2px solid #333';
            doubleBar.style.borderRight = '2px solid #333';
            activeLine.insertBefore(doubleBar, cursor);
        }
        
        function insertRepeat(type) {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            if (beamGroup.length > 0) {
                alert('è¯·å…ˆå®Œæˆå½“å‰è¿éŸ³ç»„æˆ–åˆ‡æ¢åˆ°æ–­å¼€å‡æ—¶çº¿æ¨¡å¼');
                return;
            }
            
            const repeat = document.createElement('div');
            repeat.className = 'repeat-sign';
            repeat.innerHTML = type;
            activeLine.insertBefore(repeat, cursor);
        }
        
        function deleteLast() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            const cursor = activeLine.querySelector('.cursor');
            if (!cursor) return;
            
            const prev = cursor.previousElementSibling;
            
            if (prev && !prev.classList.contains('tie-line-svg')) {
                prev.remove();
                updateTieLinePositions(); // æ›´æ–°è¿éŸ³çº¿
            }
        }
        
        function clearLine() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) return;
            
            activeLine.querySelectorAll('.tie-line-svg').forEach(svg => {
                svg.remove();
            });
            
            tieLinesData = tieLinesData.filter(tie => tie.line !== activeLine);
            
            activeLine.innerHTML = '<div class="cursor"></div>';
            beamGroup = [];
            tripletGroup = [];
            updateBeamStatus();
        }
        
        function deleteLine() {
            const activeLine = document.querySelector('.score-line.active');
            if (!activeLine) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡Œ');
                return;
            }
            
            // è·å–å½“å‰é¡µçš„æ‰€æœ‰è¡Œ
            const currentPageNum = activeLine.dataset.page;
            const currentPageElement = document.getElementById(`page-${currentPageNum}`);
            const linesInPage = currentPageElement.querySelectorAll('.score-line');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€é¡µçš„ç¬¬ä¸€è¡Œï¼Œä¸å…è®¸åˆ é™¤
            if (currentPageNum === '1' && linesInPage.length === 1) {
                alert('ä¸èƒ½åˆ é™¤ç¬¬ä¸€é¡µçš„æœ€åä¸€è¡Œ');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€è¡Œå—ï¼Ÿ')) {
                return;
            }
            
            // åˆ é™¤ç›¸å…³çš„è¿éŸ³çº¿
            tieLinesData = tieLinesData.filter(tie => tie.line !== activeLine);
            
            // è·å–ä¸‹ä¸€è¡Œæˆ–ä¸Šä¸€è¡Œä½œä¸ºæ–°çš„æ´»åŠ¨è¡Œ
            let newActiveLine = activeLine.nextElementSibling || activeLine.previousElementSibling;
            
            // åˆ é™¤å½“å‰è¡Œ
            activeLine.remove();
            
            // å¦‚æœå½“å‰é¡µæ²¡æœ‰è¡Œäº†ï¼Œå¹¶ä¸”ä¸æ˜¯ç¬¬ä¸€é¡µï¼Œåˆ é™¤å½“å‰é¡µ
            if (linesInPage.length === 1 && currentPageNum !== '1') {
                currentPageElement.remove();
                // é‡æ–°ç¼–å·é¡µç 
                renumberPages();
                // é€‰æ‹©ä¸Šä¸€é¡µçš„æœ€åä¸€è¡Œ
                const prevPage = document.getElementById(`page-${parseInt(currentPageNum) - 1}`);
                if (prevPage) {
                    const prevPageLines = prevPage.querySelectorAll('.score-line');
                    if (prevPageLines.length > 0) {
                        newActiveLine = prevPageLines[prevPageLines.length - 1];
                    }
                }
            }
            
            // è®¾ç½®æ–°çš„æ´»åŠ¨è¡Œ
            if (newActiveLine && newActiveLine.classList.contains('score-line')) {
                document.querySelectorAll('.score-line').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.cursor').forEach(c => c.classList.add('hidden'));
                newActiveLine.classList.add('active');
                const cursor = newActiveLine.querySelector('.cursor');
                if (cursor) {
                    cursor.classList.remove('hidden');
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„è¡Œï¼Œé€‰æ‹©ç¬¬ä¸€è¡Œ
                const firstLine = document.querySelector('.score-line');
                if (firstLine) {
                    firstLine.classList.add('active');
                    const cursor = firstLine.querySelector('.cursor');
                    if (cursor) {
                        cursor.classList.remove('hidden');
                    }
                }
            }
            
            // é‡æ–°ç¼–å·è¡Œå·
            renumberLines();
            updateLineSelector();
        }
        
        function deletePage() {
            // è·å–æ‰€æœ‰é¡µé¢
            const allPages = document.querySelectorAll('.score-page');
            
            // å¦‚æœåªæœ‰ä¸€é¡µï¼Œä¸å…è®¸åˆ é™¤
            if (allPages.length <= 1) {
                alert('ä¸èƒ½åˆ é™¤æœ€åä¸€é¡µ');
                return;
            }
            
            // è·å–å½“å‰æ´»åŠ¨è¡Œæ‰€åœ¨çš„é¡µé¢
            const activeLine = document.querySelector('.score-line.active');
            let currentPageNum = 1;
            
            if (activeLine) {
                currentPageNum = parseInt(activeLine.dataset.page);
            }
            
            const pageToDelete = document.getElementById(`page-${currentPageNum}`);
            if (!pageToDelete) {
                alert('æ‰¾ä¸åˆ°è¦åˆ é™¤çš„é¡µé¢');
                return;
            }
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${currentPageNum} é¡µå—ï¼Ÿè¯¥é¡µä¸Šçš„æ‰€æœ‰å†…å®¹éƒ½å°†è¢«åˆ é™¤ã€‚`)) {
                return;
            }
            
            // åˆ é™¤è¯¥é¡µç›¸å…³çš„æ‰€æœ‰è¿éŸ³çº¿
            const linesInPage = pageToDelete.querySelectorAll('.score-line');
            linesInPage.forEach(line => {
                tieLinesData = tieLinesData.filter(tie => tie.line !== line);
            });
            
            // åˆ é™¤é¡µé¢
            pageToDelete.remove();
            
            // é‡æ–°ç¼–å·æ‰€æœ‰é¡µé¢
            renumberPages();
            
            // é‡æ–°ç¼–å·æ‰€æœ‰è¡Œ
            renumberLines();
            
            // æ›´æ–°å½“å‰é¡µæ•°
            currentPage = document.querySelectorAll('.score-page').length;
            
            // é€‰æ‹©ç¬¬ä¸€é¡µçš„ç¬¬ä¸€è¡Œä½œä¸ºæ´»åŠ¨è¡Œ
            const firstPageFirstLine = document.querySelector('.score-page .score-line');
            if (firstPageFirstLine) {
                document.querySelectorAll('.score-line').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.cursor').forEach(c => c.classList.add('hidden'));
                firstPageFirstLine.classList.add('active');
                const cursor = firstPageFirstLine.querySelector('.cursor');
                if (cursor) {
                    cursor.classList.remove('hidden');
                }
            }
            
            // æ›´æ–°è¡Œé€‰æ‹©å™¨
            updateLineSelector();
        }
        
        function renumberPages() {
            const allPages = document.querySelectorAll('.score-page');
            allPages.forEach((page, index) => {
                const newPageNum = index + 1;
                page.id = `page-${newPageNum}`;
                page.dataset.page = newPageNum;
                
                // æ›´æ–°é¡µç æŒ‡ç¤ºå™¨
                const indicator = page.querySelector('.page-indicator');
                if (indicator) {
                    indicator.textContent = `ç¬¬ ${newPageNum} é¡µ`;
                }
                
                // æ›´æ–°è¯¥é¡µæ‰€æœ‰è¡Œçš„é¡µç 
                const lines = page.querySelectorAll('.score-line');
                lines.forEach(line => {
                    line.dataset.page = newPageNum;
                });
            });
        }
        
        function renumberLines() {
            let globalLineNumber = 1;
            document.querySelectorAll('.score-line').forEach(line => {
                line.dataset.line = globalLineNumber;
                globalLineNumber++;
            });
            currentLine = globalLineNumber - 1;
        }
        
        function newLine(inNewPage = false) {
            if (beamGroup.length > 0) {
                alert('è¯·å…ˆå®Œæˆå½“å‰è¿éŸ³ç»„æˆ–åˆ‡æ¢åˆ°æ–­å¼€å‡æ—¶çº¿æ¨¡å¼');
                return;
            }
            
            // éšè—æ‰€æœ‰å…‰æ ‡
            document.querySelectorAll('.cursor').forEach(c => c.classList.add('hidden'));
            
            document.querySelectorAll('.score-line').forEach(line => {
                line.classList.remove('active');
            });
            
            const pageToUse = inNewPage ? currentPage : 
                (document.querySelector('.score-line.active')?.dataset.page || currentPage);
            const pageElement = document.getElementById(`page-${pageToUse}`);
            const scoreLines = pageElement.querySelector('.score-content #scoreLines, .score-content');
            
            currentLine++;
            const newLineDiv = document.createElement('div');
            newLineDiv.className = 'score-line active';
            newLineDiv.dataset.line = currentLine;
            newLineDiv.dataset.page = pageToUse;
            newLineDiv.innerHTML = '<div class="cursor"></div>';
            
            newLineDiv.addEventListener('click', function() {
                document.querySelectorAll('.score-line').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.cursor').forEach(c => c.classList.add('hidden'));
                this.classList.add('active');
                const cursor = this.querySelector('.cursor');
                if (cursor) {
                    cursor.classList.remove('hidden');
                }
            });
            
            if (scoreLines.id === 'scoreLines') {
                scoreLines.appendChild(newLineDiv);
            } else {
                // å¦‚æœæ˜¯æ–°é¡µï¼Œåˆ›å»ºscoreLineså®¹å™¨
                let linesContainer = scoreLines.querySelector('#scoreLines');
                if (!linesContainer) {
                    linesContainer = document.createElement('div');
                    linesContainer.id = 'scoreLines';
                    scoreLines.appendChild(linesContainer);
                }
                linesContainer.appendChild(newLineDiv);
            }
            
            updateLineSelector();
            checkPageOverflow(); // æ£€æŸ¥æ˜¯å¦éœ€è¦æ–°é¡µ
        }
        
        function updateTitle() {
            const title = document.getElementById('title').value;
            document.getElementById('scoreTitle').textContent = title || 'æœªå‘½åä¹è°±';
        }
        
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT') return;
                
                const key = e.key;
                const noteMap = {
                    '1': { arrow: 'up', note: '1', svg: 'arrow-up' },
                    '2': { arrow: 'right-up', note: '2', svg: 'arrow-right-up' },
                    '3': { arrow: 'right', note: '3', svg: 'arrow-right' },
                    '4': { arrow: 'right-down', note: '4', svg: 'arrow-right-down' },
                    '5': { arrow: 'down', note: '5', svg: 'arrow-down' },
                    '6': { arrow: 'left-down', note: '6', svg: 'arrow-left-down' },
                    '7': { arrow: 'left', note: '7', svg: 'arrow-left' },
                    '8': { arrow: 'left-up', note: "1'", svg: 'arrow-left-up' }
                };
                
                // ç¡®ä¿æœ‰æ´»åŠ¨è¡Œå’Œå…‰æ ‡
                ensureActiveLineAndCursor();
                
                if (noteMap[key]) {
                    lastNote = {
                        arrow: noteMap[key].arrow,
                        note: noteMap[key].note,
                        svg: noteMap[key].svg,
                        modifier: currentModifier
                    };
                    if (isTripletMode) {
                        insertTripletNote(noteMap[key].arrow, noteMap[key].note, noteMap[key].svg);
                    } else {
                        insertNote(noteMap[key].arrow, noteMap[key].note, noteMap[key].svg);
                    }
                } else if (key === '0') {
                    insertRest();
                } else if (key === ' ') {
                    e.preventDefault();
                    insertSpacer();
                } else if (key === '|') {
                    insertBarline();
                } else if (key === 'Delete' || key === 'Backspace') {
                    deleteLast();
                } else if (key === 'Enter') {
                    newLine();
                } else if (key === '=' || key === '+') {
                    insertTie();
                } else if (key === 'ArrowLeft') {
                    e.preventDefault();
                    moveCursor('left');
                } else if (key === 'ArrowRight') {
                    e.preventDefault();
                    moveCursor('right');
                } else if (key === 'c' || key === 'C') {
                    e.preventDefault();
                    centerLine();
                }
            });
        }
        
        function saveScore() {
            const data = {
                title: document.getElementById('title').value,
                scoreInfo: document.getElementById('scoreInfo').value,
                tempo: document.getElementById('tempo').value,
                fontSize: fontSize,
                pages: [],
                tieLines: []
            };
            
            // ä¿å­˜è¿éŸ³çº¿æ•°æ®
            tieLinesData.forEach(tie => {
                const lineElement = tie.line;
                const lineNum = lineElement.dataset.line;
                const pageNum = lineElement.dataset.page;
                
                data.tieLines.push({
                    note1Id: tie.note1Id,
                    note2Id: tie.note2Id,
                    lineNum: lineNum,
                    pageNum: pageNum
                });
            });
            
            document.querySelectorAll('.score-page').forEach(page => {
                const pageData = {
                    pageNumber: page.dataset.page,
                    lines: []
                };
                
                page.querySelectorAll('.score-line').forEach(line => {
                    const lineData = {
                        marginTop: line.style.marginTop || '0',
                        marginBottom: line.style.marginBottom || '20px',
                        isCentered: line.classList.contains('centered'),
                        gap: line.style.gap || '',
                        elements: []
                    };
                    
                    line.childNodes.forEach(element => {
                        if (element.classList && !element.classList.contains('cursor') && !element.classList.contains('tie-line-svg')) {
                            lineData.elements.push({
                                html: element.outerHTML
                            });
                        }
                    });
                    
                    if (lineData.elements.length > 0) {
                        pageData.lines.push(lineData);
                    }
                });
                
                if (pageData.lines.length > 0) {
                    data.pages.push(pageData);
                }
            });
            
            localStorage.setItem('arrowScore', JSON.stringify(data));
            alert('ä¿å­˜æˆåŠŸï¼');
        }
        
        function loadScore() {
            const saved = localStorage.getItem('arrowScore');
            if (!saved) {
                alert('æ²¡æœ‰ä¿å­˜çš„ä¹è°±');
                return;
            }
            
            const data = JSON.parse(saved);
            document.getElementById('title').value = data.title;
            document.getElementById('scoreInfo').value = data.scoreInfo || '';
            document.getElementById('tempo').value = data.tempo;
            if (data.fontSize) {
                updateFontSize(data.fontSize);
                document.getElementById('fontSize').value = data.fontSize;
            }
            updateTitle();
            
            // æ¸…ç©ºç°æœ‰é¡µé¢
            const container = document.getElementById('scoreContainer');
            container.innerHTML = '';
            tieLinesData = [];
            
            // é‡æ–°åˆ›å»ºé¡µé¢
            data.pages.forEach((pageData, pageIndex) => {
                const pageHtml = `
                    <div class="score-page" id="page-${pageIndex + 1}" data-page="${pageIndex + 1}">
                        ${pageIndex === 0 ? `
                            <h1 class="score-title" id="scoreTitle">${data.title || 'æœªå‘½åä¹è°±'}</h1>
                            <div class="score-info">
                                <input type="text" id="scoreInfo" placeholder="è°ƒå·ï¼šCå¤§è°ƒ  æ‹å·ï¼š4/4  é€Ÿåº¦ï¼šAndante" value="${data.scoreInfo || ''}" />
                            </div>
                        ` : ''}
                        <div class="score-content">
                            <div id="scoreLines"></div>
                        </div>
                        <div class="page-indicator">ç¬¬ ${pageIndex + 1} é¡µ</div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', pageHtml);
                
                const pageElement = document.getElementById(`page-${pageIndex + 1}`);
                const scoreLines = pageElement.querySelector('#scoreLines');
                
                pageData.lines.forEach((lineData, lineIndex) => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'score-line' + (pageIndex === 0 && lineIndex === 0 ? ' active' : '');
                    if (lineData.isCentered) {
                        lineDiv.classList.add('centered');
                    }
                    lineDiv.dataset.line = lineIndex + 1;
                    lineDiv.dataset.page = pageIndex + 1;
                    lineDiv.style.marginTop = lineData.marginTop || '0';
                    lineDiv.style.marginBottom = lineData.marginBottom || '20px';
                    if (lineData.gap) {
                        lineDiv.style.gap = lineData.gap;
                    }
                    
                    lineData.elements.forEach(item => {
                        const temp = document.createElement('div');
                        temp.innerHTML = item.html;
                        lineDiv.appendChild(temp.firstChild);
                    });
                    
                    const cursor = document.createElement('div');
                    cursor.className = 'cursor';
                    if (!(pageIndex === 0 && lineIndex === 0)) {
                        cursor.classList.add('hidden');
                    }
                    lineDiv.appendChild(cursor);
                    
                    lineDiv.addEventListener('click', function() {
                        document.querySelectorAll('.score-line').forEach(l => l.classList.remove('active'));
                        document.querySelectorAll('.cursor').forEach(c => c.classList.add('hidden'));
                        this.classList.add('active');
                        const cursor = this.querySelector('.cursor');
                        if (cursor) {
                            cursor.classList.remove('hidden');
                        }
                    });
                    
                    scoreLines.appendChild(lineDiv);
                });
            });
            
            // æ¢å¤è¿éŸ³çº¿
            if (data.tieLines && data.tieLines.length > 0) {
                setTimeout(() => {
                    data.tieLines.forEach(tieData => {
                        const note1 = document.querySelector(`[data-note-id="${tieData.note1Id}"]`);
                        const note2 = document.querySelector(`[data-note-id="${tieData.note2Id}"]`);
                        
                        if (note1 && note2) {
                            const line = note1.closest('.score-line');
                            if (line) {
                                createTieLine(note1, note2);
                            }
                        }
                    });
                }, 100);
            }
            
            currentPage = data.pages.length || 1;
            currentLine = document.querySelectorAll('.score-line').length;
            updateLineSelector();
            alert('åŠ è½½æˆåŠŸï¼');
        }
        
        function exportScore() {
            saveScore();
            const data = localStorage.getItem('arrowScore');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (document.getElementById('title').value || 'æœªå‘½åä¹è°±') + '.json';
            a.click();
        }
        
        function printScore() {
            window.print();
        }
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œæ›´æ–°è¿éŸ³çº¿
        window.addEventListener('resize', () => {
            updateTieLinePositions();
        });
    </script>
</body>
</html>
