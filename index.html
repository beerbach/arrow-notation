<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>箭头谱专业编辑器 v6.0 - 优化版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #e0e0e0;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* SVG箭头样式 */
        .arrow-svg {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .arrow-svg.small {
            width: 16px;
            height: 16px;
        }
        
        .arrow-svg.large {
            width: var(--arrow-size, 24px);
            height: var(--arrow-size, 24px);
        }
        
        /* 控制面板 */
        .control-panel {
            width: 280px;
            min-width: 200px;
            max-width: 500px;
            background: white;
            border-right: 2px solid #ddd;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 10px;
            position: relative;
            transition: transform 0.3s ease;
        }
        
        .panel-resize-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }
        
        .panel-resize-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .panel-resize-btn:hover {
            background: #f0f0f0;
            border-color: #4a90e2;
        }
        
        .resize-handle {
            width: 5px;
            background: #999;
            cursor: col-resize;
            position: relative;
            transition: background 0.3s;
            flex-shrink: 0;
        }
        
        .resize-handle:hover {
            background: #4a90e2;
            width: 8px;
        }
        
        .panel-section {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            padding: 3px 8px;
            background: #f5f5f5;
            border-radius: 3px;
        }
        
        /* 时值选择 */
        .duration-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .duration-btn {
            padding: 6px 3px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 11px;
        }
        
        .duration-btn:hover {
            background: #f0f8ff;
            border-color: #4a90e2;
        }
        
        .duration-btn.active {
            background: #4a90e2;
            color: white;
            border-color: #357abd;
        }
        
        .duration-display {
            font-size: 16px;
            margin-bottom: 2px;
        }
        
        /* 特殊按钮 */
        .special-btn {
            padding: 6px 3px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            text-align: center;
        }
        
        .special-btn:hover {
            background: #fce4ec;
            border-color: #e91e63;
        }
        
        .special-btn.active {
            background: #e91e63;
            color: white;
            border-color: #c2185b;
        }
        
        /* 状态显示 */
        .triplet-status {
            margin-top: 5px;
            padding: 5px;
            background: #e8f5e9;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
            display: none;
        }
        
        .triplet-status.active {
            display: block;
        }
        
        .dot-checkbox {
            display: flex;
            align-items: center;
            margin-top: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .dot-checkbox input {
            margin-right: 8px;
        }
        
        /* 变音选择 */
        .modifier-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .modifier-btn {
            padding: 5px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            text-align: center;
        }
        
        .modifier-btn:hover {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .modifier-btn.active {
            background: #ff9800;
            color: white;
            border-color: #f57c00;
        }
        
        .modifier-example {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 1px;
        }
        
        /* 箭头音符 */
        .arrow-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }
        
        .arrow-btn {
            height: 50px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .arrow-btn:hover {
            background: #e8f5e9;
            border-color: #4caf50;
            transform: scale(1.05);
        }
        
        .arrow-symbol {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }
        
        .arrow-note {
            font-size: 10px;
            color: #666;
        }
        
        /* 控制按钮 */
        .beam-control {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .beam-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        
        .beam-btn:hover {
            background: #f0f0f0;
        }
        
        .beam-btn.active {
            background: #2196f3;
            color: white;
        }
        
        .beam-selection-status {
            margin-top: 5px;
            padding: 5px;
            background: #e3f2fd;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
            display: none;
        }
        
        .beam-selection-status.active {
            display: block;
        }
        
        .cursor-control {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .cursor-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .cursor-btn:hover {
            background: #ffebee;
            border-color: #f44336;
        }
        
        .spacing-control {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .spacing-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .spacing-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .other-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }
        
        .other-btn {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
        }
        
        .other-btn:hover {
            background: #f0f0f0;
        }
        
        /* 行距调整 */
        .line-spacing-control {
            margin-top: 10px;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .line-spacing-control select,
        .line-spacing-control button {
            padding: 4px 8px;
            font-size: 11px;
            margin: 2px;
        }
        
        /* 编辑区 */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            height: 50px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .toolbar input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        .toolbar-btn:hover {
            background: #f0f0f0;
        }
        
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: auto;
        }
        
        .font-size-control label {
            font-size: 12px;
        }
        
        .font-size-control input {
            width: 80px;
        }
        
        /* 乐谱容器 */
        .score-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .score-page {
            width: 210mm;
            min-height: 297mm;
            max-height: 297mm;
            background: white;
            margin: 0 auto 20px;
            padding: 20mm;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .score-title {
            text-align: center;
            font-size: 28px;
            margin-bottom: 13px;
            color: #333;
        }
        
        .score-info {
            text-align: left;
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .score-info input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            color: #666;
            outline: none;
            border-bottom: 1px dashed #ddd;
        }
        
        .score-info input:focus {
            border-bottom: 1px solid #4a90e2;
        }
        
        .score-content {
            flex: 1;
        }
        
        .score-line {
            min-height: 60px;
            margin-bottom: 20px;
            padding: 10px;
            border: 2px dashed #e0e0e0;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 13px;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .score-line:hover {
            background: #fafafa;
        }
        
        .score-line.active {
            border-color: #4a90e2;
            background: #f0f8ff;
        }
        
        .score-line.centered {
            justify-content: center;
            gap: 8px;
        }
        
        /* 音符组 */
        .note-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            font-size: var(--score-font-size, 24px);
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 -2px;
            padding: 2px 4px;
            border-radius: 4px;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .note-group:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .note-group.selected {
            background: rgba(66, 165, 245, 0.2) !important;
            box-shadow: 0 0 0 2px rgba(66, 165, 245, 0.5);
            border-radius: 4px;
            padding: 2px 4px;
        }
        
        .note-group.beam-selecting {
            background: rgba(255, 152, 0, 0.2) !important;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.5);
            animation: pulse 0.8s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .note-content {
            display: flex;
            align-items: center;
            font-weight: bold;
            position: relative;
            gap: 0;
        }
        
        .note-annotation {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: normal;
            color: #666;
        }
        
        .note-box {
            position: absolute;
            top: -9px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: bold;
            color: #000000;
            border: 1px solid #cccccc;
            padding: 1px 3px;
            border-radius: 3px;
            background: #f8f8f8;
            white-space: nowrap;
        }
        
        .note-modifier-left {
            font-size: 0.8em;
            margin-right: -1px;
            color: #666;
        }
        
        .note-modifier-right {
            font-size: 0.8em;
            margin-left: -1px;
            color: #666;
        }
        
        .note-arrow {
            font-size: 1em;
        }
        
        .note-extend {
            font-size: 0.9em;
            color: #666;
            margin-left: 0;
        }
        
        .note-dot {
            font-size: 0.8em;
            margin-left: 1px;
        }
        
        /* 连音线 - 关键样式 */
        .tie-container {
            position: absolute;
            pointer-events: none;
            z-index: 10;
        }
        
        .tie-line-svg {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            transition: none; /* 移除过渡以提高性能 */
        }
        
        .tie-selectable {
            transition: all 0.2s;
        }
        
        .tie-selectable:hover {
            background: rgba(74, 144, 226, 0.1);
            border-radius: 4px;
        }
        
        .tie-first-selected {
            background: rgba(74, 144, 226, 0.3) !important;
            border-radius: 4px;
            animation: pulse 1s infinite;
        }
        
        /* 三连音 */
        .triplet-group {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 0 2px;
        }
        
        .triplet-bracket {
            position: absolute;
            top: -10px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .triplet-notes {
            display: flex;
            gap: 5px;
        }
        
        /* 减时线 */
        .beam-container {
            position: relative;
            height: 10px;
            margin-top: 2px;
            width: 100%;
        }
        
        .beam-line {
            position: absolute;
            height: 2px;
            background: #333;
            width: 100%;
        }
        
        .beam-line.second {
            top: 4px;
        }
        
        .beam-group {
            display: inline-flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            margin: 0 2px;
        }
        
        .beam-group .note-groups {
            display: flex;
            gap: 5px;
        }
        
        .beam-group .smart-beams {
            position: relative;
            width: 100%;
            height: 10px;
            margin-top: 2px;
        }
        
        .beam-group .connected-beam {
            position: absolute;
            height: 2px;
            background: #333;
        }
        
        .beam-group .connected-beam.first {
            top: 0;
            width: 100%;
        }
        
        .beam-group .connected-beam.second {
            top: 4px;
        }
        
        /* 其他元素 */
        .spacer {
            display: inline-block;
            width: 3px;
            height: 1px;
        }
        
        .barline {
            width: 2px;
            height: 40px;
            background: #333;
            margin: 0 5px;
            position: relative;
            z-index: 1;
        }
        
        .repeat-sign {
            font-size: var(--score-font-size, 24px);
            font-weight: bold;
            margin: 0 3px;
        }
        
        .rest {
            font-size: var(--score-font-size, 24px);
            color: #666;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 2px;
        }
        
        /* 光标 */
        .cursor {
            width: 3px;
            height: 40px;
            background: #ff4444;
            animation: blink 1s infinite;
        }
        
        .cursor.hidden {
            display: none;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        /* 预览 */
        .current-selection {
            font-size: 20px;
            font-weight: bold;
            padding: 8px;
            background: #e3f2fd;
            border-radius: 4px;
            margin: 5px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .beam-status {
            margin-top: 5px;
            padding: 5px;
            background: #fff3e0;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
            display: none;
            color: #ff9800;
        }
        
        .beam-status.active {
            display: block;
        }
        
        .page-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
        }
        
        /* 响应式 */
        @media screen and (max-width: 768px) {
            .container {
                overflow-x: auto;
                min-width: 100%;
            }
            
            .control-panel {
                min-width: 250px;
                max-width: 70vw;
                overflow-x: auto;
            }
            
            .score-page {
                width: 100%;
                min-width: 600px;
                padding: 10mm;
            }
        }
        
        /* 打印样式 */
        @media print {
            body {
                background: white;
            }
            
            .control-panel,
            .toolbar,
            .resize-handle {
                display: none !important;
            }
            
            .score-container {
                padding: 0;
                background: white;
            }
            
            .score-page {
                width: 100%;
                height: auto;
                margin: 0;
                padding: 15mm;
                box-shadow: none;
                page-break-after: always;
            }
        }
        
        @page {
            size: A4;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- SVG定义 -->
    <svg style="display: none;">
        <defs>
            <symbol id="arrow-right" viewBox="0 0 100 100">
                <path d="M10,50 L70,50 M50,30 L70,50 L50,70" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="arrow-right-up" viewBox="0 0 100 100">
                <path d="M20,80 L70,30 M50,30 L70,30 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="arrow-up" viewBox="0 0 100 100">
                <path d="M50,90 L50,30 M30,50 L50,30 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="arrow-right-down" viewBox="0 0 100 100">
                <path d="M20,20 L70,70 M50,70 L70,70 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="arrow-down" viewBox="0 0 100 100">
                <path d="M50,10 L50,70 M30,50 L50,70 L70,50" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="arrow-left-down" viewBox="0 0 100 100">
                <path d="M80,20 L30,70 M30,50 L30,70 L50,70" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="arrow-left" viewBox="0 0 100 100">
                <path d="M90,50 L30,50 M50,30 L30,50 L50,70" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
            <symbol id="arrow-left-up" viewBox="0 0 100 100">
                <path d="M80,80 L30,30 M30,50 L30,30 L50,30" stroke="currentColor" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </symbol>
        </defs>
    </svg>
    
    <div class="container">
        <!-- 左侧控制面板 -->
        <div class="control-panel" id="controlPanel">
            <div class="panel-resize-controls">
                <button class="panel-resize-btn" onclick="app.resizePanel('smaller')">-</button>
                <button class="panel-resize-btn" onclick="app.resizePanel('reset')">○</button>
                <button class="panel-resize-btn" onclick="app.resizePanel('larger')">+</button>
            </div>
            
            <div class="panel-section">
                <div class="section-title">当前选择预览</div>
                <div class="current-selection" id="currentPreview">请选择音符</div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">1️⃣ 时值选择</div>
                <div class="duration-grid">
                    <button class="duration-btn active" data-duration="quarter">
                        <div class="duration-display">♩</div>
                        <div>四分</div>
                    </button>
                    <button class="duration-btn" data-duration="eighth">
                        <div class="duration-display">♪</div>
                        <div>八分</div>
                    </button>
                    <button class="duration-btn" data-duration="sixteenth">
                        <div class="duration-display">♬</div>
                        <div>十六分</div>
                    </button>
                    <button class="duration-btn" data-duration="half">
                        <div class="duration-display">𝅗𝅥</div>
                        <div>二分</div>
                    </button>
                    <button class="duration-btn" data-duration="whole">
                        <div class="duration-display">𝅝</div>
                        <div>全音符</div>
                    </button>
                    <button class="duration-btn special-btn" id="tripletBtn" data-duration="triplet">
                        <div class="duration-display">⌐3⌐</div>
                        <div>三连音</div>
                    </button>
                </div>
                
                <div class="triplet-status" id="tripletStatus">
                    三连音模式: <span id="tripletCount">0</span>/3
                </div>
                
                <div class="dot-checkbox">
                    <input type="checkbox" id="dotted" onchange="app.updateDotted()">
                    <label for="dotted">附点（延长一半时值）</label>
                </div>
                
                <div class="beam-control">
                    <button class="beam-btn" id="beamConnect">连接减时线</button>
                    <button class="beam-btn active" id="beamSeparate">断开减时线</button>
                </div>
                
                <div class="beam-selection-status" id="beamSelectionStatus">
                    选择要连接的音符: <span id="beamSelectionCount">0</span>个
                </div>
                
                <div class="beam-status" id="beamStatus">
                    连音组: <span id="beamCount">0</span>个音符
                </div>
                
                <div class="cursor-control">
                    <button class="cursor-btn" onclick="app.moveCursor('left')">←</button>
                    <button class="cursor-btn" onclick="app.moveCursor('right')">→</button>
                </div>
                
                <div class="spacing-control">
                    <button class="spacing-btn" onclick="app.adjustSelectedSpacing(-1)">← 缩进</button>
                    <button class="spacing-btn" onclick="app.adjustSelectedSpacing(1)">扩展 →</button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">2️⃣ 变音选择（可选）</div>
                <div class="modifier-grid">
                    <button class="modifier-btn active" data-modifier="none">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>标准</div>
                    </button>
                    <button class="modifier-btn" data-modifier="octave-down">
                        <div class="modifier-example">
                            -<svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>降八度</div>
                    </button>
                    <button class="modifier-btn" data-modifier="octave-up">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>-
                        </div>
                        <div>升八度</div>
                    </button>
                    <button class="modifier-btn" data-modifier="flat">
                        <div class="modifier-example">
                            _<svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>降半音♭</div>
                    </button>
                    <button class="modifier-btn" data-modifier="sharp">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>_
                        </div>
                        <div>升半音#</div>
                    </button>
                    <button class="modifier-btn" data-modifier="down-down">
                        <div class="modifier-example">
                            =<svg class="arrow-svg small"><use href="#arrow-up"/></svg>
                        </div>
                        <div>降八降半</div>
                    </button>
                    <button class="modifier-btn" data-modifier="up-up">
                        <div class="modifier-example">
                            <svg class="arrow-svg small"><use href="#arrow-up"/></svg>=
                        </div>
                        <div>升八升半</div>
                    </button>
                    <button class="modifier-btn" data-modifier="down-up">
                        <div class="modifier-example">
                            -<svg class="arrow-svg small"><use href="#arrow-up"/></svg>_
                        </div>
                        <div>降八升半</div>
                    </button>
                    <button class="modifier-btn" data-modifier="up-down">
                        <div class="modifier-example">
                            _<svg class="arrow-svg small"><use href="#arrow-up"/></svg>-
                        </div>
                        <div>升八降半</div>
                    </button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">3️⃣ 音符选择（点击输入）</div>
                <div class="arrow-grid">
                    <button class="arrow-btn" data-arrow="up" data-note="1" data-svg="arrow-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-up"/></svg>
                        </span>
                        <span class="arrow-note">1 do</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right-up" data-note="2" data-svg="arrow-right-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right-up"/></svg>
                        </span>
                        <span class="arrow-note">2 re</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right" data-note="3" data-svg="arrow-right">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right"/></svg>
                        </span>
                        <span class="arrow-note">3 mi</span>
                    </button>
                    <button class="arrow-btn" data-arrow="right-down" data-note="4" data-svg="arrow-right-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-right-down"/></svg>
                        </span>
                        <span class="arrow-note">4 fa</span>
                    </button>
                    <button class="arrow-btn" data-arrow="down" data-note="5" data-svg="arrow-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-down"/></svg>
                        </span>
                        <span class="arrow-note">5 sol</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left-down" data-note="6" data-svg="arrow-left-down">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left-down"/></svg>
                        </span>
                        <span class="arrow-note">6 la</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left" data-note="7" data-svg="arrow-left">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left"/></svg>
                        </span>
                        <span class="arrow-note">7 si</span>
                    </button>
                    <button class="arrow-btn" data-arrow="left-up" data-note="1'" data-svg="arrow-left-up">
                        <span class="arrow-symbol">
                            <svg class="arrow-svg"><use href="#arrow-left-up"/></svg>
                        </span>
                        <span class="arrow-note">高1do</span>
                    </button>
                    <button class="arrow-btn" data-arrow="○" data-note="0">
                        <span class="arrow-symbol">○</span>
                        <span class="arrow-note">0 休止</span>
                    </button>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-title">其他功能</div>
                <div class="other-controls">
                    <button class="other-btn" onclick="app.insertTie()">⌐ 连音线模式</button>
                    <button class="other-btn" onclick="app.insertSpacer()">␣ 空格</button>
                    <button class="other-btn" onclick="app.centerLine()">⊡ 居中对齐</button>
                    <button class="other-btn" onclick="app.insertAnnotation('R')">R 标注</button>
                    <button class="other-btn" onclick="app.insertAnnotation('L')">L 标注</button>
                    <button class="other-btn" onclick="app.insertBox('盒1')">盒1 标注</button>
                    <button class="other-btn" onclick="app.insertBox('盒2')">盒2 标注</button>
                    <button class="other-btn" onclick="app.insertBarline()">| 小节线</button>
                    <button class="other-btn" onclick="app.insertDoubleBar()">|| 终止线</button>
                    <button class="other-btn" onclick="app.insertRepeat(':|')">:| 前反复</button>
                    <button class="other-btn" onclick="app.insertRepeat('|:')">|: 后反复</button>
                    <button class="other-btn" onclick="app.deleteLast()">删除</button>
                    <button class="other-btn" onclick="app.clearLine()">清空行</button>
                    <button class="other-btn" onclick="app.deleteLine()">删除行</button>
                    <button class="other-btn" onclick="app.newLine()">新行</button>
                    <button class="other-btn" onclick="app.newPage()">新页</button>
                    <button class="other-btn" onclick="app.deletePage()">删除页</button>
                </div>
                
                <div class="line-spacing-control">
                    <div class="section-title">行距调整</div>
                    <select id="lineSelect">
                        <option value="1-1">第1页-第1行</option>
                    </select>
                    <button onclick="app.adjustLineSpacing('top', -5)">↑减少上距</button>
                    <button onclick="app.adjustLineSpacing('top', 5)">↓增加上距</button>
                    <button onclick="app.adjustLineSpacing('bottom', -5)">↑减少下距</button>
                    <button onclick="app.adjustLineSpacing('bottom', 5)">↓增加下距</button>
                </div>
            </div>
        </div>
        
        <div class="resize-handle" id="resizeHandle"></div>
        
        <!-- 右侧编辑区 -->
        <div class="editor-area" id="editorArea">
            <div class="toolbar">
                <input type="text" id="title" placeholder="输入曲名" oninput="app.updateTitle()">
                <select id="tempo">
                    <option value="60">♩=60</option>
                    <option value="80">♩=80</option>
                    <option value="100">♩=100</option>
                    <option value="120" selected>♩=120</option>
                    <option value="140">♩=140</option>
                </select>
                <button class="toolbar-btn" onclick="app.saveScore()">保存</button>
                <button class="toolbar-btn" onclick="app.loadScore()">加载</button>
                <button class="toolbar-btn" onclick="app.exportScore()">导出</button>
                <button class="toolbar-btn" onclick="app.printScore()">打印</button>
                
                <div class="font-size-control">
                    <label>字体大小:</label>
                    <input type="range" id="fontSize" min="16" max="40" value="24" oninput="app.updateFontSize(this.value)">
                    <span id="fontSizeValue">24px</span>
                </div>
            </div>
            
            <div class="score-container" id="scoreContainer">
                <div class="score-page" id="page-1" data-page="1">
                    <h1 class="score-title" id="scoreTitle">未命名乐谱</h1>
                    <div class="score-info">
                        <input type="text" id="scoreInfo" placeholder="调号：C大调  拍号：4/4  速度：Andante" />
                    </div>
                    <div class="score-content">
                        <div id="scoreLines">
                            <div class="score-line active" data-line="1" data-page="1">
                                <div class="cursor"></div>
                            </div>
                        </div>
                    </div>
                    <div class="page-indicator">第 1 页</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 应用主对象
        const app = {
            // 状态管理
            state: {
                currentDuration: 'quarter',
                currentModifier: 'none',
                isDotted: false,
                beamMode: 'separate',
                currentLine: 1,
                currentPage: 1,
                beamGroup: [],
                beamSelectionMode: false,
                beamSelectedNotes: [],
                fontSize: 24,
                lastNote: null,
                isTripletMode: false,
                tripletGroup: [],
                pendingAnnotation: null,
                pendingBox: null,
                selectedNote: null,
                tieMode: false,
                firstTieNote: null,
                panelScale: 1
            },
            
            // 连音线管理器 - 核心改进
            tieManager: {
                lines: [],
                
                add(note1, note2, line) {
                    const svg = this.createSvg(note1, note2, line);
                    if (svg) {
                        this.lines.push({
                            note1,
                            note2,
                            line,
                            svg,
                            id: Date.now() + Math.random()
                        });
                    }
                },
                
                createSvg(note1, note2, line) {
                    if (!note1 || !note2 || !line) return null;
                    
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    const rect1 = note1.getBoundingClientRect();
                    const rect2 = note2.getBoundingClientRect();
                    const lineRect = line.getBoundingClientRect();
                    
                    const fontSize = parseFloat(getComputedStyle(note1).fontSize) || app.state.fontSize;
                    const scale = fontSize / 24; // 基准是24px
                    
                    const x1 = rect1.left + rect1.width/2 - lineRect.left;
                    const x2 = rect2.left + rect2.width/2 - lineRect.left;
                    const yOffset = fontSize * 0.7;
                    
                    const note1Top = rect1.top - lineRect.top;
                    const note2Top = rect2.top - lineRect.top;
                    const y = Math.min(note1Top, note2Top) - yOffset;
                    
                    svg.style.cssText = `
                        position: absolute;
                        left: ${Math.min(x1, x2)}px;
                        top: ${y}px;
                        width: ${Math.abs(x2 - x1)}px;
                        height: ${fontSize * 1.5}px;
                        pointer-events: none;
                        overflow: visible;
                        z-index: 10;
                    `;
                    svg.classList.add('tie-line-svg');
                    
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const startX = x1 < x2 ? 0 : Math.abs(x2 - x1);
                    const endX = x1 < x2 ? Math.abs(x2 - x1) : 0;
                    const midX = Math.abs(endX - startX) / 2;
                    const curveHeight = fontSize * 1.2;
                    const controlY = fontSize * 0.3;
                    
                    path.setAttribute('d', 
                        `M ${startX} ${curveHeight} Q ${midX} ${controlY}, ${endX} ${curveHeight}`
                    );
                    path.setAttribute('stroke', '#333');
                    path.setAttribute('stroke-width', Math.max(1, scale * 1.5));
                    path.setAttribute('fill', 'none');
                    
                    svg.appendChild(path);
                    line.appendChild(svg);
                    
                    return svg;
                },
                
                redrawAll() {
                    // 使用requestAnimationFrame优化性能
                    requestAnimationFrame(() => {
                        this.lines.forEach(tie => {
                            if (tie.svg && tie.svg.parentNode) {
                                tie.svg.remove();
                            }
                            if (tie.note1 && tie.note2 && tie.line) {
                                const newSvg = this.createSvg(tie.note1, tie.note2, tie.line);
                                if (newSvg) {
                                    tie.svg = newSvg;
                                }
                            }
                        });
                    });
                },
                
                removeForLine(line) {
                    this.lines = this.lines.filter(tie => {
                        if (tie.line === line) {
                            if (tie.svg && tie.svg.parentNode) {
                                tie.svg.remove();
                            }
                            return false;
                        }
                        return true;
                    });
                },
                
                getDataForSave() {
                    return this.lines.map(tie => {
                        const line = tie.line;
                        const notes = Array.from(line.querySelectorAll('.note-group'));
                        return {
                            lineIndex: Array.from(document.querySelectorAll('.score-line')).indexOf(line),
                            note1Index: notes.indexOf(tie.note1),
                            note2Index: notes.indexOf(tie.note2)
                        };
                    }).filter(data => 
                        data.lineIndex !== -1 && 
                        data.note1Index !== -1 && 
                        data.note2Index !== -1
                    );
                },
                
                restoreFromData(data) {
                    if (!data || !data.length) return;
                    
                    setTimeout(() => {
                        const lines = document.querySelectorAll('.score-line');
                        data.forEach(tieData => {
                            const line = lines[tieData.lineIndex];
                            if (line) {
                                const notes = line.querySelectorAll('.note-group');
                                const note1 = notes[tieData.note1Index];
                                const note2 = notes[tieData.note2Index];
                                if (note1 && note2) {
                                    this.add(note1, note2, line);
                                }
                            }
                        });
                    }, 100);
                }
            },
            
            // 初始化
            init() {
                this.initEventListeners();
                this.initKeyboardShortcuts();
                this.initResizeHandle();
                this.updatePreview();
                document.documentElement.style.setProperty('--arrow-size', '24px');
            },
            
            // 字体大小更新 - 核心功能
            updateFontSize(size) {
                this.state.fontSize = size;
                document.getElementById('fontSizeValue').textContent = size + 'px';
                document.documentElement.style.setProperty('--score-font-size', size + 'px');
                document.documentElement.style.setProperty('--arrow-size', size + 'px');
                
                // 立即重绘所有连音线
                this.tieManager.redrawAll();
            },
            
            // 连音线功能
            insertTie() {
                if (!this.state.tieMode) {
                    this.state.tieMode = true;
                    this.state.firstTieNote = null;
                    alert('请点击第一个音符，然后点击第二个音符来添加连音线');
                    document.querySelectorAll('.note-group').forEach(note => {
                        note.style.cursor = 'crosshair';
                        note.classList.add('tie-selectable');
                    });
                } else {
                    this.exitTieMode();
                }
            },
            
            exitTieMode() {
                this.state.tieMode = false;
                this.state.firstTieNote = null;
                document.querySelectorAll('.note-group').forEach(note => {
                    note.style.cursor = 'pointer';
                    note.classList.remove('tie-selectable', 'tie-first-selected');
                });
            },
            
            handleTieSelection(noteElement) {
                if (!this.state.tieMode) return false;
                
                if (!this.state.firstTieNote) {
                    this.state.firstTieNote = noteElement;
                    noteElement.classList.add('tie-first-selected');
                    return true;
                } else if (noteElement !== this.state.firstTieNote) {
                    const line = this.state.firstTieNote.closest('.score-line');
                    this.tieManager.add(this.state.firstTieNote, noteElement, line);
                    this.exitTieMode();
                    return true;
                }
                return false;
            },
            
            // 事件监听器初始化
            initEventListeners() {
                // 时值按钮
                document.querySelectorAll('.duration-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.dataset.duration === 'triplet') {
                            this.toggleTriplet();
                        } else {
                            document.querySelectorAll('.duration-btn').forEach(b => {
                                if (b.dataset.duration !== 'triplet') b.classList.remove('active');
                            });
                            btn.classList.add('active');
                            this.state.currentDuration = btn.dataset.duration;
                            this.updatePreview();
                        }
                    });
                });
                
                // 变音按钮
                document.querySelectorAll('.modifier-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.modifier-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.state.currentModifier = btn.dataset.modifier;
                        this.updatePreview();
                    });
                });
                
                // 箭头按钮
                document.querySelectorAll('.arrow-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const arrow = btn.dataset.arrow;
                        const note = btn.dataset.note;
                        const svg = btn.dataset.svg;
                        
                        if (arrow === '○') {
                            this.insertRest();
                        } else {
                            this.state.lastNote = { arrow, note, svg, modifier: this.state.currentModifier };
                            if (this.state.isTripletMode) {
                                this.insertTripletNote(arrow, note, svg);
                            } else {
                                this.insertNote(arrow, note, svg);
                            }
                        }
                    });
                });
                
                // 减时线控制
                document.getElementById('beamConnect').addEventListener('click', () => {
                    if (!this.state.beamSelectionMode) {
                        this.enterBeamSelectionMode();
                    } else {
                        this.completeBeamConnection();
                    }
                });
                
                document.getElementById('beamSeparate').addEventListener('click', () => {
                    if (this.state.beamSelectionMode) {
                        this.exitBeamSelectionMode();
                    }
                    this.state.beamMode = 'separate';
                    document.getElementById('beamSeparate').classList.add('active');
                    document.getElementById('beamConnect').classList.remove('active');
                });
                
                // 音符点击事件
                document.addEventListener('click', (e) => {
                    const noteGroup = e.target.closest('.note-group');
                    
                    if (noteGroup) {
                        e.stopPropagation();
                        
                        if (this.state.beamSelectionMode) {
                            this.handleBeamNoteSelection(noteGroup);
                            return;
                        }
                        
                        if (this.state.tieMode) {
                            if (this.handleTieSelection(noteGroup)) {
                                return;
                            }
                        }
                        
                        document.querySelectorAll('.note-group.selected').forEach(n => {
                            n.classList.remove('selected');
                        });
                        
                        noteGroup.classList.add('selected');
                        this.state.selectedNote = noteGroup;
                    }
                }, true);
                
                // 行点击事件
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('score-line')) {
                        e.stopPropagation();
                        
                        document.querySelectorAll('.score-line').forEach(l => {
                            l.classList.remove('active');
                            const cursor = l.querySelector('.cursor');
                            if (cursor) cursor.classList.add('hidden');
                        });
                        
                        e.target.classList.add('active');
                        const cursor = e.target.querySelector('.cursor');
                        if (cursor) cursor.classList.remove('hidden');
                    }
                });
                
                // 窗口大小改变时重绘连音线
                window.addEventListener('resize', this.debounce(() => {
                    this.tieManager.redrawAll();
                }, 200));
            },
            
            // 防抖函数
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            // 插入音符
            insertNote(arrow, note, svg) {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) {
                    alert('请先选择一个行');
                    return;
                }
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                const noteElement = this.createNoteElement(arrow, note, svg);
                
                if (this.state.pendingAnnotation) {
                    const annotation = document.createElement('span');
                    annotation.className = 'note-annotation';
                    annotation.textContent = this.state.pendingAnnotation;
                    noteElement.querySelector('.note-content').appendChild(annotation);
                    this.state.pendingAnnotation = null;
                }
                
                if (this.state.pendingBox) {
                    const box = document.createElement('span');
                    box.className = 'note-box';
                    box.textContent = this.state.pendingBox;
                    noteElement.querySelector('.note-content').appendChild(box);
                    this.state.pendingBox = null;
                }
                
                activeLine.insertBefore(noteElement, cursor);
                this.checkPageOverflow();
            },
            
            // 创建音符元素
            createNoteElement(arrow, note, svg) {
                const noteGroup = document.createElement('div');
                noteGroup.className = 'note-group';
                
                let noteHTML = '<div class="note-content">';
                
                // 处理左侧修饰符
                if (this.state.currentModifier === 'flat') {
                    noteHTML += '<span class="note-modifier-left">_</span>';
                } else if (this.state.currentModifier === 'octave-down') {
                    noteHTML += '<span class="note-modifier-left">-</span>';
                } else if (this.state.currentModifier === 'down-down') {
                    noteHTML += '<span class="note-modifier-left">=</span>';
                } else if (this.state.currentModifier === 'up-down') {
                    noteHTML += '<span class="note-modifier-left">_</span>';
                } else if (this.state.currentModifier === 'down-up') {
                    noteHTML += '<span class="note-modifier-left">-</span>';
                }
                
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${svg}"/></svg></span>`;
                
                // 处理右侧修饰符
                if (this.state.currentModifier === 'sharp') {
                    noteHTML += '<span class="note-modifier-right">_</span>';
                } else if (this.state.currentModifier === 'octave-up') {
                    noteHTML += '<span class="note-modifier-right">-</span>';
                } else if (this.state.currentModifier === 'up-up') {
                    noteHTML += '<span class="note-modifier-right">=</span>';
                } else if (this.state.currentModifier === 'up-down') {
                    noteHTML += '<span class="note-modifier-right">-</span>';
                } else if (this.state.currentModifier === 'down-up') {
                    noteHTML += '<span class="note-modifier-right">_</span>';
                }
                
                if (this.state.currentDuration === 'half') {
                    noteHTML += '<span class="note-extend">~</span>';
                } else if (this.state.currentDuration === 'whole') {
                    noteHTML += '<span class="note-extend">~~~</span>';
                }
                
                if (this.state.isDotted) {
                    noteHTML += '<span class="note-dot">·</span>';
                }
                
                noteHTML += '</div>';
                
                if (this.state.beamMode === 'separate' && 
                    (this.state.currentDuration === 'eighth' || this.state.currentDuration === 'sixteenth')) {
                    noteHTML += '<div class="beam-container">';
                    noteHTML += '<div class="beam-line"></div>';
                    if (this.state.currentDuration === 'sixteenth') {
                        noteHTML += '<div class="beam-line second"></div>';
                    }
                    noteHTML += '</div>';
                }
                
                noteGroup.innerHTML = noteHTML;
                noteGroup.dataset.note = note;
                noteGroup.dataset.duration = this.state.currentDuration;
                noteGroup.dataset.modifier = this.state.currentModifier;
                noteGroup.dataset.dotted = this.state.isDotted;
                noteGroup.dataset.arrow = arrow;
                noteGroup.dataset.svg = svg;
                
                // 确保可点击
                noteGroup.style.cursor = 'pointer';
                const allChildren = noteGroup.querySelectorAll('*');
                allChildren.forEach(child => {
                    child.style.pointerEvents = 'none';
                });
                
                return noteGroup;
            },
            
            // 其他功能函数
            insertRest() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) {
                    alert('请先选择一个行');
                    return;
                }
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                const rest = document.createElement('div');
                rest.className = 'rest';
                
                let restContent = '<div>○</div>';
                
                if (this.state.currentDuration === 'eighth' || this.state.currentDuration === 'sixteenth') {
                    restContent += '<div class="beam-container">';
                    if (this.state.currentDuration === 'eighth') {
                        restContent += '<div class="beam-line"></div>';
                    } else {
                        restContent += '<div class="beam-line"></div>';
                        restContent += '<div class="beam-line second"></div>';
                    }
                    restContent += '</div>';
                } else if (this.state.currentDuration === 'half') {
                    restContent = '<div>○~</div>';
                } else if (this.state.currentDuration === 'whole') {
                    restContent = '<div>○~~~</div>';
                }
                
                if (this.state.isDotted) {
                    restContent = restContent.replace('</div>', '·</div>');
                }
                
                rest.innerHTML = restContent;
                rest.dataset.duration = this.state.currentDuration;
                
                activeLine.insertBefore(rest, cursor);
                this.checkPageOverflow();
            },
            
            insertSpacer() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                const spacer = document.createElement('div');
                spacer.className = 'spacer';
                activeLine.insertBefore(spacer, cursor);
            },
            
            insertBarline() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                const barline = document.createElement('div');
                barline.className = 'barline';
                activeLine.insertBefore(barline, cursor);
            },
            
            insertDoubleBar() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                const doubleBar = document.createElement('div');
                doubleBar.className = 'barline';
                doubleBar.style.width = '6px';
                doubleBar.style.borderLeft = '2px solid #333';
                doubleBar.style.borderRight = '2px solid #333';
                activeLine.insertBefore(doubleBar, cursor);
            },
            
            insertRepeat(type) {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                const repeat = document.createElement('div');
                repeat.className = 'repeat-sign';
                repeat.innerHTML = type;
                activeLine.insertBefore(repeat, cursor);
            },
            
            insertAnnotation(type) {
                this.state.pendingAnnotation = type;
            },
            
            insertBox(type) {
                this.state.pendingBox = type;
            },
            
            moveCursor(direction) {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                if (direction === 'left') {
                    const prev = cursor.previousElementSibling;
                    if (prev && !prev.classList.contains('tie-line-svg')) {
                        activeLine.insertBefore(cursor, prev);
                    }
                } else if (direction === 'right') {
                    let next = cursor.nextElementSibling;
                    while (next && next.classList.contains('tie-line-svg')) {
                        next = next.nextElementSibling;
                    }
                    if (next) {
                        activeLine.insertBefore(cursor, next.nextElementSibling);
                    }
                }
            },
            
            adjustSelectedSpacing(direction) {
                if (!this.state.selectedNote) {
                    alert('请先点击选择一个音符');
                    return;
                }
                
                const noteContent = this.state.selectedNote.querySelector('.note-content');
                if (!noteContent) return;
                
                const modifierLeft = noteContent.querySelector('.note-modifier-left');
                const modifierRight = noteContent.querySelector('.note-modifier-right');
                
                if (modifierLeft) {
                    let currentMargin = parseInt(modifierLeft.style.marginRight || '1');
                    modifierLeft.style.marginRight = Math.max(0, currentMargin + direction) + 'px';
                }
                
                if (modifierRight) {
                    let currentMargin = parseInt(modifierRight.style.marginLeft || '1');
                    modifierRight.style.marginLeft = Math.max(0, currentMargin + direction) + 'px';
                }
            },
            
            deleteLast() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                const cursor = activeLine.querySelector('.cursor');
                if (!cursor) return;
                
                let prev = cursor.previousElementSibling;
                while (prev && prev.classList.contains('tie-line-svg')) {
                    prev = prev.previousElementSibling;
                }
                
                if (prev) {
                    prev.remove();
                }
            },
            
            clearLine() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                this.tieManager.removeForLine(activeLine);
                activeLine.innerHTML = '<div class="cursor"></div>';
                this.state.beamSelectedNotes = [];
                this.state.tripletGroup = [];
            },
            
            deleteLine() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) return;
                
                const currentPageNum = activeLine.dataset.page;
                const currentPageElement = document.getElementById(`page-${currentPageNum}`);
                const linesInPage = currentPageElement.querySelectorAll('.score-line');
                
                if (currentPageNum === '1' && linesInPage.length === 1) {
                    alert('不能删除第一页的最后一行');
                    return;
                }
                
                if (!confirm('确定要删除这一行吗？')) return;
                
                this.tieManager.removeForLine(activeLine);
                
                let newActiveLine = activeLine.nextElementSibling || activeLine.previousElementSibling;
                activeLine.remove();
                
                if (linesInPage.length === 1 && currentPageNum !== '1') {
                    currentPageElement.remove();
                    this.renumberPages();
                    const prevPage = document.getElementById(`page-${parseInt(currentPageNum) - 1}`);
                    if (prevPage) {
                        const prevPageLines = prevPage.querySelectorAll('.score-line');
                        if (prevPageLines.length > 0) {
                            newActiveLine = prevPageLines[prevPageLines.length - 1];
                        }
                    }
                }
                
                if (newActiveLine && newActiveLine.classList.contains('score-line')) {
                    document.querySelectorAll('.score-line').forEach(l => l.classList.remove('active'));
                    newActiveLine.classList.add('active');
                    const cursor = newActiveLine.querySelector('.cursor');
                    if (cursor) cursor.classList.remove('hidden');
                }
                
                this.renumberLines();
                this.updateLineSelector();
            },
            
            newLine(inNewPage = false) {
                if (this.state.beamSelectionMode) {
                    alert('请先完成当前减时线连接或退出选择模式');
                    return;
                }
                
                document.querySelectorAll('.score-line').forEach(line => {
                    line.classList.remove('active');
                    const cursor = line.querySelector('.cursor');
                    if (cursor) cursor.classList.add('hidden');
                });
                
                const pageToUse = inNewPage ? this.state.currentPage : 
                    (document.querySelector('.score-line.active')?.dataset.page || this.state.currentPage);
                const pageElement = document.getElementById(`page-${pageToUse}`);
                const scoreLines = pageElement.querySelector('.score-content #scoreLines, .score-content');
                
                this.state.currentLine++;
                const newLineDiv = document.createElement('div');
                newLineDiv.className = 'score-line active';
                newLineDiv.dataset.line = this.state.currentLine;
                newLineDiv.dataset.page = pageToUse;
                newLineDiv.innerHTML = '<div class="cursor"></div>';
                
                newLineDiv.addEventListener('click', function(e) {
                    e.stopPropagation();
                    document.querySelectorAll('.score-line').forEach(l => {
                        l.classList.remove('active');
                        const cursor = l.querySelector('.cursor');
                        if (cursor) cursor.classList.add('hidden');
                    });
                    this.classList.add('active');
                    const cursor = this.querySelector('.cursor');
                    if (cursor) cursor.classList.remove('hidden');
                });
                
                if (scoreLines.id === 'scoreLines') {
                    scoreLines.appendChild(newLineDiv);
                } else {
                    let linesContainer = scoreLines.querySelector('#scoreLines');
                    if (!linesContainer) {
                        linesContainer = document.createElement('div');
                        linesContainer.id = 'scoreLines';
                        scoreLines.appendChild(linesContainer);
                    }
                    linesContainer.appendChild(newLineDiv);
                }
                
                this.updateLineSelector();
                this.checkPageOverflow();
            },
            
            newPage() {
                if (this.state.beamSelectionMode) {
                    alert('请先完成当前减时线连接或退出选择模式');
                    return;
                }
                
                this.createNewPage();
                this.newLine(true);
            },
            
            createNewPage() {
                this.state.currentPage++;
                const container = document.getElementById('scoreContainer');
                
                const newPageHtml = `
                    <div class="score-page" id="page-${this.state.currentPage}" data-page="${this.state.currentPage}">
                        <div class="score-content">
                            <div id="scoreLines"></div>
                        </div>
                        <div class="page-indicator">第 ${this.state.currentPage} 页</div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', newPageHtml);
                this.updateLineSelector();
            },
            
            deletePage() {
                const allPages = document.querySelectorAll('.score-page');
                
                if (allPages.length <= 1) {
                    alert('不能删除最后一页');
                    return;
                }
                
                const activeLine = document.querySelector('.score-line.active');
                let currentPageNum = 1;
                
                if (activeLine) {
                    currentPageNum = parseInt(activeLine.dataset.page);
                }
                
                const pageToDelete = document.getElementById(`page-${currentPageNum}`);
                if (!pageToDelete) {
                    alert('找不到要删除的页面');
                    return;
                }
                
                if (!confirm(`确定要删除第 ${currentPageNum} 页吗？该页上的所有内容都将被删除。`)) {
                    return;
                }
                
                const linesInPage = pageToDelete.querySelectorAll('.score-line');
                linesInPage.forEach(line => {
                    this.tieManager.removeForLine(line);
                });
                
                pageToDelete.remove();
                this.renumberPages();
                this.renumberLines();
                this.state.currentPage = document.querySelectorAll('.score-page').length;
                
                const firstPageFirstLine = document.querySelector('.score-page .score-line');
                if (firstPageFirstLine) {
                    document.querySelectorAll('.score-line').forEach(l => {
                        l.classList.remove('active');
                        const cursor = l.querySelector('.cursor');
                        if (cursor) cursor.classList.add('hidden');
                    });
                    firstPageFirstLine.classList.add('active');
                    const cursor = firstPageFirstLine.querySelector('.cursor');
                    if (cursor) cursor.classList.remove('hidden');
                }
                
                this.updateLineSelector();
            },
            
            centerLine() {
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) {
                    alert('请先选择要居中的行');
                    return;
                }
                
                const hasContent = Array.from(activeLine.children).some(child => 
                    !child.classList.contains('cursor') && !child.classList.contains('tie-line-svg')
                );
                
                if (!hasContent) {
                    alert('当前行没有内容');
                    return;
                }
                
                if (activeLine.classList.contains('centered')) {
                    activeLine.classList.remove('centered');
                    const noteGroups = activeLine.querySelectorAll('.note-group, .triplet-group, .beam-group, .rest, .barline, .repeat-sign');
                    noteGroups.forEach(group => {
                        group.style.marginLeft = '';
                        group.style.marginRight = '';
                    });
                } else {
                    activeLine.classList.add('centered');
                    const totalElements = activeLine.querySelectorAll('.note-group, .triplet-group, .beam-group, .rest, .barline, .repeat-sign, .spacer').length;
                    
                    if (totalElements > 20) {
                        activeLine.style.gap = '3px';
                    } else if (totalElements > 10) {
                        activeLine.style.gap = '5px';
                    } else {
                        activeLine.style.gap = '8px';
                    }
                    
                    const barlines = activeLine.querySelectorAll('.barline');
                    barlines.forEach(barline => {
                        barline.style.marginLeft = '10px';
                        barline.style.marginRight = '10px';
                    });
                    
                    const repeatSigns = activeLine.querySelectorAll('.repeat-sign');
                    repeatSigns.forEach(sign => {
                        sign.style.marginLeft = '8px';
                        sign.style.marginRight = '8px';
                    });
                }
            },
            
            adjustLineSpacing(type, value) {
                const lineValue = document.getElementById('lineSelect').value;
                const [pageNum, lineNum] = lineValue.split('-');
                const line = document.querySelector(`.score-line[data-page="${pageNum}"][data-line="${lineNum}"]`);
                
                if (line) {
                    if (type === 'top') {
                        let currentTop = parseInt(line.style.marginTop || 0);
                        line.style.marginTop = Math.max(0, currentTop + value) + 'px';
                    } else if (type === 'bottom') {
                        let currentBottom = parseInt(line.style.marginBottom || 20);
                        line.style.marginBottom = Math.max(0, currentBottom + value) + 'px';
                    }
                }
            },
            
            updateDotted() {
                this.state.isDotted = document.getElementById('dotted').checked;
                this.updatePreview();
            },
            
            updatePreview() {
                const preview = document.getElementById('currentPreview');
                let html = '';
                
                const arrow = '<svg class="arrow-svg"><use href="#arrow-right"/></svg>';
                
                if (this.state.currentModifier === 'sharp') {
                    html = `${arrow}_`;
                } else if (this.state.currentModifier === 'flat') {
                    html = `_${arrow}`;
                } else if (this.state.currentModifier === 'octave-up') {
                    html = `${arrow}-`;
                } else if (this.state.currentModifier === 'octave-down') {
                    html = `-${arrow}`;
                } else if (this.state.currentModifier === 'up-up') {
                    html = `${arrow}=`;
                } else if (this.state.currentModifier === 'down-down') {
                    html = `=${arrow}`;
                } else if (this.state.currentModifier === 'up-down') {
                    html = `_${arrow}-`;
                } else if (this.state.currentModifier === 'down-up') {
                    html = `-${arrow}_`;
                } else {
                    html = arrow;
                }
                
                if (this.state.currentDuration === 'half') {
                    html += '~';
                } else if (this.state.currentDuration === 'whole') {
                    html += '~~~';
                }
                
                if (this.state.isDotted) {
                    html += '·';
                }
                
                if (this.state.currentDuration === 'eighth' || this.state.currentDuration === 'sixteenth') {
                    html += '<div style="margin-top:2px;">';
                    if (this.state.currentDuration === 'eighth') {
                        html += '─';
                    } else {
                        html += '══';
                    }
                    html += '</div>';
                }
                
                preview.innerHTML = html;
            },
            
            updateTitle() {
                const title = document.getElementById('title').value;
                document.getElementById('scoreTitle').textContent = title || '未命名乐谱';
            },
            
            updateLineSelector() {
                const select = document.getElementById('lineSelect');
                select.innerHTML = '';
                
                document.querySelectorAll('.score-line').forEach(line => {
                    const pageNum = line.dataset.page || 1;
                    const lineNum = line.dataset.line;
                    const option = document.createElement('option');
                    option.value = `${pageNum}-${lineNum}`;
                    option.textContent = `第${pageNum}页-第${lineNum}行`;
                    select.appendChild(option);
                });
            },
            
            renumberPages() {
                const allPages = document.querySelectorAll('.score-page');
                allPages.forEach((page, index) => {
                    const newPageNum = index + 1;
                    page.id = `page-${newPageNum}`;
                    page.dataset.page = newPageNum;
                    
                    const indicator = page.querySelector('.page-indicator');
                    if (indicator) {
                        indicator.textContent = `第 ${newPageNum} 页`;
                    }
                    
                    const lines = page.querySelectorAll('.score-line');
                    lines.forEach(line => {
                        line.dataset.page = newPageNum;
                    });
                });
            },
            
            renumberLines() {
                let globalLineNumber = 1;
                document.querySelectorAll('.score-line').forEach(line => {
                    line.dataset.line = globalLineNumber;
                    globalLineNumber++;
                });
                this.state.currentLine = globalLineNumber - 1;
            },
            
            checkPageOverflow() {
                const currentPageElement = document.getElementById(`page-${this.state.currentPage}`);
                if (!currentPageElement) return;
                
                const scoreContent = currentPageElement.querySelector('.score-content');
                const maxHeight = 257 * 3.78; // 257mm转换为像素（约970px）
                
                if (scoreContent.scrollHeight > maxHeight) {
                    const lastLine = scoreContent.lastElementChild;
                    if (lastLine && lastLine.classList.contains('score-line')) {
                        this.createNewPage();
                        const newPage = document.getElementById(`page-${this.state.currentPage}`);
                        const newScoreLines = newPage.querySelector('#scoreLines');
                        newScoreLines.appendChild(lastLine);
                    }
                }
            },
            
            // 三连音功能
            toggleTriplet() {
                this.state.isTripletMode = !this.state.isTripletMode;
                const btn = document.getElementById('tripletBtn');
                const status = document.getElementById('tripletStatus');
                
                if (this.state.isTripletMode) {
                    btn.classList.add('active');
                    status.classList.add('active');
                    this.state.tripletGroup = [];
                    this.updateTripletStatus();
                } else {
                    btn.classList.remove('active');
                    status.classList.remove('active');
                    this.state.tripletGroup = [];
                }
            },
            
            updateTripletStatus() {
                document.getElementById('tripletCount').textContent = this.state.tripletGroup.length;
            },
            
            insertTripletNote(arrow, note, svg) {
                const noteElement = this.createNoteElement(arrow, note, svg);
                this.state.tripletGroup.push(noteElement);
                this.updateTripletStatus();
                
                if (this.state.tripletGroup.length === 3) {
                    const activeLine = document.querySelector('.score-line.active');
                    if (!activeLine) {
                        alert('请先选择一个行');
                        this.state.tripletGroup = [];
                        return;
                    }
                    
                    const cursor = activeLine.querySelector('.cursor');
                    
                    const tripletContainer = document.createElement('div');
                    tripletContainer.className = 'triplet-group';
                    
                    const bracket = document.createElement('div');
                    bracket.className = 'triplet-bracket';
                    bracket.innerHTML = '⌐3⌐';
                    
                    const notesContainer = document.createElement('div');
                    notesContainer.className = 'triplet-notes';
                    
                    this.state.tripletGroup.forEach(n => {
                        notesContainer.appendChild(n);
                    });
                    
                    tripletContainer.appendChild(bracket);
                    tripletContainer.appendChild(notesContainer);
                    
                    activeLine.insertBefore(tripletContainer, cursor);
                    
                    this.state.tripletGroup = [];
                    this.state.isTripletMode = false;
                    document.getElementById('tripletBtn').classList.remove('active');
                    document.getElementById('tripletStatus').classList.remove('active');
                    
                    this.checkPageOverflow();
                }
            },
            
            // 减时线功能
            enterBeamSelectionMode() {
                this.state.beamSelectionMode = true;
                this.state.beamSelectedNotes = [];
                
                document.getElementById('beamConnect').classList.add('active');
                document.getElementById('beamSeparate').classList.remove('active');
                document.getElementById('beamSelectionStatus').classList.add('active');
                
                this.updateBeamSelectionStatus();
                
                document.querySelectorAll('.note-group').forEach(note => {
                    const duration = note.dataset.duration;
                    if (duration === 'eighth' || duration === 'sixteenth') {
                        note.style.cursor = 'pointer';
                        note.style.opacity = '1';
                    } else {
                        note.style.opacity = '0.5';
                    }
                });
                
                alert('请点击要连接的八分或十六分音符，然后再次点击"连接减时线"完成连接');
            },
            
            exitBeamSelectionMode() {
                this.state.beamSelectionMode = false;
                this.state.beamSelectedNotes = [];
                
                document.getElementById('beamSelectionStatus').classList.remove('active');
                
                document.querySelectorAll('.note-group').forEach(note => {
                    note.style.cursor = 'pointer';
                    note.style.opacity = '1';
                    note.classList.remove('beam-selecting');
                });
            },
            
            handleBeamNoteSelection(noteElement) {
                const duration = noteElement.dataset.duration;
                
                if (duration !== 'eighth' && duration !== 'sixteenth') {
                    alert('只能选择八分或十六分音符');
                    return;
                }
                
                const index = this.state.beamSelectedNotes.indexOf(noteElement);
                
                if (index === -1) {
                    this.state.beamSelectedNotes.push(noteElement);
                    noteElement.classList.add('beam-selecting');
                } else {
                    this.state.beamSelectedNotes.splice(index, 1);
                    noteElement.classList.remove('beam-selecting');
                }
                
                this.updateBeamSelectionStatus();
            },
            
            updateBeamSelectionStatus() {
                document.getElementById('beamSelectionCount').textContent = this.state.beamSelectedNotes.length;
            },
            
            completeBeamConnection() {
                if (this.state.beamSelectedNotes.length < 2) {
                    alert('至少需要选择2个音符才能形成连音组');
                    return;
                }
                
                const activeLine = document.querySelector('.score-line.active');
                if (!activeLine) {
                    alert('请先选择一个行');
                    this.exitBeamSelectionMode();
                    return;
                }
                
                const cursor = activeLine.querySelector('.cursor');
                
                const groupContainer = document.createElement('div');
                groupContainer.className = 'beam-group';
                
                const notesContainer = document.createElement('div');
                notesContainer.className = 'note-groups';
                
                const noteDataArray = [];
                this.state.beamSelectedNotes.forEach(noteElement => {
                    const noteData = {
                        arrow: noteElement.dataset.arrow,
                        note: noteElement.dataset.note,
                        svg: noteElement.dataset.svg,
                        modifier: noteElement.dataset.modifier,
                        duration: noteElement.dataset.duration,
                        dotted: noteElement.dataset.dotted === 'true'
                    };
                    
                    const annotation = noteElement.querySelector('.note-annotation');
                    if (annotation) {
                        noteData.annotation = annotation.textContent;
                    }
                    
                    const box = noteElement.querySelector('.note-box');
                    if (box) {
                        noteData.box = box.textContent;
                    }
                    
                    noteDataArray.push(noteData);
                    noteElement.remove();
                });
                
                noteDataArray.forEach(noteData => {
                    const newNote = this.createNoteElementForBeam(noteData);
                    notesContainer.appendChild(newNote);
                });
                
                groupContainer.appendChild(notesContainer);
                
                const smartBeams = this.createSmartBeams(noteDataArray);
                groupContainer.appendChild(smartBeams);
                
                activeLine.insertBefore(groupContainer, cursor);
                
                this.exitBeamSelectionMode();
                this.checkPageOverflow();
            },
            
            createNoteElementForBeam(noteData) {
                const noteGroup = document.createElement('div');
                noteGroup.className = 'note-group';
                
                let noteHTML = '<div class="note-content">';
                
                // [处理修饰符的代码，与createNoteElement类似]
                
                noteHTML += `<span class="note-arrow"><svg class="arrow-svg large"><use href="#${noteData.svg}"/></svg></span>`;
                
                if (noteData.dotted) {
                    noteHTML += '<span class="note-dot">·</span>';
                }
                
                if (noteData.annotation) {
                    noteHTML += `<span class="note-annotation">${noteData.annotation}</span>`;
                }
                
                if (noteData.box) {
                    noteHTML += `<span class="note-box">${noteData.box}</span>`;
                }
                
                noteHTML += '</div>';
                
                noteGroup.innerHTML = noteHTML;
                noteGroup.style.cursor = 'pointer';
                const allChildren = noteGroup.querySelectorAll('*');
                allChildren.forEach(child => {
                    child.style.pointerEvents = 'none';
                });
                
                return noteGroup;
            },
            
            createSmartBeams(noteGroup) {
                const beamContainer = document.createElement('div');
                beamContainer.className = 'smart-beams';
                
                const hasEighthOrSixteenth = noteGroup.some(n => 
                    n.duration === 'eighth' || n.duration === 'sixteenth'
                );
                const sixteenthIndices = [];
                noteGroup.forEach((note, index) => {
                    if (note.duration === 'sixteenth') {
                        sixteenthIndices.push(index);
                    }
                });
                
                if (hasEighthOrSixteenth) {
                    const beam1 = document.createElement('div');
                    beam1.className = 'connected-beam first';
                    beamContainer.appendChild(beam1);
                }
                
                if (sixteenthIndices.length > 0) {
                    const groups = [];
                    let currentGroup = [];
                    
                    for (let i = 0; i < sixteenthIndices.length; i++) {
                        const index = sixteenthIndices[i];
                        
                        if (currentGroup.length === 0) {
                            currentGroup.push(index);
                        } else {
                            const lastIndex = currentGroup[currentGroup.length - 1];
                            if (index === lastIndex + 1) {
                                currentGroup.push(index);
                            } else {
                                if (currentGroup.length > 0) {
                                    groups.push(currentGroup);
                                }
                                currentGroup = [index];
                            }
                        }
                    }
                    
                    if (currentGroup.length > 0) {
                        groups.push(currentGroup);
                    }
                    
                    groups.forEach(group => {
                        const beam2 = document.createElement('div');
                        beam2.className = 'connected-beam second partial';
                        const noteWidth = 100 / noteGroup.length;
                        
                        if (group.length === 1) {
                            beam2.style.left = (group[0] * noteWidth) + '%';
                            beam2.style.width = noteWidth + '%';
                        } else {
                            const startPos = group[0] * noteWidth;
                            const endPos = (group[group.length - 1] + 1) * noteWidth;
                            beam2.style.left = startPos + '%';
                            beam2.style.width = (endPos - startPos) + '%';
                        }
                        
                        beamContainer.appendChild(beam2);
                    });
                }
                
                return beamContainer;
            },
            
            // 面板控制
            resizePanel(action) {
                const panel = document.getElementById('controlPanel');
                const currentWidth = panel.offsetWidth;
                
                if (action === 'smaller') {
                    this.state.panelScale = Math.max(0.7, this.state.panelScale - 0.1);
                    const newWidth = Math.max(200, currentWidth - 30);
                    panel.style.width = newWidth + 'px';
                    panel.style.fontSize = (14 * this.state.panelScale) + 'px';
                } else if (action === 'larger') {
                    this.state.panelScale = Math.min(1.3, this.state.panelScale + 0.1);
                    const newWidth = Math.min(500, currentWidth + 30);
                    panel.style.width = newWidth + 'px';
                    panel.style.fontSize = (14 * this.state.panelScale) + 'px';
                } else if (action === 'reset') {
                    this.state.panelScale = 1;
                    panel.style.width = '280px';
                    panel.style.fontSize = '14px';
                }
                
                this.adjustPanelElements(this.state.panelScale);
            },
            
            adjustPanelElements(scale) {
                const panel = document.getElementById('controlPanel');
                
                panel.querySelectorAll('.duration-btn, .modifier-btn, .other-btn').forEach(btn => {
                    btn.style.transform = `scale(${scale})`;
                    btn.style.transformOrigin = 'center';
                });
                
                panel.querySelectorAll('.arrow-btn').forEach(btn => {
                    btn.style.height = (50 * scale) + 'px';
                });
            },
            
            // 拖动分隔条
            initResizeHandle() {
                const resizeHandle = document.getElementById('resizeHandle');
                const controlPanel = document.querySelector('.control-panel');
                
                if (!resizeHandle) return;
                
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;
                
                resizeHandle.addEventListener('mousedown', initResize);
                resizeHandle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    initResize({clientX: touch.clientX});
                });
                
                function initResize(e) {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = controlPanel.offsetWidth;
                    
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                    document.addEventListener('touchmove', touchResize);
                    document.addEventListener('touchend', stopResize);
                    
                    document.body.style.userSelect = 'none';
                }
                
                function resize(e) {
                    if (!isResizing) return;
                    
                    const newWidth = startWidth + (e.clientX - startX);
                    if (newWidth > 150 && newWidth < window.innerWidth * 0.7) {
                        controlPanel.style.width = newWidth + 'px';
                    }
                }
                
                function touchResize(e) {
                    if (!isResizing) return;
                    const touch = e.touches[0];
                    resize({clientX: touch.clientX});
                }
                
                function stopResize() {
                    isResizing = false;
                    document.removeEventListener('mousemove', resize);
                    document.removeEventListener('mouseup', stopResize);
                    document.removeEventListener('touchmove', touchResize);
                    document.removeEventListener('touchend', stopResize);
                    document.body.style.userSelect = '';
                }
            },
            
            // 键盘快捷键
            initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT') return;
                    
                    const key = e.key;
                    const noteMap = {
                        '1': { arrow: 'up', note: '1', svg: 'arrow-up' },
                        '2': { arrow: 'right-up', note: '2', svg: 'arrow-right-up' },
                        '3': { arrow: 'right', note: '3', svg: 'arrow-right' },
                        '4': { arrow: 'right-down', note: '4', svg: 'arrow-right-down' },
                        '5': { arrow: 'down', note: '5', svg: 'arrow-down' },
                        '6': { arrow: 'left-down', note: '6', svg: 'arrow-left-down' },
                        '7': { arrow: 'left', note: '7', svg: 'arrow-left' },
                        '8': { arrow: 'left-up', note: "1'", svg: 'arrow-left-up' }
                    };
                    
                    if (noteMap[key]) {
                        this.state.lastNote = {
                            arrow: noteMap[key].arrow,
                            note: noteMap[key].note,
                            svg: noteMap[key].svg,
                            modifier: this.state.currentModifier
                        };
                        if (this.state.isTripletMode) {
                            this.insertTripletNote(noteMap[key].arrow, noteMap[key].note, noteMap[key].svg);
                        } else {
                            this.insertNote(noteMap[key].arrow, noteMap[key].note, noteMap[key].svg);
                        }
                    } else if (key === '0') {
                        this.insertRest();
                    } else if (key === ' ') {
                        e.preventDefault();
                        this.insertSpacer();
                    } else if (key === '|') {
                        this.insertBarline();
                    } else if (key === 'Delete' || key === 'Backspace') {
                        this.deleteLast();
                    } else if (key === 'Enter') {
                        this.newLine();
                    } else if (key === '=' || key === '+') {
                        this.insertTie();
                    } else if (key === 'ArrowLeft') {
                        e.preventDefault();
                        this.moveCursor('left');
                    } else if (key === 'ArrowRight') {
                        e.preventDefault();
                        this.moveCursor('right');
                    } else if (key === 'c' || key === 'C') {
                        e.preventDefault();
                        this.centerLine();
                    }
                });
            },
            
            // 保存/加载功能
            saveScore() {
                const data = {
                    title: document.getElementById('title').value,
                    scoreInfo: document.getElementById('scoreInfo').value,
                    tempo: document.getElementById('tempo').value,
                    fontSize: this.state.fontSize,
                    pages: [],
                    tieLines: this.tieManager.getDataForSave()
                };
                
                document.querySelectorAll('.score-page').forEach(page => {
                    const pageData = {
                        pageNumber: page.dataset.page,
                        lines: []
                    };
                    
                    page.querySelectorAll('.score-line').forEach(line => {
                        const lineData = {
                            marginTop: line.style.marginTop || '0',
                            marginBottom: line.style.marginBottom || '20px',
                            isCentered: line.classList.contains('centered'),
                            gap: line.style.gap || '',
                            elements: []
                        };
                        
                        line.childNodes.forEach(element => {
                            if (element.classList && !element.classList.contains('cursor') && !element.classList.contains('tie-line-svg')) {
                                lineData.elements.push({
                                    html: element.outerHTML
                                });
                            }
                        });
                        
                        if (lineData.elements.length > 0) {
                            pageData.lines.push(lineData);
                        }
                    });
                    
                    if (pageData.lines.length > 0) {
                        data.pages.push(pageData);
                    }
                });
                
                localStorage.setItem('arrowScore', JSON.stringify(data));
                alert('保存成功！');
            },
            
            loadScore() {
                const saved = localStorage.getItem('arrowScore');
                if (!saved) {
                    alert('没有保存的乐谱');
                    return;
                }
                
                const data = JSON.parse(saved);
                document.getElementById('title').value = data.title;
                document.getElementById('scoreInfo').value = data.scoreInfo || '';
                document.getElementById('tempo').value = data.tempo;
                if (data.fontSize) {
                    this.updateFontSize(data.fontSize);
                    document.getElementById('fontSize').value = data.fontSize;
                }
                this.updateTitle();
                
                const container = document.getElementById('scoreContainer');
                container.innerHTML = '';
                
                data.pages.forEach((pageData, pageIndex) => {
                    const pageHtml = `
                        <div class="score-page" id="page-${pageIndex + 1}" data-page="${pageIndex + 1}">
                            ${pageIndex === 0 ? `
                                <h1 class="score-title" id="scoreTitle">${data.title || '未命名乐谱'}</h1>
                                <div class="score-info">
                                    <input type="text" id="scoreInfo" placeholder="调号：C大调  拍号：4/4  速度：Andante" value="${data.scoreInfo || ''}" />
                                </div>
                            ` : ''}
                            <div class="score-content">
                                <div id="scoreLines"></div>
                            </div>
                            <div class="page-indicator">第 ${pageIndex + 1} 页</div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', pageHtml);
                    
                    const pageElement = document.getElementById(`page-${pageIndex + 1}`);
                    const scoreLines = pageElement.querySelector('#scoreLines');
                    
                    pageData.lines.forEach((lineData, lineIndex) => {
                        const lineDiv = document.createElement('div');
                        lineDiv.className = 'score-line' + (pageIndex === 0 && lineIndex === 0 ? ' active' : '');
                        if (lineData.isCentered) {
                            lineDiv.classList.add('centered');
                        }
                        lineDiv.dataset.line = lineIndex + 1;
                        lineDiv.dataset.page = pageIndex + 1;
                        lineDiv.style.marginTop = lineData.marginTop || '0';
                        lineDiv.style.marginBottom = lineData.marginBottom || '20px';
                        if (lineData.gap) {
                            lineDiv.style.gap = lineData.gap;
                        }
                        
                        lineData.elements.forEach(item => {
                            const temp = document.createElement('div');
                            temp.innerHTML = item.html;
                            lineDiv.appendChild(temp.firstChild);
                        });
                        
                        const cursor = document.createElement('div');
                        cursor.className = 'cursor';
                        if (!(pageIndex === 0 && lineIndex === 0)) {
                            cursor.classList.add('hidden');
                        }
                        lineDiv.appendChild(cursor);
                        
                        lineDiv.addEventListener('click', function(e) {
                            e.stopPropagation();
                            document.querySelectorAll('.score-line').forEach(l => {
                                l.classList.remove('active');
                                const cursor = l.querySelector('.cursor');
                                if (cursor) cursor.classList.add('hidden');
                            });
                            this.classList.add('active');
                            const cursor = this.querySelector('.cursor');
                            if (cursor) cursor.classList.remove('hidden');
                        });
                        
                        scoreLines.appendChild(lineDiv);
                    });
                });
                
                this.state.currentPage = data.pages.length || 1;
                this.state.currentLine = document.querySelectorAll('.score-line').length;
                this.updateLineSelector();
                
                // 恢复连音线
                this.tieManager.restoreFromData(data.tieLines);
                
                alert('加载成功！');
            },
            
            exportScore() {
                this.saveScore();
                const data = localStorage.getItem('arrowScore');
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (document.getElementById('title').value || '未命名乐谱') + '.json';
                a.click();
            },
            
            printScore() {
                window.print();
            }
        };
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
